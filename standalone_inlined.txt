<!doctype html> <html> <head> <meta charset="UTF-8"> <title>__GAMETITLE__</title> <style>body{ background-color:black;font-family:"Courier New", Courier, monospace }#gameCanvas{ position:absolute;top:0px;left:0px;width:100%;height:100%;bottom:0px;right:0px;border:0px;background-color:black;-webkit-tap-highlight-color:rgba(0,0,0,0);image-rendering:-moz-crisp-edges;image-rendering:-webkit-crisp-edges;image-rendering:pixelated;image-rendering:crisp-edges;}h1{ color:lightblue;font-weight:normal;}a{ color:lightblue;}.title{ background-color:none;text-align:center;font-size:100%;float:center;color:gray;position:absolute;left:10%;right:10%;top:0%;height:10%;}.footer{ background-color:none;text-align:center;float:center;color:white;position:absolute;margin-top:10px;left:10%;right:10%;top:90%;bottom:10%;}.gameContainer{ background-color:none;position:absolute;left:10%;right:10%;top:70px;bottom:70px;touch-action:none;}.mobile-menu{ position:relative;top:4em;margin-left:auto;margin-right:auto;font-weight:bold;border-radius:0.25em;}.mobile-menu.item-count-3{ width:30em;}.mobile-menu.item-count-3 .button{ width:28.3333%; padding:7.5% 0%;}.mobile-menu.item-count-2{ width:20em;}.mobile-menu.item-count-2 .button{ width:46%; padding:12.1765% 0%;}.mobile-menu.item-count-1{ width:10em;}.mobile-menu.item-count-1 .button{ width:98%; padding:26.5% 0%;}.mobile-menu, .tab-icon, .mobile-menu .close{ background:rgba(0,0,0,0.4);border:2px solid rgba(255, 255, 255, 0.4);color:rgba(255, 255, 255, 1);}.mobile-menu .button{ margin:2%;border-radius:0.25em;text-align:center;float:left;}.mobile-menu .clear{ clear:both;}.tab-affordance, .close-affordance{ width:6em;height:6em;position:absolute;z-index:1000;}.tab-affordance{ left:-2em;top:55px;}.close-affordance{ left:-4em;top:-1em;}.tab-icon, .mobile-menu .close{ height:48px;position:absolute;border-radius:6px;}.tab-icon{ left:-0.5em;top:70px;width:18px;border-radius:0 6px 6px 0;border-left:0;}.mobile-menu .close{ left:-18px;width:18px;top:0px;border-radius:6px 0 0 6px;border-right:0;}.tab-icon .slice, .mobile-menu .close .slice{ margin:4.5px 1px;width:2px;height:80%;background:rgba(255, 255, 255, 0.4);}.tab-icon .slice{ float:right;}.tab-icon .slice:first-child{ margin-right:4.5px;}.mobile-menu .close .slice{ float:left;}.mobile-menu .close .slice:first-child{ margin-left:4.5px;}@media screen and (max-width:32em){ .mobile-menu{ font-size:0.8em;width:90%;}}@media screen and (max-width:24em){ .mobile-menu{ font-size:0.65em;width:90%;}}.disable-select{ -webkit-touch-callout:none;-webkit-user-select:none;-khtml-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;}</style> <style> .gameContainer{ left:0;right:0;top:0;bottom:0;}</style> </head> <body> <div class="gameContainer"> <canvas id="gameCanvas"></canvas> </div> <script>function doSetupTitleScreenLevelContinue(){try{if(window.localStorage&&void 0!==localStorage[document.URL]){if(void 0!==localStorage[document.URL+"_checkpoint"]){var e=localStorage[document.URL+"_checkpoint"];curlevelTarget=JSON.parse(e);var t=[];for(var n in Object.keys(curlevelTarget.dat))t[n]=curlevelTarget.dat[n];curlevelTarget.dat=new Int32Array(t)}curlevel=localStorage[document.URL],void 0!==localStorage[document.URL+"_sections"]&&(solvedSections=JSON.parse(localStorage.getItem(document.URL+"_sections")))}}catch(e){}}var unitTesting=!1,curlevel=0,solvedSections=[],curlevelTarget=null,hasUsedCheckpoint=!1,levelEditorOpened=!1,muted=0;doSetupTitleScreenLevelContinue();var verbose_logging=!1,throttle_movement=!1,cache_console_messages=!1,quittingTitleScreen=!1,quittingMessageScreen=!1,deltatime=17,timer=0,repeatinterval=150,autotick=0,autotickinterval=0,winning=!1,againing=!1,againinterval=150,norepeat_action=!1,oldflickscreendat=[],keybuffer=[],restarting=!1,messageselected=!1,textImages={},initLevel={width:5,height:5,layerCount:2,dat:[1,3,3,1,1,2,2,3,3,1,2,1,2,2,3,3,1,1,2,2,3,2,1,3,2,1,3,2,1,3,1,3,3,1,1,2,2,3,3,1,2,1,2,2,3,3,1,1,2,2],movementMask:[1,3,3,1,1,2,2,3,3,1,2,1,2,2,3,3,1,1,2,2,3,2,1,3,2,1,3,2,1,3,1,3,3,1,1,2,2,3,3,1,2,1,2,2,3,3,1,1,2,2],rigidGroupIndexMask:[],rigidMovementAppliedMask:[],bannedGroup:[],colCellContents:[],rowCellContents:[]},level=initLevel;</script> <script>function stripTags(n){var e=document.createElement("div");return e.innerHTML=n,e.textContent||e.innerText||""}function consolePrint(n,e){}function consolePrintFromRule(n,e,r){}function consoleCacheDump(n){}function consoleError(n,e){var r=document.getElementById("errormessage");n=stripTags(n),r.innerHTML+=n+"<br>"}function logErrorNoLine(n){var e=document.getElementById("errormessage");n=stripTags(n),e.innerHTML+=n+"<br>"}function logBetaMessage(n){var e=document.getElementById("errormessage");n=stripTags(n),e.innerHTML+=n+"<br>"}function clearInputHistory(){}function pushInput(n){}var canSetHTMLColors=!0,canDump=!1,canOpenEditor=!1,canYoutube=!0,IDE=!1;solving=!1;</script> <script>var font={a:[[0,0,0,0,0],[0,1,1,1,0],[1,0,0,1,0],[1,0,0,1,0],[0,1,1,1,0]],b:[[1,0,0,0,0],[1,0,0,0,0],[1,1,1,0,0],[1,0,0,1,0],[0,1,1,0,0]],c:[[0,0,0,0,0],[0,1,1,1,0],[1,0,0,0,0],[1,0,0,0,0],[0,1,1,1,0]],d:[[0,0,0,1,0],[0,0,0,1,0],[0,1,1,1,0],[1,0,0,1,0],[0,1,1,0,0]],e:[[0,1,1,0,0],[1,0,0,1,0],[1,1,1,0,0],[1,0,0,0,0],[0,1,1,0,0]],f:[[0,0,0,0,0],[0,0,1,1,0],[0,1,0,0,0],[1,1,1,0,0],[0,1,0,0,0]],g:[[0,1,1,0,0],[1,0,0,1,0],[0,1,1,1,0],[0,0,0,1,0],[0,1,1,0,0]],h:[[1,0,0,0,0],[1,0,0,0,0],[1,1,1,0,0],[1,0,0,1,0],[1,0,0,1,0]],i:[[0,0,1,0,0],[0,0,0,0,0],[0,1,1,0,0],[0,0,1,0,0],[0,1,1,1,0]],j:[[0,0,1,0,0],[0,0,0,0,0],[0,0,1,0,0],[1,0,1,0,0],[0,1,0,0,0]],k:[[1,0,0,0,0],[1,0,0,1,0],[1,1,1,0,0],[1,0,0,1,0],[1,0,0,1,0]],l:[[1,0,0,0,0],[1,0,0,0,0],[1,0,0,0,0],[1,0,0,1,0],[0,1,1,0,0]],m:[[0,0,0,0,0],[0,1,0,1,0],[1,0,1,0,1],[1,0,1,0,1],[1,0,1,0,1]],n:[[0,0,0,0,0],[0,1,1,0,0],[1,0,0,1,0],[1,0,0,1,0],[1,0,0,1,0]],o:[[0,0,0,0,0],[0,1,1,0,0],[1,0,0,1,0],[1,0,0,1,0],[0,1,1,0,0]],p:[[0,0,0,0,0],[0,1,1,0,0],[1,0,0,1,0],[1,1,1,0,0],[1,0,0,0,0]],q:[[0,0,0,0,0],[0,1,1,0,0],[1,0,0,1,0],[0,1,1,1,0],[0,0,0,1,0]],r:[[0,0,0,0,0],[0,1,1,1,0],[1,0,0,0,0],[1,0,0,0,0],[1,0,0,0,0]],s:[[0,1,1,1,0],[1,0,0,0,0],[0,1,1,0,0],[0,0,0,1,0],[1,1,1,0,0]],t:[[0,1,0,0,0],[1,1,1,0,0],[0,1,0,0,0],[0,1,0,0,1],[0,0,1,1,0]],u:[[0,0,0,0,0],[1,0,0,1,0],[1,0,0,1,0],[1,0,0,1,0],[1,1,1,0,0]],v:[[0,0,0,0,0],[1,0,0,1,0],[1,0,1,0,0],[1,1,0,0,0],[1,0,0,0,0]],w:[[0,0,0,0,0],[1,0,1,0,1],[1,0,1,0,1],[1,0,1,0,1],[0,1,0,1,0]],x:[[0,0,0,0,0],[1,0,0,1,0],[0,1,1,0,0],[0,1,1,0,0],[1,0,0,1,0]],y:[[1,0,0,1,0],[1,0,0,1,0],[0,1,1,1,0],[0,0,0,1,0],[1,1,1,0,0]],z:[[0,0,0,0,0],[1,1,1,1,0],[0,0,1,0,0],[0,1,0,0,0],[1,1,1,1,0]],A:[[1,1,1,1,1],[1,0,0,0,1],[1,1,1,1,1],[1,0,0,0,1],[1,0,0,0,1]],B:[[1,1,1,1,0],[1,0,0,0,1],[1,1,1,1,0],[1,0,0,0,1],[1,1,1,1,0]],C:[[1,1,1,1,1],[1,0,0,0,0],[1,0,0,0,0],[1,0,0,0,0],[1,1,1,1,1]],D:[[1,1,1,1,0],[1,0,0,0,1],[1,0,0,0,1],[1,0,0,0,1],[1,1,1,1,0]],E:[[1,1,1,1,1],[1,0,0,0,0],[1,1,1,1,1],[1,0,0,0,0],[1,1,1,1,1]],F:[[1,1,1,1,1],[1,0,0,0,0],[1,1,1,1,1],[1,0,0,0,0],[1,0,0,0,0]],G:[[0,1,1,1,1],[1,0,0,0,0],[1,0,0,1,1],[1,0,0,0,1],[0,1,1,1,1]],H:[[1,0,0,0,1],[1,0,0,0,1],[1,1,1,1,1],[1,0,0,0,1],[1,0,0,0,1]],I:[[1,1,1,1,1],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[1,1,1,1,1]],J:[[1,1,1,1,1],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[1,1,1,0,0]],K:[[1,0,0,0,1],[1,0,1,1,0],[1,1,0,0,0],[1,0,1,1,0],[1,0,0,0,1]],L:[[1,0,0,0,0],[1,0,0,0,0],[1,0,0,0,0],[1,0,0,0,0],[1,1,1,1,1]],M:[[1,1,1,1,1],[1,0,1,0,1],[1,0,1,0,1],[1,0,1,0,1],[1,0,1,0,1]],N:[[1,0,0,0,1],[1,1,0,0,1],[1,0,1,0,1],[1,0,0,1,1],[1,0,0,0,1]],O:[[1,1,1,1,1],[1,0,0,0,1],[1,0,0,0,1],[1,0,0,0,1],[1,1,1,1,1]],P:[[1,1,1,1,1],[1,0,0,0,1],[1,1,1,1,1],[1,0,0,0,0],[1,0,0,0,0]],Q:[[1,1,1,1,1],[1,0,0,0,1],[1,1,1,1,1],[0,0,0,0,1],[0,0,0,0,1]],R:[[1,1,1,1,0],[1,0,0,0,1],[1,1,1,1,0],[1,0,0,0,1],[1,0,0,0,1]],S:[[0,1,1,1,1],[1,0,0,0,0],[0,1,1,1,0],[0,0,0,0,1],[1,1,1,1,0]],T:[[1,1,1,1,1],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0]],U:[[1,0,0,0,1],[1,0,0,0,1],[1,0,0,0,1],[1,0,0,0,1],[1,1,1,1,1]],V:[[1,0,0,0,1],[0,1,0,1,0],[0,1,0,1,0],[0,0,1,0,0],[0,0,1,0,0]],W:[[1,0,1,0,1],[1,0,1,0,1],[1,0,1,0,1],[1,0,1,0,1],[0,1,0,1,0]],X:[[1,0,0,0,1],[0,1,0,1,0],[0,0,1,0,0],[0,1,0,1,0],[1,0,0,0,1]],Y:[[1,0,0,0,1],[1,0,0,0,1],[1,1,1,1,1],[0,0,1,0,0],[0,0,1,0,0]],Z:[[1,1,1,1,1],[0,0,0,1,0],[0,0,1,0,0],[0,1,0,0,0],[1,1,1,1,1]],0:[[1,1,1,1,1],[1,0,0,1,1],[1,0,1,0,1],[1,1,0,0,1],[1,1,1,1,1]],1:[[1,1,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[1,1,1,1,1]],2:[[1,1,1,1,1],[0,0,0,0,1],[1,1,1,1,1],[1,0,0,0,0],[1,1,1,1,1]],3:[[1,1,1,1,0],[0,0,0,0,1],[0,0,1,1,0],[0,0,0,0,1],[1,1,1,1,0]],4:[[1,0,0,0,0],[1,0,0,0,0],[1,0,0,1,0],[1,1,1,1,1],[0,0,0,1,0]],5:[[1,1,1,1,1],[1,0,0,0,0],[1,1,1,1,0],[0,0,0,0,1],[1,1,1,1,0]],6:[[0,1,1,1,0],[1,0,0,0,0],[1,1,1,1,0],[1,0,0,0,1],[0,1,1,1,0]],7:[[1,1,1,1,1],[0,0,0,0,1],[0,0,0,1,0],[0,0,1,0,0],[0,1,0,0,0]],8:[[0,1,1,1,0],[1,0,0,0,1],[0,1,1,1,0],[1,0,0,0,1],[0,1,1,1,0]],9:[[0,1,1,1,0],[1,0,0,0,1],[0,1,1,1,1],[0,0,0,0,1],[0,1,1,1,0]],".":[[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,1,0,0]],",":[[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,1,0,0],[0,1,1,0,0]],";":[[0,0,0,0,0],[0,0,1,0,0],[0,0,0,0,0],[0,0,1,0,0],[0,1,1,0,0]],":":[[0,0,0,0,0],[0,0,1,0,0],[0,0,0,0,0],[0,0,1,0,0],[0,0,0,0,0]],"?":[[0,1,1,1,0],[1,0,0,0,1],[0,0,1,1,0],[0,0,1,0,0],[0,0,1,0,0]],"!":[[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,0,0,0],[0,0,1,0,0]],"@":[[0,1,1,1,0],[1,0,0,0,1],[1,0,1,1,1],[1,0,0,0,0],[0,1,1,1,0]],"£":[[0,1,1,1,0],[0,1,0,0,1],[1,1,1,0,0],[0,1,0,0,0],[1,1,1,1,1]],$:[[0,1,1,1,1],[1,0,1,0,0],[0,1,1,1,0],[0,0,1,0,1],[1,1,1,1,0]],"%":[[1,1,0,0,1],[1,1,0,1,0],[0,0,1,0,0],[0,1,0,1,1],[1,0,0,1,1]],"^":[[0,0,1,0,0],[0,1,0,1,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0]],"&":[[0,1,1,0,0],[1,0,0,0,0],[0,1,0,1,1],[1,0,0,1,0],[0,1,1,0,0]],"*":[[0,1,0,1,0],[0,0,1,0,0],[0,1,0,1,0],[0,0,0,0,0],[0,0,0,0,0]],"(":[[0,0,0,1,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,0,1,0]],")":[[0,1,0,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,1,0,0,0]],"+":[[0,0,1,0,0],[0,0,1,0,0],[1,1,1,1,1],[0,0,1,0,0],[0,0,1,0,0]],"-":[[0,0,0,0,0],[0,0,0,0,0],[0,1,1,1,0],[0,0,0,0,0],[0,0,0,0,0]],_:[[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[1,1,1,1,1]],"=":[[0,0,0,0,0],[1,1,1,1,1],[0,0,0,0,0],[1,1,1,1,1],[0,0,0,0,0]]," ":[[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0]],"{":[[0,0,1,1,0],[0,0,1,0,0],[0,1,1,0,0],[0,0,1,0,0],[0,0,1,1,0]],"}":[[0,1,1,0,0],[0,0,1,0,0],[0,0,1,1,0],[0,0,1,0,0],[0,1,1,0,0]],"[":[[0,0,1,1,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,1,0]],"]":[[0,1,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,1,1,0,0]],"'":[[0,0,1,0,0],[0,0,1,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0]],'"':[[0,1,0,1,0],[0,1,0,1,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0]],"/":[[0,0,0,0,1],[0,0,0,1,0],[0,0,1,0,0],[0,1,0,0,0],[1,0,0,0,0]],"\\":[[1,0,0,0,0],[0,1,0,0,0],[0,0,1,0,0],[0,0,0,1,0],[0,0,0,0,1]],"|":[[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0]],"<":[[0,0,0,1,0],[0,0,1,0,0],[0,1,0,0,0],[0,0,1,0,0],[0,0,0,1,0]],">":[[0,1,0,0,0],[0,0,1,0,0],[0,0,0,1,0],[0,0,1,0,0],[0,1,0,0,0]],"~":[[0,0,0,0,0],[0,1,0,0,0],[1,0,1,0,1],[0,0,0,1,0],[0,0,0,0,0]],"`":[[0,1,0,0,0],[0,0,1,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0]],"#":[[0,1,0,1,0],[1,1,1,1,1],[0,1,0,1,0],[1,1,1,1,1],[0,1,0,1,0]],"✓":[[0,0,0,0,0],[0,0,0,0,1],[0,0,0,1,0],[1,0,1,0,0],[0,1,0,0,0]]};</script> <script>function RC4(t){this.s=new Array(256),this.i=0,this.j=0;for(var n=0;n<256;n++)this.s[n]=n;t&&this.mix(t)}function print_call_stack(){var t=new Error,n=t.stack;console.log(n)}function RNG(t){this.seed=t,null==t?t=(Math.random()+Date.now()).toString():"function"==typeof t?(this.uniform=t,this.nextByte=function(){return~~(256*this.uniform())},t=null):"[object String]"!==Object.prototype.toString.call(t)&&(t=JSON.stringify(t)),this._normal=null,this._state=t?new RC4(t):null}String.prototype.getBytes=function(){for(var t=[],n=0;n<this.length;n++){var i=this.charCodeAt(n),o=[];do{o.push(255&i),i>>=8}while(i>0);t=t.concat(o.reverse())}return t},RC4.prototype._swap=function(t,n){var i=this.s[t];this.s[t]=this.s[n],this.s[n]=i},RC4.prototype.mix=function(t){for(var n=t.getBytes(),i=0,o=0;o<this.s.length;o++)i+=this.s[o]+n[o%n.length],i%=256,this._swap(o,i)},RC4.prototype.next=function(){return this.i=(this.i+1)%256,this.j=(this.j+this.s[this.i])%256,this._swap(this.i,this.j),this.s[(this.s[this.i]+this.s[this.j])%256]},RNG.prototype.nextByte=function(){return this._state.next()},RNG.prototype.uniform=function(){for(var t=0,n=0;n<7;n++)t*=256,t+=this.nextByte();return t/(Math.pow(2,56)-1)},RNG.prototype.random=function(t,n){return null==t?this.uniform():(null==n&&(n=t,t=0),t+Math.floor(this.uniform()*(n-t)))},RNG.prototype.normal=function(){if(null!==this._normal){var t=this._normal;return this._normal=null,t}var n=this.uniform()||Math.pow(2,-53),i=this.uniform();return this._normal=Math.sqrt(-2*Math.log(n))*Math.sin(2*Math.PI*i),Math.sqrt(-2*Math.log(n))*Math.cos(2*Math.PI*i)},RNG.prototype.exponential=function(){return-Math.log(this.uniform()||Math.pow(2,-53))},RNG.prototype.poisson=function(t){var n=Math.exp(-(t||1)),i=0,o=1;do{i++,o*=this.uniform()}while(o>n);return i-1},RNG.prototype.gamma=function(t){var n=(t<1?1+t:t)-1/3,i=1/Math.sqrt(9*n);do{do{var o=this.normal(),r=Math.pow(i*o+1,3)}while(r<=0);var s=this.uniform(),h=Math.pow(o,2)}while(s>=1-.0331*h*h&&Math.log(s)>=.5*h+n*(1-r+Math.log(r)));return t<1?n*r*Math.exp(this.exponential()/-t):n*r},RNG.roller=function(t,n){var i=t.split(/(\d+)?d(\d+)([+-]\d+)?/).slice(1),o=parseFloat(i[0])||1,r=parseFloat(i[1]),s=parseFloat(i[2])||0;return n=n||new RNG,function(){for(var t=o+s,i=0;i<o;i++)t+=n.random(r);return t}};</script> <script>function FastBase64_Init(){for(var a=0;a<4096;a++)FastBase64_encLookup[a]=FastBase64_chars[a>>6]+FastBase64_chars[63&a]}function FastBase64_Encode(a){for(var e=a.length,s="",u=0;e>2;)n=a[u]<<16|a[u+1]<<8|a[u+2],s+=FastBase64_encLookup[n>>12]+FastBase64_encLookup[4095&n],e-=3,u+=3;if(e>0){var r=(252&a[u])>>2,t=(3&a[u])<<4;if(e>1&&(t|=(240&a[++u])>>4),s+=FastBase64_chars[r],s+=FastBase64_chars[t],2==e){var o=(15&a[u++])<<2;o|=(192&a[u])>>6,s+=FastBase64_chars[o]}1==e&&(s+="="),s+="="}return s}function u32ToArray(a){return[255&a,a>>8&255,a>>16&255,a>>24&255]}function u16ToArray(a){return[255&a,a>>8&255]}function MakeRiff(a,e,n){var s=[],u=[],r=[],t={chunkId:[82,73,70,70],chunkSize:0,format:[87,65,86,69],subChunk1Id:[102,109,116,32],subChunk1Size:16,audioFormat:1,numChannels:1,sampleRate:a,byteRate:0,blockAlign:0,bitsPerSample:e,subChunk2Id:[100,97,116,97],subChunk2Size:0};return t.byteRate=t.sampleRate*t.numChannels*t.bitsPerSample>>3,t.blockAlign=t.numChannels*t.bitsPerSample>>3,t.subChunk2Size=n.length,t.chunkSize=36+t.subChunk2Size,u=t.chunkId.concat(u32ToArray(t.chunkSize),t.format,t.subChunk1Id,u32ToArray(t.subChunk1Size),u16ToArray(t.audioFormat),u16ToArray(t.numChannels),u32ToArray(t.sampleRate),u32ToArray(t.byteRate),u16ToArray(t.blockAlign),u16ToArray(t.bitsPerSample),t.subChunk2Id,u32ToArray(t.subChunk2Size),n),r="data:audio/wav;base64,"+FastBase64_Encode(u),{dat:s,wav:u,header:t,dataURI:r}}var FastBase64_chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",FastBase64_encLookup=[];FastBase64_Init(),"undefined"!=typeof exports&&(exports.RIFFWAVE=RIFFWAVE);</script> <script>function checkAudioContextExists(){try{null==AUDIO_CONTEXT&&("undefined"!=typeof AudioContext?AUDIO_CONTEXT=new AudioContext:"undefined"!=typeof webkitAudioContext&&(AUDIO_CONTEXT=new webkitAudioContext))}catch(e){window.console.log(e)}}function Params(){var e={};return e.wave_type=SQUARE,e.p_env_attack=0,e.p_env_sustain=.3,e.p_env_punch=0,e.p_env_decay=.4,e.p_base_freq=.3,e.p_freq_limit=0,e.p_freq_ramp=0,e.p_freq_dramp=0,e.p_vib_strength=0,e.p_vib_speed=0,e.p_arp_mod=0,e.p_arp_speed=0,e.p_duty=0,e.p_duty_ramp=0,e.p_repeat_speed=0,e.p_pha_offset=0,e.p_pha_ramp=0,e.p_lpf_freq=1,e.p_lpf_ramp=0,e.p_lpf_resonance=0,e.p_hpf_freq=0,e.p_hpf_ramp=0,e.sound_vol=.5,e.sample_rate=44100,e.bit_depth=8,e}function frnd(e){return seeded?rng.uniform()*e:Math.random()*e}function rnd(e){return seeded?Math.floor(rng.uniform()*(e+1)):Math.floor(Math.random()*(e+1))}function SoundEffect(e,r){this._buffer=AUDIO_CONTEXT.createBuffer(1,e,r)}function ULBS(){if("suspended"===AUDIO_CONTEXT.state){var e=function(){AUDIO_CONTEXT.resume().then(function(){document.body.removeEventListener("touchstart",e),document.body.removeEventListener("touchend",e),document.body.removeEventListener("mousedown",e),document.body.removeEventListener("mouseup",e),document.body.removeEventListener("keydown",e),document.body.removeEventListener("keyup",e)})};document.body.addEventListener("touchstart",e,!1),document.body.addEventListener("touchend",e,!1),document.body.addEventListener("mousedown",e,!1),document.body.addEventListener("mouseup",e,!1),document.body.addEventListener("keydown",e,!1),document.body.addEventListener("keyup",e,!1)}}function cacheSeed(e){if(e in sfxCache)return sfxCache[e];var r=generateFromSeed(e);r.sound_vol=SOUND_VOL,r.sample_rate=SAMPLE_RATE,r.bit_depth=BIT_DEPTH;var _=SoundEffect.generate(r);for(sfxCache[e]=_,cachedSeeds.push(e);cachedSeeds.length>CACHE_MAX;){var p=cachedSeeds[0];cachedSeeds=cachedSeeds.slice(1),delete sfxCache[p]}return _}function playSound(e){if(!muted&&(checkAudioContextExists(),!unitTesting)){cacheSeed(e).play()}}function killAudioButton(){var e=document.getElementById("muteButton"),r=document.getElementById("unMuteButton");e&&(e.remove(),r.remove())}function showAudioButton(){var e=document.getElementById("muteButton"),r=document.getElementById("unMuteButton");e&&(e.style.display="block",r.style.display="none")}function toggleMute(){0===muted?muteAudio():unMuteAudio()}function muteAudio(){muted=1,tryDeactivateYoutube();var e=document.getElementById("muteButton"),r=document.getElementById("unMuteButton");e&&(e.style.display="none",r.style.display="block")}function unMuteAudio(){muted=0,tryActivateYoutube();var e=document.getElementById("muteButton"),r=document.getElementById("unMuteButton");e&&(e.style.display="block",r.style.display="none")}var SOUND_VOL=.25,SAMPLE_RATE=5512,BIT_DEPTH=8,SQUARE=0,SAWTOOTH=1,SINE=2,NOISE=3,TRIANGLE=4,BREAKER=5,SHAPES=["square","sawtooth","sine","noise","triangle","breaker"],AUDIO_CONTEXT;checkAudioContextExists();var masterVolume=1,rng,seeded=!1;pickupCoin=function(){var e=Params();if(e.wave_type=Math.floor(frnd(SHAPES.length)),3===e.wave_type&&(e.wave_type=0),e.p_base_freq=.4+frnd(.5),e.p_env_attack=0,e.p_env_sustain=frnd(.1),e.p_env_decay=.1+frnd(.4),e.p_env_punch=.3+frnd(.3),rnd(1)){e.p_arp_speed=.5+frnd(.2);var r=1+(1|frnd(7)),_=r+(1|frnd(7))+2;e.p_arp_mod=+r/+_}return e},laserShoot=function(){var e=Params();return e.wave_type=rnd(2),e.wave_type===SINE&&rnd(1)&&(e.wave_type=rnd(1)),e.wave_type=Math.floor(frnd(SHAPES.length)),3===e.wave_type&&(e.wave_type=SQUARE),e.p_base_freq=.5+frnd(.5),e.p_freq_limit=e.p_base_freq-.2-frnd(.6),e.p_freq_limit<.2&&(e.p_freq_limit=.2),e.p_freq_ramp=-.15-frnd(.2),0===rnd(2)&&(e.p_base_freq=.3+frnd(.6),e.p_freq_limit=frnd(.1),e.p_freq_ramp=-.35-frnd(.3)),rnd(1)?(e.p_duty=frnd(.5),e.p_duty_ramp=frnd(.2)):(e.p_duty=.4+frnd(.5),e.p_duty_ramp=-frnd(.7)),e.p_env_attack=0,e.p_env_sustain=.1+frnd(.2),e.p_env_decay=frnd(.4),rnd(1)&&(e.p_env_punch=frnd(.3)),0===rnd(2)&&(e.p_pha_offset=frnd(.2),e.p_pha_ramp=-frnd(.2)),rnd(1)&&(e.p_hpf_freq=frnd(.3)),e},explosion=function(){var e=Params();return rnd(1)?(e.p_base_freq=.1+frnd(.4),e.p_freq_ramp=-.1+frnd(.4)):(e.p_base_freq=.2+frnd(.7),e.p_freq_ramp=-.2-frnd(.2)),e.p_base_freq*=e.p_base_freq,0===rnd(4)&&(e.p_freq_ramp=0),0===rnd(2)&&(e.p_repeat_speed=.3+frnd(.5)),e.p_env_attack=0,e.p_env_sustain=.1+frnd(.3),e.p_env_decay=frnd(.5),0===rnd(1)&&(e.p_pha_offset=-.3+frnd(.9),e.p_pha_ramp=-frnd(.3)),e.p_env_punch=.2+frnd(.6),rnd(1)&&(e.p_vib_strength=frnd(.7),e.p_vib_speed=frnd(.6)),0===rnd(2)&&(e.p_arp_speed=.6+frnd(.3),e.p_arp_mod=.8-frnd(1.6)),e},birdSound=function(){var e=Params();return frnd(10)<1?(e.wave_type=Math.floor(frnd(SHAPES.length)),3===e.wave_type&&(e.wave_type=SQUARE),e.p_env_attack=.4304400932967592+frnd(.2)-.1,e.p_env_sustain=.15739346034252394+frnd(.2)-.1,e.p_env_punch=.004488201744871758+frnd(.2)-.1,e.p_env_decay=.07478075528212291+frnd(.2)-.1,e.p_base_freq=.9865265720147687+frnd(.2)-.1,e.p_freq_limit=0+frnd(.2)-.1,e.p_freq_ramp=-.2995018224359539+frnd(.2)-.1,frnd(1)<.5&&(e.p_freq_ramp=.1+frnd(.15)),e.p_freq_dramp=.004598608156964473+frnd(.1)-.05,e.p_vib_strength=-.2202799497929496+frnd(.2)-.1,e.p_vib_speed=.8084998703158364+frnd(.2)-.1,e.p_arp_mod=0,e.p_arp_speed=0,e.p_duty=-.9031808754347107+frnd(.2)-.1,e.p_duty_ramp=-.8128699999808343+frnd(.2)-.1,e.p_repeat_speed=.601486018931999+frnd(.2)-.1,e.p_pha_offset=-.9424902314367765+frnd(.2)-.1,e.p_pha_ramp=-.1055482222272056+frnd(.2)-.1,e.p_lpf_freq=.9989765717851521+frnd(.2)-.1,e.p_lpf_ramp=-.25051720626043017+frnd(.2)-.1,e.p_lpf_resonance=.32777871505494693+frnd(.2)-.1,e.p_hpf_freq=.0023548750981756753+frnd(.2)-.1,e.p_hpf_ramp=-.002375673204842568+frnd(.2)-.1,e):frnd(10)<1?(e.wave_type=Math.floor(frnd(SHAPES.length)),3===e.wave_type&&(e.wave_type=SQUARE),e.p_env_attack=.5277795946672003+frnd(.2)-.1,e.p_env_sustain=.18243733568468432+frnd(.2)-.1,e.p_env_punch=-.020159754546840117+frnd(.2)-.1,e.p_env_decay=.1561353422051903+frnd(.2)-.1,e.p_base_freq=.9028855606533718+frnd(.2)-.1,e.p_freq_limit=-.008842787837148716,e.p_freq_ramp=-.1,e.p_freq_dramp=-.012891241489551925,e.p_vib_strength=-.17923136138403065+frnd(.2)-.1,e.p_vib_speed=.908263385610142+frnd(.2)-.1,e.p_arp_mod=.41690153355414894+frnd(.2)-.1,e.p_arp_speed=.0010766233195860704+frnd(.2)-.1,e.p_duty=-.8735363011184684+frnd(.2)-.1,e.p_duty_ramp=-.7397985366747507+frnd(.2)-.1,e.p_repeat_speed=.0591789344172107+frnd(.2)-.1,e.p_pha_offset=-.9961184222777699+frnd(.2)-.1,e.p_pha_ramp=-.08234769395850523+frnd(.2)-.1,e.p_lpf_freq=.9412475115697335+frnd(.2)-.1,e.p_lpf_ramp=-.18261358925834958+frnd(.2)-.1,e.p_lpf_resonance=.24541438107389477+frnd(.2)-.1,e.p_hpf_freq=-.01831940280978611+frnd(.2)-.1,e.p_hpf_ramp=-.03857383633171346+frnd(.2)-.1,e):frnd(10)<1?(e.wave_type=Math.floor(frnd(SHAPES.length)),3===e.wave_type&&(e.wave_type=SQUARE),e.p_env_attack=.4304400932967592+frnd(.2)-.1,e.p_env_sustain=.15739346034252394+frnd(.2)-.1,e.p_env_punch=.004488201744871758+frnd(.2)-.1,e.p_env_decay=.07478075528212291+frnd(.2)-.1,e.p_base_freq=.9865265720147687+frnd(.2)-.1,e.p_freq_limit=0+frnd(.2)-.1,e.p_freq_ramp=-.2995018224359539+frnd(.2)-.1,e.p_freq_dramp=.004598608156964473+frnd(.2)-.1,e.p_vib_strength=-.2202799497929496+frnd(.2)-.1,e.p_vib_speed=.8084998703158364+frnd(.2)-.1,e.p_arp_mod=-.46410459213693644+frnd(.2)-.1,e.p_arp_speed=-.10955361249587248+frnd(.2)-.1,e.p_duty=-.9031808754347107+frnd(.2)-.1,e.p_duty_ramp=-.8128699999808343+frnd(.2)-.1,e.p_repeat_speed=.7014860189319991+frnd(.2)-.1,e.p_pha_offset=-.9424902314367765+frnd(.2)-.1,e.p_pha_ramp=-.1055482222272056+frnd(.2)-.1,e.p_lpf_freq=.9989765717851521+frnd(.2)-.1,e.p_lpf_ramp=-.25051720626043017+frnd(.2)-.1,e.p_lpf_resonance=.32777871505494693+frnd(.2)-.1,e.p_hpf_freq=.0023548750981756753+frnd(.2)-.1,e.p_hpf_ramp=-.002375673204842568+frnd(.2)-.1,e):frnd(5)>1?(e.wave_type=Math.floor(frnd(SHAPES.length)),3===e.wave_type&&(e.wave_type=SQUARE),rnd(1)?(e.p_arp_mod=.2697849293151393+frnd(.2)-.1,e.p_arp_speed=-.3131172257760948+frnd(.2)-.1,e.p_base_freq=.8090588299313949+frnd(.2)-.1,e.p_duty=-.6210022920964955+frnd(.2)-.1,e.p_duty_ramp=-.00043441813553182567+frnd(.2)-.1,e.p_env_attack=.004321877246874195+frnd(.2)-.1,e.p_env_decay=.1+frnd(.2)-.1,e.p_env_punch=.061737781504416146+frnd(.2)-.1,e.p_env_sustain=.4987252564798832+frnd(.2)-.1,e.p_freq_dramp=.31700340314222614+frnd(.2)-.1,e.p_freq_limit=0+frnd(.2)-.1,e.p_freq_ramp=-.163380391341416+frnd(.2)-.1,e.p_hpf_freq=.4709005021145149+frnd(.2)-.1,e.p_hpf_ramp=.6924667290539194+frnd(.2)-.1,e.p_lpf_freq=.8351398631384511+frnd(.2)-.1,e.p_lpf_ramp=.36616557192873134+frnd(.2)-.1,e.p_lpf_resonance=-.08685777111664439+frnd(.2)-.1,e.p_pha_offset=-.036084571580025544+frnd(.2)-.1,e.p_pha_ramp=-.014806445085568108+frnd(.2)-.1,e.p_repeat_speed=-.8094368475518489+frnd(.2)-.1,e.p_vib_speed=.4496665457171294+frnd(.2)-.1,e.p_vib_strength=.23413762515532424+frnd(.2)-.1):(e.p_arp_mod=-.35697118026766184+frnd(.2)-.1,e.p_arp_speed=.3581140690559588+frnd(.2)-.1,e.p_base_freq=1.3260897696157528+frnd(.2)-.1,e.p_duty=-.30984900436710694+frnd(.2)-.1,e.p_duty_ramp=-.0014374759133411626+frnd(.2)-.1,e.p_env_attack=.3160357835682254+frnd(.2)-.1,e.p_env_decay=.1+frnd(.2)-.1,e.p_env_punch=.24323114016870148+frnd(.2)-.1,e.p_env_sustain=.4+frnd(.2)-.1,e.p_freq_dramp=.2866475886237244+frnd(.2)-.1,e.p_freq_limit=0+frnd(.2)-.1,e.p_freq_ramp=-.10956352368742976+frnd(.2)-.1,e.p_hpf_freq=.20772718017889846+frnd(.2)-.1,e.p_hpf_ramp=.1564090637378835+frnd(.2)-.1,e.p_lpf_freq=.6021372770637031+frnd(.2)-.1,e.p_lpf_ramp=.24016227139979027+frnd(.2)-.1,e.p_lpf_resonance=-.08787383821160144+frnd(.2)-.1,e.p_pha_offset=-.381597686151701+frnd(.2)-.1,e.p_pha_ramp=-.0002481687661373495+frnd(.2)-.1,e.p_repeat_speed=.07812112809425686+frnd(.2)-.1,e.p_vib_speed=-.13648848579133943+frnd(.2)-.1,e.p_vib_strength=.0018874158972302657+frnd(.2)-.1),e):(e.wave_type=Math.floor(frnd(SHAPES.length)),1!==e.wave_type&&3!==e.wave_type||(e.wave_type=2),e.p_base_freq=.85+frnd(.15),e.p_freq_ramp=.3+frnd(.15),e.p_env_attack=0+frnd(.09),e.p_env_sustain=.2+frnd(.3),e.p_env_decay=0+frnd(.1),e.p_duty=frnd(2)-1,e.p_duty_ramp=Math.pow(frnd(2)-1,3),e.p_repeat_speed=.5+frnd(.1),e.p_pha_offset=-.3+frnd(.9),e.p_pha_ramp=-frnd(.3),e.p_arp_speed=.4+frnd(.6),e.p_arp_mod=.8+frnd(.1),e.p_lpf_resonance=frnd(2)-1,e.p_lpf_freq=1-Math.pow(frnd(1),3),e.p_lpf_ramp=Math.pow(frnd(2)-1,3),e.p_lpf_freq<.1&&e.p_lpf_ramp<-.05&&(e.p_lpf_ramp=-e.p_lpf_ramp),e.p_hpf_freq=Math.pow(frnd(1),5),e.p_hpf_ramp=Math.pow(frnd(2)-1,5),e)},pushSound=function(){var e=Params();return e.wave_type=Math.floor(frnd(SHAPES.length)),2===e.wave_type&&e.wave_type++,0===e.wave_type&&(e.wave_type=NOISE),e.p_base_freq=.1+frnd(.4),e.p_freq_ramp=.05+frnd(.2),e.p_env_attack=.01+frnd(.09),e.p_env_sustain=.01+frnd(.09),e.p_env_decay=.01+frnd(.09),e.p_repeat_speed=.3+frnd(.5),e.p_pha_offset=-.3+frnd(.9),e.p_pha_ramp=-frnd(.3),e.p_arp_speed=.6+frnd(.3),e.p_arp_mod=.8-frnd(1.6),e},powerUp=function(){var e=Params();return rnd(1)?e.wave_type=SAWTOOTH:e.p_duty=frnd(.6),e.wave_type=Math.floor(frnd(SHAPES.length)),3===e.wave_type&&(e.wave_type=SQUARE),rnd(1)?(e.p_base_freq=.2+frnd(.3),e.p_freq_ramp=.1+frnd(.4),e.p_repeat_speed=.4+frnd(.4)):(e.p_base_freq=.2+frnd(.3),e.p_freq_ramp=.05+frnd(.2),rnd(1)&&(e.p_vib_strength=frnd(.7),e.p_vib_speed=frnd(.6))),e.p_env_attack=0,e.p_env_sustain=frnd(.4),e.p_env_decay=.1+frnd(.4),e},hitHurt=function(){return result=Params(),result.wave_type=rnd(2),result.wave_type===SINE&&(result.wave_type=NOISE),result.wave_type===SQUARE&&(result.p_duty=frnd(.6)),result.wave_type=Math.floor(frnd(SHAPES.length)),result.p_base_freq=.2+frnd(.6),result.p_freq_ramp=-.3-frnd(.4),result.p_env_attack=0,result.p_env_sustain=frnd(.1),result.p_env_decay=.1+frnd(.2),rnd(1)&&(result.p_hpf_freq=frnd(.3)),result},jump=function(){return result=Params(),result.wave_type=SQUARE,result.wave_type=Math.floor(frnd(SHAPES.length)),3===result.wave_type&&(result.wave_type=SQUARE),result.p_duty=frnd(.6),result.p_base_freq=.3+frnd(.3),result.p_freq_ramp=.1+frnd(.2),result.p_env_attack=0,result.p_env_sustain=.1+frnd(.3),result.p_env_decay=.1+frnd(.2),rnd(1)&&(result.p_hpf_freq=frnd(.3)),rnd(1)&&(result.p_lpf_freq=1-frnd(.6)),result},blipSelect=function(){return result=Params(),result.wave_type=rnd(1),result.wave_type=Math.floor(frnd(SHAPES.length)),3===result.wave_type&&(result.wave_type=rnd(1)),result.wave_type===SQUARE&&(result.p_duty=frnd(.6)),result.p_base_freq=.2+frnd(.4),result.p_env_attack=0,result.p_env_sustain=.1+frnd(.1),result.p_env_decay=frnd(.2),result.p_hpf_freq=.1,result},random=function(){return result=Params(),result.wave_type=Math.floor(frnd(SHAPES.length)),result.p_base_freq=Math.pow(frnd(2)-1,2),rnd(1)&&(result.p_base_freq=Math.pow(frnd(2)-1,3)+.5),result.p_freq_limit=0,result.p_freq_ramp=Math.pow(frnd(2)-1,5),result.p_base_freq>.7&&result.p_freq_ramp>.2&&(result.p_freq_ramp=-result.p_freq_ramp),result.p_base_freq<.2&&result.p_freq_ramp<-.05&&(result.p_freq_ramp=-result.p_freq_ramp),result.p_freq_dramp=Math.pow(frnd(2)-1,3),result.p_duty=frnd(2)-1,result.p_duty_ramp=Math.pow(frnd(2)-1,3),result.p_vib_strength=Math.pow(frnd(2)-1,3),result.p_vib_speed=frnd(2)-1,result.p_env_attack=Math.pow(frnd(2)-1,3),result.p_env_sustain=Math.pow(frnd(2)-1,2),result.p_env_decay=frnd(2)-1,result.p_env_punch=Math.pow(frnd(.8),2),result.p_env_attack+result.p_env_sustain+result.p_env_decay<.2&&(result.p_env_sustain+=.2+frnd(.3),result.p_env_decay+=.2+frnd(.3)),result.p_lpf_resonance=frnd(2)-1,result.p_lpf_freq=1-Math.pow(frnd(1),3),result.p_lpf_ramp=Math.pow(frnd(2)-1,3),result.p_lpf_freq<.1&&result.p_lpf_ramp<-.05&&(result.p_lpf_ramp=-result.p_lpf_ramp),result.p_hpf_freq=Math.pow(frnd(1),5),result.p_hpf_ramp=Math.pow(frnd(2)-1,5),result.p_pha_offset=Math.pow(frnd(2)-1,3),result.p_pha_ramp=Math.pow(frnd(2)-1,3),result.p_repeat_speed=frnd(2)-1,result.p_arp_speed=frnd(2)-1,result.p_arp_mod=frnd(2)-1,result};var generators=[pickupCoin,laserShoot,explosion,powerUp,hitHurt,jump,blipSelect,pushSound,random,birdSound],generatorNames=["pickupCoin","laserShoot","explosion","powerUp","hitHurt","jump","blipSelect","pushSound","random","birdSound"];if(generateFromSeed=function(e){rng=new RNG(e/100|0);var r=e%100,_=generators[r%generators.length];seeded=!0;var p=_();return p.seed=e,seeded=!1,p},SoundEffect.prototype.getBuffer=function(){return this._buffer.getChannelData(0)},SoundEffect.prototype.play=function(){ULBS();var e=AUDIO_CONTEXT.createBufferSource(),r=AUDIO_CONTEXT.createBiquadFilter(),_=AUDIO_CONTEXT.createBiquadFilter(),p=AUDIO_CONTEXT.createBiquadFilter();e.buffer=this._buffer,e.connect(r),r.frequency.value=1600,_.frequency.value=1600,p.frequency.value=1600,r.connect(_),_.connect(p),p.connect(AUDIO_CONTEXT.destination);var n=AUDIO_CONTEXT.currentTime;void 0!==e.start?e.start(n):e.noteOn(n),e.onended=function(){p.disconnect()}},SoundEffect.MIN_SAMPLE_RATE=22050,void 0===AUDIO_CONTEXT&&(SoundEffect=function(e,r){this._sample_rate=r,this._buffer=new Array(e),this._audioElement=null},SoundEffect.prototype.getBuffer=function(){return this._audioElement=null,this._buffer},SoundEffect.prototype.play=function(){if(this._audioElement)this._audioElement.cloneNode(!1).play();else{for(var e=0;e<this._buffer.length;e++)this._buffer[e]=255&Math.floor(128*Math.max(0,Math.min(this._buffer[e]+1,2)));var r=MakeRiff(this._sample_rate,BIT_DEPTH,this._buffer);this._audioElement=new Audio,this._audioElement.src=r.dataURI,this._audioElement.play()}},SoundEffect.MIN_SAMPLE_RATE=1),SoundEffect.generate=function(e){function r(){_=0,p=100/(e.p_base_freq*e.p_base_freq+.001),n=Math.floor(p),t=100/(e.p_freq_limit*e.p_freq_limit+.001),f=1-.01*Math.pow(e.p_freq_ramp,3),a=1e-6*-Math.pow(e.p_freq_dramp,3),d=.5-.5*e.p_duty,o=5e-5*-e.p_duty_ramp,u=e.p_arp_mod>=0?1-.9*Math.pow(e.p_arp_mod,2):1+10*Math.pow(e.p_arp_mod,2),s=0,l=Math.floor(2e4*Math.pow(1-e.p_arp_speed,2)+32),1==e.p_arp_speed&&(l=0)}var _,p,n,t,f,a,d,o,u,s,l;r();var i=0,v=0,h=.1*Math.pow(e.p_lpf_freq,3),m=1+1e-4*e.p_lpf_ramp,c=5/(1+20*Math.pow(e.p_lpf_resonance,2))*(.01+h);c>.8&&(c=.8);var y=0,E=.1*Math.pow(e.p_hpf_freq,2),w=1+3e-4*e.p_hpf_ramp,q=0,S=.01*Math.pow(e.p_vib_speed,2),M=.5*e.p_vib_strength,b=0,A=0,g=0,T=[Math.floor(e.p_env_attack*e.p_env_attack*1e5),Math.floor(e.p_env_sustain*e.p_env_sustain*1e5),Math.floor(e.p_env_decay*e.p_env_decay*1e5)],I=T[0]+T[1]+T[2],O=0,P=1020*Math.pow(e.p_pha_offset,2);e.p_pha_offset<0&&(P=-P);var k=1*Math.pow(e.p_pha_ramp,2);e.p_pha_ramp<0&&(k=-k);for(var N=Math.abs(Math.floor(P)),U=0,C=[],B=0;B<1024;++B)C[B]=0;for(var R=[],B=0;B<32;++B)R[B]=2*Math.random()-1;var L=Math.floor(2e4*Math.pow(1-e.p_repeat_speed,2)+32);0==e.p_repeat_speed&&(L=0);var H,x=2*e.sound_vol,x=Math.exp(e.sound_vol)-1,D=0,X=0,Q=Math.floor(44100/e.sample_rate),F=0,V=Math.ceil(I/Q);H=e.sample_rate<SoundEffect.MIN_SAMPLE_RATE?new SoundEffect(4*V,SoundEffect.MIN_SAMPLE_RATE):new SoundEffect(V,e.sample_rate);for(var W=H.getBuffer(),j=0;;++j){0!=L&&++_>=L&&r(),0!=l&&j>=l&&(l=0,p*=u),f+=a,p*=f,p>t&&(p=t,e.p_freq_limit>0&&!0);var G=p;if(M>0&&(q+=S,G=p*(1+Math.sin(q)*M)),n=Math.floor(G),n<8&&(n=8),d+=o,d<0&&(d=0),d>.5&&(d=.5),++g>T[A]){for(g=1,A++;A<3&&0===T[A];)A++;if(3===A)break}b=0===A?g/T[0]:1===A?1+2*Math.pow(1-g/T[1],1)*e.p_env_punch:1-g/T[2],P+=k,N=Math.abs(Math.floor(P)),N>1023&&(N=1023),0!=w&&(E*=w,E<1e-5&&(E=1e-5),E>.1&&(E=.1));for(var K=0,Y=0;Y<8;++Y){var z=0;if(++O>=n&&(O%=n,e.wave_type===NOISE))for(var B=0;B<32;++B)R[B]=2*Math.random()-1;var J=O/n;if(e.wave_type===SQUARE)z=J<d?.5:-.5;else if(e.wave_type===SAWTOOTH)z=1-2*J;else if(e.wave_type===SINE)z=Math.sin(2*J*Math.PI);else if(e.wave_type===NOISE)z=R[Math.floor(32*O/n)];else if(e.wave_type===TRIANGLE)z=Math.abs(1-2*J)-1;else{if(e.wave_type!==BREAKER)throw new Exception("bad wave type! "+e.wave_type);z=Math.abs(1-J*J*2)-1}var Z=i;h*=m,h<0&&(h=0),h>.1&&(h=.1),1!=e.p_lpf_freq?(v+=(z-i)*h,v-=v*c):(i=z,v=0),i+=v,y+=i-Z,y-=y*E,z=y,C[1023&U]=z,z+=C[U-N+1024&1023],U=U+1&1023,K+=z*b}D+=K,++X>=Q&&(X=0,K=D/Q,D=0,K=K/8*masterVolume,K*=x,W[F++]=K,e.sample_rate<SoundEffect.MIN_SAMPLE_RATE&&(W[F++]=K,W[F++]=K,W[F++]=K))}return Q>0&&(K=D/Q,K=K/8*masterVolume,K*=x,W[F++]=K,e.sample_rate<SoundEffect.MIN_SAMPLE_RATE&&(W[F++]=K,W[F++]=K,W[F++]=K)),H},"undefined"!=typeof exports){var RIFFWAVE=require("./riffwave").RIFFWAVE;exports.Params=Params,exports.generate=generate}var sfxCache={},cachedSeeds=[],CACHE_MAX=50;</script> <script>function CodeMirror(t,i){}CodeMirror.defineMode=function(t,i){};var StringStream=CodeMirror.StringStream=function(t,i){this.pos=this.start=0,this.string=t,this.tabSize=i||8,this.lastColumnPos=this.lastColumnValue=0,this.lineStart=0};StringStream.prototype={eol:function(){return this.pos>=this.string.length},sol:function(){return this.pos==this.lineStart},peek:function(){return this.string.charAt(this.pos)||void 0},next:function(){if(this.pos<this.string.length)return this.string.charAt(this.pos++)},eat:function(t){var i=this.string.charAt(this.pos);if("string"==typeof t)var s=i==t;else var s=i&&(t.test?t.test(i):t(i));if(s)return++this.pos,i},eatWhile:function(t){for(var i=this.pos;this.eat(t););return this.pos>i},eatSpace:function(){for(var t=this.pos;/[\s\u00a0]/.test(this.string.charAt(this.pos));)++this.pos;return this.pos>t},skipToEnd:function(){this.pos=this.string.length},skipTo:function(t){var i=this.string.indexOf(t,this.pos);if(i>-1)return this.pos=i,!0},backUp:function(t){this.pos-=t},column:function(){return this.lastColumnPos<this.start&&(this.lastColumnValue=countColumn(this.string,this.start,this.tabSize,this.lastColumnPos,this.lastColumnValue),this.lastColumnPos=this.start),this.lastColumnValue-(this.lineStart?countColumn(this.string,this.lineStart,this.tabSize):0)},indentation:function(){return countColumn(this.string,null,this.tabSize)-(this.lineStart?countColumn(this.string,this.lineStart,this.tabSize):0)},match:function(t,i,s){if("string"!=typeof t){var n=this.string.slice(this.pos).match(t);return n&&n.index>0?null:(n&&!1!==i&&(this.pos+=n[0].length),n)}var r=function(t){return s?t.toLowerCase():t};if(r(this.string.substr(this.pos,t.length))==r(t))return!1!==i&&(this.pos+=t.length),!0},current:function(){return this.string.slice(this.start,this.pos)},hideFirstChars:function(t,i){this.lineStart+=t;try{return i()}finally{this.lineStart-=t}}};</script> <script>colorPalettesAliases={1:"mastersystem",2:"gameboycolour",3:"amiga",4:"arnecolors",5:"famicom",6:"atari",7:"pastel",8:"ega",9:"amstrad",10:"proteus_mellow",11:"proteus_rich",12:"proteus_night",13:"c64",14:"whitingjp"},colorPalettes={mastersystem:{black:"#000000",white:"#FFFFFF",grey:"#555555",darkgrey:"#555500",lightgrey:"#AAAAAA",gray:"#555555",darkgray:"#555500",lightgray:"#AAAAAA",red:"#FF0000",darkred:"#AA0000",lightred:"#FF5555",brown:"#AA5500",darkbrown:"#550000",lightbrown:"#FFAA00",orange:"#FF5500",yellow:"#FFFF55",green:"#55AA00",darkgreen:"#005500",lightgreen:"#AAFF00",blue:"#5555AA",lightblue:"#AAFFFF",darkblue:"#000055",purple:"#550055",pink:"#FFAAFF"},gameboycolour:{black:"#000000",white:"#FFFFFF",grey:"#7F7F7C",darkgrey:"#3E3E44",lightgrey:"#BAA7A7",gray:"#7F7F7C",darkgray:"#3E3E44",lightgray:"#BAA7A7",red:"#A7120C",darkred:"#880606",lightred:"#BA381F",brown:"#57381F",darkbrown:"#3E2519",lightbrown:"#8E634B",orange:"#BA4B32",yellow:"#C0BA6F",green:"#517525",darkgreen:"#385D12",lightgreen:"#6F8E44",blue:"#5D6FA7",lightblue:"#8EA7A7",darkblue:"#4B575D",purple:"#3E3E44",pink:"#BA381F"},amiga:{black:"#000000",white:"#FFFFFF",grey:"#BBBBBB",darkgrey:"#333333",lightgrey:"#FFEEDD",gray:"#BBBBBB",darkgray:"#333333",lightgray:"#FFEEDD",red:"#DD1111",darkred:"#990000",lightred:"#FF4422",brown:"#663311",darkbrown:"#331100",lightbrown:"#AA6644",orange:"#FF6644",yellow:"#FFDD66",green:"#448811",darkgreen:"#335500",lightgreen:"#88BB77",blue:"#8899DD",lightblue:"#BBDDEE",darkblue:"#666688",purple:"#665555",pink:"#997788"},arnecolors:{black:"#000000",white:"#FFFFFF",grey:"#9d9d9d",darkgrey:"#697175",lightgrey:"#cccccc",gray:"#9d9d9d",darkgray:"#697175",lightgray:"#cccccc",red:"#be2633",darkred:"#732930",lightred:"#e06f8b",brown:"#a46422",darkbrown:"#493c2b",lightbrown:"#eeb62f",orange:"#eb8931",yellow:"#f7e26b",green:"#44891a",darkgreen:"#2f484e",lightgreen:"#a3ce27",blue:"#1d57f7",lightblue:"#B2DCEF",darkblue:"#1B2632",purple:"#342a97",pink:"#de65e2"},famicom:{black:"#000000",white:"#ffffff",grey:"#7c7c7c",darkgrey:"#080808",lightgrey:"#bcbcbc",gray:"#7c7c7c",darkgray:"#080808",lightgray:"#bcbcbc",red:"#f83800",darkred:"#881400",lightred:"#f87858",brown:"#AC7C00",darkbrown:"#503000",lightbrown:"#FCE0A8",orange:"#FCA044",yellow:"#F8B800",green:"#00B800",darkgreen:"#005800",lightgreen:"#B8F8B8",blue:"#0058F8",lightblue:"#3CBCFC",darkblue:"#0000BC",purple:"#6644FC",pink:"#F878F8"},atari:{black:"#000000",white:"#FFFFFF",grey:"#909090",darkgrey:"#404040",lightgrey:"#b0b0b0",gray:"#909090",darkgray:"#404040",lightgray:"#b0b0b0",red:"#A03C50",darkred:"#700014",lightred:"#DC849C",brown:"#805020",darkbrown:"#703400",lightbrown:"#CB9870",orange:"#CCAC70",yellow:"#ECD09C",green:"#58B06C",darkgreen:"#006414",lightgreen:"#70C484",blue:"#1C3C88",lightblue:"#6888C8",darkblue:"#000088",purple:"#3C0080",pink:"#B484DC"},pastel:{black:"#000000",white:"#FFFFFF",grey:"#3e3e3e",darkgrey:"#313131",lightgrey:"#9cbcbc",gray:"#3e3e3e",darkgray:"#313131",lightgray:"#9cbcbc",red:"#f56ca2",darkred:"#a63577",lightred:"#ffa9cf",brown:"#b58c53",darkbrown:"#787562",lightbrown:"#B58C53",orange:"#EB792D",yellow:"#FFe15F",green:"#00FF4F",darkgreen:"#2b732c",lightgreen:"#97c04f",blue:"#0f88d3",lightblue:"#00fffe",darkblue:"#293a7b",purple:"#ff6554",pink:"#eb792d"},ega:{black:"#000000",white:"#ffffff",grey:"#555555",darkgrey:"#555555",lightgrey:"#aaaaaa",gray:"#555555",darkgray:"#555555",lightgray:"#aaaaaa",red:"#ff5555",darkred:"#aa0000",lightred:"#ff55ff",brown:"#aa5500",darkbrown:"#aa5500",lightbrown:"#ffff55",orange:"#ff5555",yellow:"#ffff55",green:"#00aa00",darkgreen:"#00aaaa",lightgreen:"#55ff55",blue:"#5555ff",lightblue:"#55ffff",darkblue:"#0000aa",purple:"#aa00aa",pink:"#ff55ff"},proteus_mellow:{black:"#3d2d2e",white:"#ddf1fc",grey:"#9fb2d4",darkgrey:"#7b8272",lightgrey:"#a4bfda",gray:"#9fb2d4",darkgray:"#7b8272",lightgray:"#a4bfda",red:"#9d5443",darkred:"#8c5b4a",lightred:"#94614c",brown:"#89a78d",darkbrown:"#829e88",lightbrown:"#aaae97",orange:"#d1ba86",yellow:"#d6cda2",green:"#75ac8d",darkgreen:"#8fa67f",lightgreen:"#8eb682",blue:"#88a3ce",lightblue:"#a5adb0",darkblue:"#5c6b8c",purple:"#d39fac",pink:"#c8ac9e"},proteus_night:{black:"#010912",white:"#fdeeec",grey:"#051d40",darkgrey:"#091842",lightgrey:"#062151",gray:"#051d40",darkgray:"#091842",lightgray:"#062151",red:"#ad4576",darkred:"#934765",lightred:"#ab6290",brown:"#61646b",darkbrown:"#3d2d2d",lightbrown:"#8393a0",orange:"#0a2227",yellow:"#0a2541",green:"#75ac8d",darkgreen:"#0a2434",lightgreen:"#061f2e",blue:"#0b2c79",lightblue:"#809ccb",darkblue:"#08153b",purple:"#666a87",pink:"#754b4d"},proteus_rich:{black:"#6f686f",white:"#d1b1e2",grey:"#b9aac1",darkgrey:"#8e8b84",lightgrey:"#c7b5cd",gray:"#b9aac1",darkgray:"#8e8b84",lightgray:"#c7b5cd",red:"#a11f4f",darkred:"#934765",lightred:"#c998ad",brown:"#89867d",darkbrown:"#797f75",lightbrown:"#ab9997",orange:"#ce8c5c",yellow:"#f0d959",green:"#75bc54",darkgreen:"#599d79",lightgreen:"#90cf5c",blue:"#8fd0ec",lightblue:"#bcdce7",darkblue:"#0b2c70",purple:"#9b377f",pink:"#cd88e5"},amstrad:{black:"#000000",white:"#ffffff",grey:"#7f7f7f",darkgrey:"#636363",lightgrey:"#afafaf",gray:"#7f7f7f",darkgray:"#636363",lightgray:"#afafaf",red:"#ff0000",darkred:"#7f0000",lightred:"#ff7f7f",brown:"#ff7f00",darkbrown:"#7f7f00",lightbrown:"#ffff00",orange:"#ff007f",yellow:"#ffff7f",green:"#01ff00",darkgreen:"#007f00",lightgreen:"#7fff7f",blue:"#0000ff",lightblue:"#7f7fff",darkblue:"#00007f",purple:"#7f007f",pink:"#ff7fff"},c64:{black:"#000000",white:"#ffffff",grey:"#6C6C6C",darkgrey:"#444444",lightgrey:"#959595",gray:"#6C6C6C",darkgray:"#444444",lightgray:"#959595",red:"#68372B",darkred:"#3f1e17",lightred:"#9A6759",brown:"#433900",darkbrown:"#221c02",lightbrown:"#6d5c0d",orange:"#6F4F25",yellow:"#B8C76F",green:"#588D43",darkgreen:"#345129",lightgreen:"#9AD284",blue:"#6C5EB5",lightblue:"#70A4B2",darkblue:"#352879",purple:"#6F3D86",pink:"#b044ac"},whitingjp:{black:"#202527",white:"#eff8fd",grey:"#7b7680",darkgrey:"#3c3b44",lightgrey:"#bed0d7",gray:"#7b7680",darkgray:"#3c3b44",lightgray:"#bed0d7",red:"#bd194b",darkred:"#6b1334",lightred:"#ef2358",brown:"#b52e1c",darkbrown:"#681c12",lightbrown:"#e87b45",orange:"#ff8c10",yellow:"#fbd524",green:"#36bc3c",darkgreen:"#317610",lightgreen:"#8ce062",blue:"#3f62c6",lightblue:"#57bbe0",darkblue:"#2c2fa0",purple:"#7037d9",pink:"#ec2b8f"}};var reg_color_names=/(black|white|darkgray|lightgray|gray|grey|darkgrey|lightgrey|red|darkred|lightred|brown|darkbrown|lightbrown|orange|yellow|green|darkgreen|lightgreen|blue|lightblue|darkblue|purple|pink|transparent)\s*/,reg_color=/(black|white|gray|darkgray|lightgray|grey|darkgrey|lightgrey|red|darkred|lightred|brown|darkbrown|lightbrown|orange|yellow|green|darkgreen|lightgreen|blue|lightblue|darkblue|purple|pink|transparent|#(?:[0-9a-f]{2}){3,4}|#(?:[0-9a-f]{3}))\s*/;</script> <script>function createSprite(e,t,i,l){void 0===i&&(i=[state.bgcolor,state.fgcolor]);var h=makeSpriteCanvas(e),o=h.getContext("2d");o.clearRect(0,0,cellwidth,cellheight);var a=t[0].length,r=t.length,c=~~(cellwidth/(a+(0|l))),s=~~(cellheight/(r+(0|l))),n=s;"scanline"in state.metadata&&(n=Math.ceil(s/2)),o.fillStyle=state.fgcolor;for(var d=0;d<a;d++)for(var g=0;g<r;g++){var f=t[d][g];if(f>=0){var m=d*c|0,v=g*s|0;o.fillStyle=i[f],o.fillRect(v,m,c,n)}}return h}function drawTextWithCustomFont(e,t,i,l){t.fillStyle=state.fgcolor,t.textBaseline="middle",t.textAlign="center",t.font=cellheight+"px PuzzleCustomFont",t.fillText(e,i,l)}function regenText(e,t){textImages={};for(var i in font)font.hasOwnProperty(i)&&(textImages[i]=createSprite("char"+i,font[i],void 0,1))}function regenSpriteImages(){if(textMode)return void regenText();if(levelEditorOpened&&(textImages.s=createSprite("chars",font.s,void 0)),0!==state.levels.length){spriteimages=[];for(var e=0;e<sprites.length;e++)void 0!=sprites[e]&&(spriteimages[e]=createSprite(e.toString(),sprites[e].dat,sprites[e].colors));canOpenEditor&&generateGlyphImages()}}function makeSpriteCanvas(e){var t;return e in canvasdict?t=canvasdict[e]:(t=document.createElement("canvas"),canvasdict[e]=t),t.width=cellwidth,t.height=cellheight,t}function generateGlyphImages(){if(0!==cellwidth&&0!==cellheight){glyphImagesCorrespondance=[],glyphImages=[];for(var e in state.glyphDict)if(1==e.length&&state.glyphDict.hasOwnProperty(e)){var t=state.glyphDict[e],i=makeSpriteCanvas("C"+e),l=i.getContext("2d");glyphImagesCorrespondance.push(e);for(var h=0;h<t.length;h++){var o=t[h];-1!==o&&l.drawImage(spriteimages[o],0,0)}glyphImages.push(i)}glyphHighlight=makeSpriteCanvas("highlight");var l=glyphHighlight.getContext("2d");l.fillStyle="#FFFFFF",l.fillRect(0,0,cellwidth,1),l.fillRect(0,0,1,cellheight),l.fillRect(0,cellheight-1,cellwidth,1),l.fillRect(cellwidth-1,0,1,cellheight),glyphPrintButton=textImages.s,glyphHighlightResize=makeSpriteCanvas("highlightresize");var l=glyphHighlightResize.getContext("2d");l.fillStyle="#FFFFFF";var a=cellwidth/2-1|0,r=cellwidth-a-1-a,c=cellheight/2-1|0,s=cellheight-c-1-a;l.fillRect(a,0,r,cellheight),l.fillRect(0,c,cellwidth,s),glyphMouseOver=makeSpriteCanvas();var l=glyphMouseOver.getContext("2d");l.fillStyle="yellow",l.fillRect(0,0,cellwidth,2),l.fillRect(0,0,2,cellheight),l.fillRect(0,cellheight-2,cellwidth,2),l.fillRect(cellwidth-2,0,2,cellheight)}}function glyphCount(){var e=0;for(var t in state.glyphDict)1==t.length&&state.glyphDict.hasOwnProperty(t)&&e++;return e}function initSmoothCamera(){if(void 0!==state&&void 0!==state.metadata.smoothscreen){screenwidth=state.metadata.smoothscreen.screenSize.width,screenheight=state.metadata.smoothscreen.screenSize.height;var e=state.metadata.smoothscreen.boundarySize,t=state.metadata.smoothscreen.flick,i=getPlayerPositions();if(i.length>0){var l={x:i[0]/level.height|0,y:i[0]%level.height|0};cameraPositionTarget={x:t?getFlickCameraPosition(l.x,level.width,screenwidth,e.width):getCameraPosition(l.x,level.width,screenwidth),y:t?getFlickCameraPosition(l.y,level.height,screenheight,e.height):getCameraPosition(l.y,level.height,screenheight)},cameraPosition.x=cameraPositionTarget.x,cameraPosition.y=cameraPositionTarget.y}}}function getCameraPosition(e,t,i){return Math.min(Math.max(e,Math.floor(i/2)),t-Math.ceil(i/2))}function getFlickCameraPosition(e,t,i,l){var h=Math.floor(i/2)-Math.floor(l/2),o=e-h,a=Math.floor(o/l),r=Math.floor((t-Math.ceil(i/2)-Math.floor(l/2)-h)/l);return Math.min(Math.max(a,0),r)*l+Math.floor(i/2)}function redraw(){if(0!==cellwidth&&0!==cellheight)if(void 0===spriteimages&&regenSpriteImages(),textMode)if(ctx.fillStyle=state.bgcolor,ctx.fillRect(0,0,canvas.width,canvas.height),void 0!==state.metadata.custom_font&&loadedCustomFont)for(var e=0;e<titleHeight;e++){var t=titleImage[e];drawTextWithCustomFont(t,ctx,xoffset+titleWidth*cellwidth/2,yoffset+e*cellheight+cellheight/2)}else for(var e=0;e<titleWidth;e++)for(var i=0;i<titleHeight;i++){var l=titleImage[i].charAt(e);if(l in textImages){var h=textImages[l];ctx.drawImage(h,xoffset+e*cellwidth,yoffset+i*cellheight)}}else{ctx.fillStyle=state.bgcolor,ctx.fillRect(0,0,canvas.width,canvas.height);var o=0,a=screenwidth,r=0,c=screenheight,s={x:0,y:0};if(levelEditorOpened){var n=glyphCount();editorRowCount=Math.ceil(n/(screenwidth-1)),a-=2,c-=2+editorRowCount}else if(flickscreen){var d=getPlayerPositions();if(d.length>0){var g=d[0],f=g/level.height|0,m=g%level.height|0,v=f/screenwidth|0,w=m/screenheight|0;o=v*screenwidth,r=w*screenheight,a=Math.min(o+screenwidth,level.width),c=Math.min(r+screenheight,level.height),oldflickscreendat=[o,r,a,c]}else oldflickscreendat.length>0&&(o=oldflickscreendat[0],r=oldflickscreendat[1],a=oldflickscreendat[2],c=oldflickscreendat[3])}else if(zoomscreen){var d=getPlayerPositions();if(d.length>0){var g=d[0],f=g/level.height|0,m=g%level.height|0;o=Math.max(Math.min(f-(screenwidth/2|0),level.width-screenwidth),0),r=Math.max(Math.min(m-(screenheight/2|0),level.height-screenheight),0),a=Math.min(o+screenwidth,level.width),c=Math.min(r+screenheight,level.height),oldflickscreendat=[o,r,a,c]}else oldflickscreendat.length>0&&(o=oldflickscreendat[0],r=oldflickscreendat[1],a=oldflickscreendat[2],c=oldflickscreendat[3])}else if(smoothscreen){var x=state.metadata.smoothscreen,d=(x.flick,getPlayerPositions());if(d.length>0){var g={x:d[0]/level.height|0,y:d[0]%level.height|0};["x","y"].forEach(function(e){var t="x"===e?screenwidth:screenheight,i="x"===e?"width":"height",l=level[i],h=x.boundarySize[i],o=g[e]-cameraPositionTarget[e],a=Math.sign(o),r=a>0?Math.ceil(h/2):-(Math.floor(h/2)+1);Math.abs(o)-Math.abs(r)>=0&&(cameraPositionTarget[e]=x.flick?getFlickCameraPosition(g[e],l,t,h):getCameraPosition(g[e]-r+a,l,t));var c=cameraPositionTarget[e]-cameraPosition[e];cameraPosition[e]+=c*x.cameraSpeed,s[e]=cameraPosition[e]%1}),o=Math.max(Math.min(Math.floor(cameraPosition.x)-Math.floor(screenwidth/2),level.width-screenwidth),0),r=Math.max(Math.min(Math.floor(cameraPosition.y)-Math.floor(screenheight/2),level.height-screenheight),0),a=Math.min(o+screenwidth,level.width),c=Math.min(r+screenheight,level.height),oldflickscreendat=[o,r,a,c]}else oldflickscreendat.length>0&&(o=oldflickscreendat[0],r=oldflickscreendat[1],a=oldflickscreendat[2],c=oldflickscreendat[3]);ctx.save(),ctx.beginPath(),ctx.moveTo(xoffset,yoffset),ctx.lineTo(xoffset+(a-o)*cellwidth,yoffset),ctx.lineTo(xoffset+(a-o)*cellwidth,yoffset+(c-r)*cellwidth),ctx.lineTo(xoffset,yoffset+(c-r)*cellwidth),ctx.clip()}screenOffsetX=o,screenOffsetY=r;for(var y=smoothscreen?1:0,e=Math.max(o-y,0);e<Math.min(a+y,level.width);e++)for(var i=Math.max(r-y,0);i<Math.min(c+y,level.height);i++)for(var p=i+e*level.height,u=level.getCellInto(p,_o12),C=0;C<state.objectCount;C++)if(0!=u.get(C)){var h=spriteimages[C];ctx.drawImage(h,Math.floor(xoffset+(e-o-s.x)*cellwidth),Math.floor(yoffset+(i-r-s.y)*cellheight))}smoothscreen&&ctx.restore(),levelEditorOpened&&drawEditorIcons()}}function drawEditorIcons(){var e=(glyphImages.length,glyphImages.length),t=e-0;ctx.drawImage(glyphPrintButton,xoffset-cellwidth,yoffset-cellheight*(1+editorRowCount)),mouseCoordY===-1-editorRowCount&&-1===mouseCoordX&&ctx.drawImage(glyphMouseOver,xoffset-cellwidth,yoffset-cellheight*(1+editorRowCount));for(var i=editorRowCount-(-mouseCoordY-2)-1,l=mouseCoordX+(screenwidth-1)*i,h=0;h<t;h++){var o=0+h,a=glyphImages[o],r=h%(screenwidth-1),i=h/(screenwidth-1)|0;ctx.drawImage(a,xoffset+r*cellwidth,yoffset+i*cellheight-cellheight*(1+editorRowCount)),mouseCoordX>=0&&mouseCoordX<screenwidth-1&&l===h&&ctx.drawImage(glyphMouseOver,xoffset+r*cellwidth,yoffset+i*cellheight-cellheight*(1+editorRowCount)),h===glyphSelectedIndex&&ctx.drawImage(glyphHighlight,xoffset+r*cellwidth,yoffset+i*cellheight-cellheight*(1+editorRowCount))}mouseCoordX>=-1&&mouseCoordY>=-1&&mouseCoordX<screenwidth-1&&mouseCoordY<screenheight-1-editorRowCount&&(-1==mouseCoordX||-1==mouseCoordY||mouseCoordX==screenwidth-2||mouseCoordY===screenheight-2-editorRowCount?ctx.drawImage(glyphHighlightResize,xoffset+mouseCoordX*cellwidth,yoffset+mouseCoordY*cellheight):ctx.drawImage(glyphHighlight,xoffset+mouseCoordX*cellwidth,yoffset+mouseCoordY*cellheight))}function canvasResize(){if(canvas.width=canvas.parentNode.clientWidth,canvas.height=canvas.parentNode.clientHeight,screenwidth=level.width,screenheight=level.height,void 0!==state)if(flickscreen=void 0!==state.metadata.flickscreen,zoomscreen=void 0!==state.metadata.zoomscreen,smoothscreen=void 0!==state.metadata.smoothscreen,levelEditorOpened){screenwidth+=2;var e=glyphCount();editorRowCount=Math.ceil(e/(screenwidth-1)),screenheight+=2+editorRowCount}else flickscreen?(screenwidth=state.metadata.flickscreen[0],screenheight=state.metadata.flickscreen[1]):zoomscreen?(screenwidth=state.metadata.zoomscreen[0],screenheight=state.metadata.zoomscreen[1]):smoothscreen&&(screenwidth=state.metadata.smoothscreen.screenSize.width,screenheight=state.metadata.smoothscreen.screenSize.height);textMode&&(screenwidth=titleWidth,screenheight=titleHeight),cellwidth=canvas.width/screenwidth,cellheight=canvas.height/screenheight;var t=sprites[1].dat.length,i=sprites[1].dat.length;textMode&&(t=6,i=6),cellwidth=t*~~(cellwidth/t),cellheight=i*~~(cellheight/i),xoffset=0,yoffset=0,cellwidth>cellheight||textMode&&void 0!==state.metadata.custom_font&&loadedCustomFont?(cellwidth=cellheight,xoffset=(canvas.width-cellwidth*screenwidth)/2,yoffset=(canvas.height-cellheight*screenheight)/2):(cellheight=cellwidth,yoffset=(canvas.height-cellheight*screenheight)/2,xoffset=(canvas.width-cellwidth*screenwidth)/2),magnification=cellwidth/t*5|0,levelEditorOpened&&!textMode&&(xoffset+=cellwidth,yoffset+=cellheight*(1+editorRowCount)),cellwidth|=0,cellheight|=0,xoffset|=0,yoffset|=0,(oldcellwidth!=cellwidth||oldcellheight!=cellheight||oldtextmode!=textMode||oldfgcolor!=state.fgcolor||forceRegenImages)&&(forceRegenImages=!1,regenSpriteImages()),oldcellheight=cellheight,oldcellwidth=cellwidth,oldtextmode=textMode,oldfgcolor=state.fgcolor,initSmoothCamera(),redraw()}var spriteimages,glyphImagesCorrespondance,glyphImages,glyphHighlight,glyphHighlightResize,glyphPrintButton,glyphMouseOver,glyphSelectedIndex=0,editorRowCount=1,canvasdict={},canvas,ctx,x,y,cellwidth,cellheight,magnification,xoffset,yoffset;window.addEventListener("resize",canvasResize,!1),canvas=document.getElementById("gameCanvas"),ctx=canvas.getContext("2d"),x=0,y=0;var cameraPositionTarget={x:0,y:0},cameraPosition={x:0,y:0},lastDownTarget,oldcellwidth=0,oldcellheight=0,oldtextmode=-1,oldfgcolor=-1,forceRegenImages=!1;</script> <script>function unloadGame(){state=introstate,level=new Level(0,5,5,2,null,null),level.objects=new Int32Array(0),generateTitleScreen(),canvasResize(),redraw(),titleSelected=!0}function isContinueOptionSelected(){return void 0===state.metadata.continue_is_level_select&&0==titleSelection}function isNewGameOptionSelected(){return titleSelection==titleSelectOptions-1}function isLevelSelectOptionSelected(){return void 0!==state.metadata.level_select&&(void 0!==state.metadata.continue_is_level_select?0==titleSelection:1==titleSelection)}function generateTitleScreen(){if(tryLoadCustomFont(),titleMode=curlevel>0||null!==curlevelTarget?1:0,0===state.levels.length)return void(titleImage=intro_template);var e="PuzzleScript Game";if(void 0!==state.metadata.title&&(e=state.metadata.title),0===titleMode)titleImage=deepClone(titleSelected?titletemplate_firstgo_selected:titletemplate_firstgo);else{var t=[0];titleSelectOptions=2,void 0!==state.metadata.level_select&&void 0===state.metadata.continue_is_level_select&&(titleSelectOptions++,t.push(1)),void 0!==state.metadata.settings&&(titleSelectOptions++,t.push(2)),t.push(3),titleImage=deepClone(titletemplate_empty);for(var l=0;l<titleSelectOptions;l++){var a=0;titleSelection==l&&(a=titleSelected?2:1);var n=0;2==titleSelectOptions&&1==l&&(n=1),titleImage[5+l+n]=deepClone(title_options[t[l]][a])}}var o="noaction"in state.metadata,i="noundo"in state.metadata,r="norestart"in state.metadata;titleImage[10]=".arrow keys to move...............",titleImage[11]=o?".X to select......................":" X to action......................",titleImage[12]=i&&r?"..................................":i?".R to restart.....................":r?".Z to undo........................":".Z to undo, R to restart..........",("mouse_left"in state.metadata||"mouse_drag"in state.metadata||"mouse_up"in state.metadata)&&(titleImage[10]="..................................",titleImage[11]=".MOUSE to interact................",titleImage[12]=".MMB to undo, R to restart........");for(var l=0;l<titleImage.length;l++)titleImage[l]=titleImage[l].replace(/\./g," ");for(var s=titleImage[0].length,c=wordwrap(e,titleImage[0].length),l=0;l<c.length;l++){var v=c[l],u=v.length,d=(s-u)/2|0,m=titleImage[1+l];titleImage[1+l]=m.slice(0,d)+v+m.slice(d+v.length)}if(void 0!==state.metadata.author)for(var g="by "+state.metadata.author,h=wordwrap(g,titleImage[0].length),l=0;l<h.length;l++){var f=h[l]+" ";f.length>s&&(f=f.slice(0,s));var m=titleImage[3+l];titleImage[3+l]=m.slice(0,s-f.length)+f}}function gotoLevelSelectScreen(){if(levelSelectScrollPos=0,titleSelected=!1,timer=0,quittingTitleScreen=!1,quittingMessageScreen=!1,messageselected=!1,titleMode=2,titleScreen=!0,textMode=!0,againing=!1,messagetext="",0==titleSelection)for(var e=0;e<state.sections.length;e++)if(state.sections[e].firstLevel>curlevel){titleSelection=Math.max(0,e-1);break}generateLevelSelectScreen(),redraw()}function generateLevelSelectScreen(){titleImage=["ESC: Back             Level Select","                                  "],amountOfLevelsOnScreen=9,titleSelectOptions=state.sections.length,titleSelection<levelSelectScrollPos?levelSelectScrollPos=titleSelection:titleSelection>=levelSelectScrollPos+amountOfLevelsOnScreen&&(levelSelectScrollPos=titleSelection-amountOfLevelsOnScreen+1);var e=titleSelection-levelSelectScrollPos;0==e&&(levelSelectScrollPos=Math.max(0,levelSelectScrollPos-1)),e==amountOfLevelsOnScreen-1&&(levelSelectScrollPos=Math.min(state.sections.length-amountOfLevelsOnScreen,levelSelectScrollPos+1)),0!=levelSelectScrollPos?titleImage.push("            [ PREV ]              "):titleImage.push("                                  ");var t=-1;if(void 0!==state.metadata.level_select_lock){for(var l=0,a=0;a<state.sections.length;a++)solvedSections.indexOf(state.sections[a].name)>=0?t=a:l++;void 0===state.metadata.level_select_unlocked_ahead?t+=1:t+=Number(state.metadata.level_select_unlocked_ahead)}for(var a=levelSelectScrollPos;a<levelSelectScrollPos+amountOfLevelsOnScreen&&!(a<0||a>=state.sections.length);a++){var n=state.sections[a],o=solvedSections.indexOf(n.name)>=0,i=a==titleSelection,r=t>=0&&a>t,s=n.name.substring(0,24);if(r){i&&titleSelected&&(titleSelected=!1,quittingTitleScreen=!1);var c=s.length;s="";for(var v=0;v<c;v++)s+="*"}var u="✓";void 0!==state.metadata.level_select_solve_symbol&&(u=state.metadata.level_select_solve_symbol);var d=(o?u:" ")+" ";d+=(i?"#":" ")+" "+s;for(var v=s.length;v<25;v++)i&&titleSelected&&v!=s.length?d+="#":d+=" ";d+=(i?"#":" ")+"  ",titleImage.push(d)}levelSelectScrollPos!=titleSelectOptions-amountOfLevelsOnScreen&&titleSelectOptions-amountOfLevelsOnScreen>0?titleImage.push("            [ NEXT ]              "):titleImage.push("                                  ");for(var a=titleImage.length;a<13;a++)titleImage.push("                                  ")}function gotoSelectedLevel(){againing=!1,messagetext="",curlevel=state.sections[titleSelection].firstLevel,loadLevelFromStateOrTarget(),updateLocalStorage(),resetFlickDat(),initSmoothCamera(),canvasResize(),clearInputHistory()}function deepClone(e){if(!e)return e;var t,l=[Number,String,Boolean];if(l.forEach(function(l){e instanceof l&&(t=l(e))}),void 0===t)if("[object Array]"===Object.prototype.toString.call(e))t=[],e.forEach(function(e,l,a){t[l]=deepClone(e)});else if("object"==typeof e)if(e.nodeType&&"function"==typeof e.cloneNode)var t=e.cloneNode(!0);else if(e.prototype)t=e;else if(e instanceof Date)t=new Date(e);else{t={};for(var a in e)t[a]=deepClone(e[a])}else t=e;return t}function wordwrap(e,t){t=t||75;if(!e)return e;var l=".{1,"+t+"}(\\s|$)|.{"+t+"}|.+$";return e.match(RegExp(l,"g"))}function drawMessageScreen(){tryLoadCustomFont(),titleMode=0,textMode=!0,titleImage=deepClone("mouse_left"in state.metadata||"mouse_drag"in state.metadata||"mouse_up"in state.metadata?messagecontainer_template_mouse:messagecontainer_template);for(var e=0;e<titleImage.length;e++)titleImage[e]=titleImage[e].replace(/\./g," ");var t=titleImage[9],l=titleImage[10];titleImage[10]=t;var a,n=titleImage[0].length;if(""===messagetext){a=state.levels[curlevel].message.trim()}else a=messagetext;splitMessage=wordwrap(a,titleImage[0].length);var o=5-(splitMessage.length/2|0);o<0&&(o=0);for(var i=Math.min(splitMessage.length,12),e=0;e<i;e++){var r=splitMessage[e],s=o+e,c=r.length,v=(n-c)/2|0,u=titleImage[s];titleImage[s]=u.slice(0,v)+r+u.slice(v+r.length)}var d=10;i>=10&&(d=i<12?i+1:12),quittingMessageScreen?titleImage[d]=t:titleImage[d]=l,canvasResize()}function loadLevelFromLevelDat(e,t,l){if(null==l&&(l=(Math.random()+Date.now()).toString()),loadedLevelSeed=l,RandomGen=new RNG(loadedLevelSeed),forceRegenImages=!0,titleScreen=!1,titleMode=curlevel>0||null!==curlevelTarget?1:0,titleSelection=0,titleSelected=!1,againing=!1,void 0===t)return consolePrint("Trying to access a level that doesn't exist.",!0),void goToTitleScreen();void 0===t.message?(titleMode=0,textMode=!1,level=t.clone(),RebuildLevelArrays(),void 0!==e&&(void 0!==e.metadata.flickscreen?oldflickscreendat=[0,0,Math.min(e.metadata.flickscreen[0],level.width),Math.min(e.metadata.flickscreen[1],level.height)]:void 0!==e.metadata.zoomscreen?oldflickscreendat=[0,0,Math.min(e.metadata.zoomscreen[0],level.width),Math.min(e.metadata.zoomscreen[1],level.height)]:void 0!==e.metadata.smoothscreen&&(oldflickscreendat=[0,0,Math.min(e.metadata.smoothscreen.screenSize.width,level.width),Math.min(e.metadata.smoothscreen.screenSize.height,level.height)])),backups=[],restartTarget=backupLevel(),keybuffer=[],"run_rules_on_level_start"in e.metadata&&processInput(-1,!0)):(tryPlayShowMessageSound(),drawMessageScreen(),canvasResize()),clearInputHistory()}function loadLevelFromStateTarget(e,t,l,a){var n=l;curlevel=t,curlevelTarget=l,void 0===n.message&&tryPlayStartLevelSound(),loadLevelFromLevelDat(e,e.levels[t],a),restoreLevel(l),restartTarget=l}function loadLevelFromState(e,t,l){var a=e.levels[t];curlevel=t,curlevelTarget=null,void 0!==a&&void 0===a.message&&tryPlayStartLevelSound(),loadLevelFromLevelDat(e,a,l)}function tryLoadCustomFont(){if(null!=state&&null!=state.metadata&&void 0!=state.metadata.custom_font&&!loadedCustomFont){new FontFace("PuzzleCustomFont","url("+state.metadata.custom_font+")").load().then(function(e){document.fonts.add(e),loadedCustomFont=!0,canvasResize(),redraw()}).catch(function(e){alert("Unable to load font!")})}}function tryPlaySimpleSound(e){if(void 0!==state.sfx_Events[e]){var t=state.sfx_Events[e];playSound(t)}}function tryPlayTitleSound(){tryPlaySimpleSound("titlescreen")}function tryPlayStartGameSound(){tryPlaySimpleSound("startgame")}function tryPlayEndGameSound(){tryPlaySimpleSound("endgame")}function tryPlayCancelSound(){tryPlaySimpleSound("cancel")}function tryPlayStartLevelSound(){tryPlaySimpleSound("startlevel")}function tryPlayEndLevelSound(){tryPlaySimpleSound("endlevel")}function tryPlayUndoSound(){tryPlaySimpleSound("undo")}function tryPlayRestartSound(){tryPlaySimpleSound("restart")}function tryPlayShowMessageSound(){tryPlaySimpleSound("showmessage")}function tryPlayCloseMessageSound(){tryPlaySimpleSound("closemessage")}function backupLevel(){return{dat:new Int32Array(level.objects),width:level.width,height:level.height,oldflickscreendat:oldflickscreendat.concat([])}}function level4Serialization(){return{dat:Array.from(level.objects),width:level.width,height:level.height,oldflickscreendat:oldflickscreendat.concat([])}}function tryDeactivateYoutube(){var e=document.getElementById("youtubeFrame");e&&document.body.removeChild(e)}function tryActivateYoutube(){if(!document.getElementById("youtubeFrame")&&canYoutube&&"youtube"in state.metadata){var e=state.metadata.youtube,t="https://www.youtube.com/embed/"+e+"?autoplay=1&loop=1&playlist="+e;ifrm=document.createElement("IFRAME"),ifrm.setAttribute("src",t),ifrm.setAttribute("id","youtubeFrame"),ifrm.style.visibility="hidden",ifrm.style.width="500px",ifrm.style.height="500px",ifrm.style.position="absolute",ifrm.style.top="-1000px",ifrm.style.left="-1000px",document.body.appendChild(ifrm)}}function setGameState(e,t,l){oldflickscreendat=[],timer=0,autotick=0,winning=!1,againing=!1,messageselected=!1,STRIDE_MOV=e.STRIDE_MOV,STRIDE_OBJ=e.STRIDE_OBJ,sfxCreateMask=new BitVec(STRIDE_OBJ),sfxDestroyMask=new BitVec(STRIDE_OBJ),void 0===t&&(t=["restart"]),(0===state.levels.length||0===e.levels.length)&&t.length>0&&"rebuild"===t[0]&&(t=["restart"]),void 0===l&&(l=null),RandomGen=new RNG(l),state=e,"rebuild"!==t[0]&&(backups=[]),sprites=[];for(var a in state.objects)if(state.objects.hasOwnProperty(a)){var n=state.objects[a],o={colors:n.colors,dat:n.spritematrix};sprites[n.id]=o}switch(void 0!==state.metadata.realtime_interval?(autotick=0,autotickinterval=1e3*state.metadata.realtime_interval):(autotick=0,autotickinterval=0),void 0!==state.metadata.key_repeat_interval?repeatinterval=1e3*state.metadata.key_repeat_interval:repeatinterval=150,void 0!==state.metadata.again_interval?againinterval=1e3*state.metadata.again_interval:againinterval=150,throttle_movement&&0===autotickinterval&&logWarning("throttle_movement is designed for use in conjunction with realtime_interval. Using it in other situations makes games gross and unresponsive, broadly speaking.  Please don't."),norepeat_action=void 0!==state.metadata.norepeat_action,t[0]){case"restart":if(1==restarting){logWarning('A "restart" command is being triggered in the "run_rules_on_level_start" section of level creation, which would cause an infinite loop if it was actually triggered, but it\'s being ignored, so it\'s not.');break}winning=!1,timer=0,titleScreen=!0,tryPlayTitleSound(),textMode=!0,titleSelection=0,titleSelected=!1,quittingMessageScreen=!1,quittingTitleScreen=!1,messageselected=!1,titleMode=0,(curlevel>0||null!==curlevelTarget)&&(titleMode=1),generateTitleScreen();break;case"rebuild":break;case"loadFirstNonMessageLevel":for(var i=0;i<state.levels.length;i++)if(!state.levels[i].hasOwnProperty("message")){var r=i;curlevel=i,winning=!1,timer=0,titleScreen=!1,textMode=!1,titleSelected=!1,quittingMessageScreen=!1,quittingTitleScreen=!1,messageselected=!1,titleMode=0,loadLevelFromState(state,r,l);break}break;case"loadLevel":var r=t[1];curlevel=i,winning=!1,timer=0,titleScreen=!1,textMode=!1,titleSelected=!1,quittingMessageScreen=!1,quittingTitleScreen=!1,messageselected=!1,titleMode=0,loadLevelFromState(state,r,l);break;case"levelline":for(var s=t[1],i=state.levels.length-1;i>=0;i--){if(state.levels[i].lineNumber<=s+1){curlevel=i,winning=!1,timer=0,titleScreen=!1,textMode=!1,titleSelected=!1,quittingMessageScreen=!1,quittingTitleScreen=!1,messageselected=!1,titleMode=0,loadLevelFromState(state,i);break}}}"rebuild"!==t[0]&&clearInputHistory(),initSmoothCamera(),canvasResize(),0==state.sounds.length&&null==state.metadata.youtube?killAudioButton():showAudioButton()}function RebuildLevelArrays(){level.movements=new Int32Array(level.n_tiles*STRIDE_MOV),level.rigidMovementAppliedMask=[],level.rigidGroupIndexMask=[],level.rowCellContents=[],level.colCellContents=[],level.mapCellContents=new BitVec(STRIDE_OBJ),_movementVecs=[new BitVec(STRIDE_MOV),new BitVec(STRIDE_MOV),new BitVec(STRIDE_MOV)],_o1=new BitVec(STRIDE_OBJ),_o2=new BitVec(STRIDE_OBJ),_o2_5=new BitVec(STRIDE_OBJ),_o3=new BitVec(STRIDE_OBJ),_o4=new BitVec(STRIDE_OBJ),_o5=new BitVec(STRIDE_OBJ),_o6=new BitVec(STRIDE_OBJ),_o7=new BitVec(STRIDE_OBJ),_o8=new BitVec(STRIDE_OBJ),_o9=new BitVec(STRIDE_OBJ),_o10=new BitVec(STRIDE_OBJ),_o11=new BitVec(STRIDE_OBJ),_o12=new BitVec(STRIDE_OBJ),_m1=new BitVec(STRIDE_MOV),_m2=new BitVec(STRIDE_MOV),_m3=new BitVec(STRIDE_MOV);for(var e=0;e<level.height;e++)level.rowCellContents[e]=new BitVec(STRIDE_OBJ);for(var e=0;e<level.width;e++)level.colCellContents[e]=new BitVec(STRIDE_OBJ);for(var e=0;e<level.n_tiles;e++)level.rigidMovementAppliedMask[e]=new BitVec(STRIDE_MOV),level.rigidGroupIndexMask[e]=new BitVec(STRIDE_MOV)}function restoreLevel(e){if(oldflickscreendat=e.oldflickscreendat.concat([]),level.objects=new Int32Array(e.dat),level.width!==e.width||level.height!==e.height)level.width=e.width,level.height=e.height,level.n_tiles=e.width*e.height,RebuildLevelArrays();else{for(var t=0;t<level.n_tiles;t++)level.movements[t]=0,level.rigidMovementAppliedMask[t]=0,level.rigidGroupIndexMask[t]=0;for(var t=0;t<level.height;t++){level.rowCellContents[t].setZero()}for(var t=0;t<level.width;t++){level.colCellContents[t].setZero()}}againing=!1,level.commandQueue=[],level.commandQueueSourceRules=[]}function DoRestart(e){!0!==restarting&&(restarting=!0,!0!==e&&"norestart"in state.metadata||(!1===e&&backups.push(backupLevel()),verbose_logging&&consolePrint("--- restarting ---",!0),restoreLevel(restartTarget),tryPlayRestartSound(),"run_rules_on_level_start"in state.metadata&&processInput(-1,!0),initSmoothCamera(),level.commandQueue=[],level.commandQueueSourceRules=[],restarting=!1))}function backupDiffers(){if(0==backups.length)return!0;for(var e=backups[backups.length-1],t=0;t<level.objects.length;t++)if(level.objects[t]!==e.dat[t])return!0;return!1}function DoUndo(e,t){if(levelEditorOpened||!("noundo"in state.metadata)||!0===e){if(verbose_logging&&consolePrint("--- undoing ---",!0),t)for(;0==backupDiffers();)backups.pop();if(backups.length>0){restoreLevel(backups[backups.length-1]),backups=backups.splice(0,backups.length-1),e||tryPlayUndoSound()}}}function getPlayerPositions(){var e=[],t=state.playerMask;for(i=0;i<level.n_tiles;i++)level.getCellInto(i,_o11),t.anyBitsInCommon(_o11)&&e.push(i);return e}function getLayersOfMask(e){for(var t=[],l=0;l<state.objectCount;l++)if(e.get(l)){var a=state.idDict[l],n=state.objects[a];t.push(n.layer)}return t}function moveEntitiesAtIndex(e,t,l){var a=level.getCell(e);a.iand(t);for(var n=getLayersOfMask(a),o=level.getMovements(e),i=0;i<n.length;i++)o.ishiftor(l,5*n[i]);level.setMovements(e,o)}function startMovement(e){for(var t=getPlayerPositions(),l=0;l<t.length;l++){moveEntitiesAtIndex(t[l],state.playerMask,e)}return t}function repositionEntitiesOnLayer(e,t,l){var a=dirMasksDelta[l],n=a[0],o=a[1],i=e/level.height|0,r=e%level.height,s=level.width-1,c=level.height-1;if(0===i&&n<0||i===s&&n>0||0===r&&o<0||r===c&&o>0)return!1;var v=e+a[1]+a[0]*level.height,u=state.layerMasks[t],d=level.getCellInto(v,_o7),m=level.getCellInto(e,_o8);if(u.anyBitsInCommon(d)&&16!=l)return!1;for(var g=0;g<state.sfx_MovementMasks.length;g++){var h=state.sfx_MovementMasks[g];if(h.objectMask.anyBitsInCommon(m)){var f=level.getMovements(e),p=h.directionMask;f.anyBitsInCommon(p)&&-1===seedsToPlay_CanMove.indexOf(h.seed)&&seedsToPlay_CanMove.push(h.seed)}}var S=m.clone();m.iclear(u),S.iand(u),d.ior(S),level.setCell(e,m),level.setCell(v,d);var _=v/level.height|0,y=v%level.height;return level.colCellContents[_].ior(S),level.rowCellContents[y].ior(S),level.mapCellContents.ior(S),!0}function repositionEntitiesAtCell(e){var t=level.getMovements(e);if(t.iszero())return!1;for(var l=!1,a=0;a<level.layerCount;a++){var n=t.getshiftor(31,5*a);if(0!==n){repositionEntitiesOnLayer(e,a,n)&&(t.ishiftclear(n,5*a),l=!0)}}return level.setMovements(e,t),l}function Level(e,t,l,a,n,o){this.lineNumber=e,this.width=t,this.height=l,this.n_tiles=t*l,this.objects=n,this.section=o,this.layerCount=a,this.commandQueue=[],this.commandQueueSourceRules=[]}function BitVec(e){return this.data=new Int32Array(e),this}function Rule(e){this.direction=e[0],this.patterns=e[1],this.hasReplacements=e[2],this.lineNumber=e[3],this.isEllipsis=e[4],this.groupNumber=e[5],this.isRigid=e[6],this.commands=e[7],this.isRandom=e[8],this.cellRowMasks=e[9],this.cellRowMatches=[];for(var t=0;t<this.patterns.length;t++)this.cellRowMatches.push(this.generateCellRowMatchesFunction(this.patterns[t],this.isEllipsis[t]))}function CellPattern(e){this.objectsPresent=e[0],this.objectsMissing=e[1],this.anyObjectsPresent=e[2],this.movementsPresent=e[3],this.movementsMissing=e[4],this.matches=this.generateMatchFunction(),this.replacement=e[5]}function CellReplacement(e){this.objectsClear=e[0],this.objectsSet=e[1],this.movementsClear=e[2],this.movementsSet=e[3],this.movementsLayerMask=e[4],this.randomEntityMask=e[5],this.randomDirMask=e[6]}function DoesCellRowMatchWildCard(e,t,l,a,n){void 0===n&&(n=0);var o=t[0];if(o.matches(l))for(var i=dirMasksDelta[e],r=i[0]*level.height,s=i[1],c=l,v=1;v<t.length;v+=1){c=c+s+r;var o=t[v];if(o===ellipsisPattern){for(var u=n;u<a;u++){var d=c;d=(d+(s+r)*u+level.n_tiles)%level.n_tiles;for(var m=v+1;m<t.length&&(o=t[m],o.matches(d));m++)d=d+s+r;if(m>=t.length)return!0}break}if(!o.matches(c))break}return!1}function DoesCellRowMatch(e,t,l,a){var n=t[0];if(n.matches(l)){for(var o=dirMasksDelta[e],i=o[0]*level.height,r=o[1],s=t.length,c=l,v=1;v<s&&(c=c+r+i,n=t[v],n===ellipsisPattern&&(c+=(r+i)*a),n.matches(c));v++);if(v>=t.length)return!0}return!1}function matchCellRow(e,t,l,a){var n=[];if(!a.bitsSetInArray(level.mapCellContents.data))return n;var o=0,i=level.width,r=0,s=level.height,c=l.length;switch(e){case 1:r+=c-1;break;case 2:s-=c-1;break;case 4:o+=c-1;break;case 8:i-=c-1;break;default:window.console.log("EEEP "+e)}if(e>2){for(var v=r;v<s;v++)if(a.bitsSetInArray(level.rowCellContents[v].data))for(var u=o;u<i;u++){var d=u*level.height+v;t(l,d)&&n.push(d)}}else for(var u=o;u<i;u++)if(a.bitsSetInArray(level.colCellContents[u].data))for(var v=r;v<s;v++){var d=u*level.height+v;t(l,d)&&n.push(d)}return n}function matchCellRowWildCard(e,t,l,a){var n=[];if(!a.bitsSetInArray(level.mapCellContents.data))return n;var o=0,i=level.width,r=0,s=level.height,c=l.length-1;switch(e){case 1:r+=c-1;break;case 2:s-=c-1;break;case 4:o+=c-1;break;case 8:i-=c-1;break;default:window.console.log("EEEP2 "+e)}if(e>2){for(var v=r;v<s;v++)if(a.bitsSetInArray(level.rowCellContents[v].data))for(var u=o;u<i;u++){var d,m=u*level.height+v;4===e?d=u-c+2:8===e?d=level.width-(u+c)+1:window.console.log("EEEP2 "+e),n.push.apply(n,t(l,m,d,0))}}else for(var u=o;u<i;u++)if(a.bitsSetInArray(level.colCellContents[u].data))for(var v=r;v<s;v++){var d,m=u*level.height+v;2===e?d=level.height-(v+c)+1:1===e?d=v-c+2:window.console.log("EEEP2 "+e),n.push.apply(n,t(l,m,d,0))}return n}function generateTuples(e){for(var t=[[]],l=0;l<e.length;l++){for(var a=e[l],n=[],o=0;o<a.length;o++)for(var i=a[o],r=0;r<t.length;r++){var s=t[r],c=s.concat([i]);n.push(c)}t=n}return t}function commitPreservationState(e){var t={ruleGroupIndex:e,objects:new Int32Array(level.objects),movements:new Int32Array(level.movements),rigidGroupIndexMask:level.rigidGroupIndexMask.concat([]),rigidMovementAppliedMask:level.rigidMovementAppliedMask.concat([]),bannedGroup:level.bannedGroup.concat([]),commandQueue:level.commandQueue.concat([]),commandQueueSourceRules:level.commandQueueSourceRules.concat([])};return rigidBackups[e]=t,t}function restorePreservationState(e){level.objects=new Int32Array(e.objects),level.movements=new Int32Array(e.movements),level.rigidGroupIndexMask=e.rigidGroupIndexMask.concat([]),level.rigidMovementAppliedMask=e.rigidMovementAppliedMask.concat([]),level.commandQueue=e.commandQueue.concat([]),level.commandQueueSourceRules=e.commandQueueSourceRules.concat([]),sfxCreateMask.setZero(),sfxDestroyMask.setZero(),consolePrint("Rigid movement application failed, rolling back")}function showTempMessage(){keybuffer=[],textMode=!0,titleScreen=!1,quittingMessageScreen=!1,messageselected=!1,tryPlayShowMessageSound(),drawMessageScreen(),canvasResize()}function applyRandomRuleGroup(e){for(var t=[],l=0;l<e.length;l++){var a=e[l],n=a.findMatches();if(n.length>0)for(var o=generateTuples(n),i=0;i<o.length;i++){var r=o[i];t.push([l,r])}}if(0===t.length)return!1;var s=t[Math.floor(RandomGen.uniform()*t.length)],l=s[0],a=e[l],c=dirMasksDelta[a.direction],r=s[1],v=a.applyAt(c,r,!1);return a.queueCommands(),v}function applyRuleGroup(e){if(e[0].isRandom)return applyRandomRuleGroup(e);for(var t=!1,l=!0,a=0;l;){if(++a>200){logErrorCacheable("Got caught looping lots in a rule group :O",e[0].lineNumber,!0);break}l=!1;for(var n=0;n<e.length;n++){l=e[n].tryApply()||l}l&&(t=!0)}return t}function applyRules(e,t,l,a){for(var n=l>0,o=0,i=l;i<e.length;){if(a&&a[i]);else{var r=e[i];n=applyRuleGroup(r)||n}if(n&&void 0!==t[i]){if(i=t[i],n=!1,++o>200){var r=e[i];logErrorCacheable("got caught in an endless startloop...endloop vortex, escaping!",r[0].lineNumber,!0);break}}else if(++i===e.length&&n&&void 0!==t[i]&&(i=t[i],n=!1,++o>200)){var r=e[i];logErrorCacheable("got caught in an endless startloop...endloop vortex, escaping!",r[0].lineNumber,!0);break}}}function resolveMovements(e){for(var t=!0;t;){t=!1;for(var l=0;l<level.n_tiles;l++)t=repositionEntitiesAtCell(l)||t}for(var a=!1,l=0;l<level.n_tiles;l++){var n=level.getCellInto(l,_o6),o=level.getMovements(l);if(!o.iszero()){var i=level.rigidMovementAppliedMask[l];if(0!==i&&(o.iand(i),!o.iszero()))for(var r=0;r<level.layerCount;r++){var s=o.getshiftor(31,5*r);if(0!==s){var c=level.rigidGroupIndexMask[l],v=c.getshiftor(31,5*r);v--;var u=state.rigidGroupIndex_to_GroupIndex[v];level.bannedGroup[u]=!0,a=!0;break}}for(var r=0;r<state.sfx_MovementFailureMasks.length;r++){var d=state.sfx_MovementFailureMasks[r];if(d.objectMask.anyBitsInCommon(n)){var m=d.directionMask;o.anyBitsInCommon(m)&&-1===seedsToPlay_CantMove.indexOf(d.seed)&&seedsToPlay_CantMove.push(d.seed)}}}for(var r=0;r<STRIDE_MOV;r++)level.movements[r+l*STRIDE_MOV]=0;level.rigidGroupIndexMask[l]=0,level.rigidMovementAppliedMask[l]=0}return a}function calculateRowColMasks(){for(var e=0;e<level.mapCellContents.length;e++)level.mapCellContents[e]=0;for(var e=0;e<level.width;e++){level.colCellContents[e].setZero()}for(var e=0;e<level.height;e++){level.rowCellContents[e].setZero()}for(var e=0;e<level.width;e++)for(var t=0;t<level.height;t++){var l=t+e*level.height,a=level.getCellInto(l,_o9);level.mapCellContents.ior(a),level.rowCellContents[t].ior(a),level.colCellContents[e].ior(a)}}function processInput(e,t,l,a){againing=!1,verbose_logging&&(-1===e?consolePrint("Turn starts with no input."):(consolePrint("======================="),consolePrint("Turn starts with input of "+["up","left","down","right","action","mouse"][e]+"."))),void 0==a&&(a=backupLevel());var n=[];if(e<=5){if(e>=0&&e<=4){switch(e){case 0:e=parseInt("00001",2);break;case 1:e=parseInt("00100",2);break;case 2:e=parseInt("00010",2);break;case 3:e=parseInt("01000",2);break;case 4:e=parseInt("10000",2)}n=startMovement(e)}var o=0;level.bannedGroup=[],rigidBackups=[],level.commandQueue=[],level.commandQueueSourceRules=[];var i=0,r=!1,s=commitPreservationState();sfxCreateMask.setZero(),sfxDestroyMask.setZero(),seedsToPlay_CanMove=[],seedsToPlay_CantMove=[],calculateRowColMasks();do{r=!1,o++,verbose_logging&&consolePrint("applying rules"),applyRules(state.rules,state.loopPoint,i,level.bannedGroup);resolveMovements()?(r=!0,restorePreservationState(s),i=0):(verbose_logging&&consolePrint("applying late rules"),applyRules(state.lateRules,state.lateLoopPoint,0),i=0)}while(o<250&&r);if(o>=250)return consolePrint("looped through 250 times, gave up. Too many loops!"),applyRules(state.lateRules,state.lateLoopPoint,0),i=0,backups.push(a),DoUndo(!0,!1),!1;if(n.length>0&&void 0!==state.metadata.require_player_movement){for(var c=!1,o=0;o<n.length;o++){var v=n[o],u=level.getCell(v);if(state.playerMask.bitsClearInArray(u.data)){c=!0;break}}if(!1===c)return verbose_logging&&(consolePrint("require_player_movement set, but no player movement detected, so cancelling turn."),consoleCacheDump()),backups.push(a),DoUndo(!0,!1),!1}if(level.commandQueue.indexOf("undo")>=0)return verbose_logging&&(consoleCacheDump(),consolePrint("UNDO command executed, undoing turn.",!0)),messagetext="",DoUndo(!0,!1),!0;if(level.commandQueue.indexOf("cancel")>=0){if(verbose_logging){consoleCacheDump();var d=level.commandQueueSourceRules[level.commandQueue.indexOf("cancel")];consolePrintFromRule("CANCEL command executed, cancelling turn.",d,!0)}return backups.push(a),messagetext="",DoUndo(!0,!1),tryPlayCancelSound(),!1}if(level.commandQueue.indexOf("restart")>=0){if(verbose_logging){var d=level.commandQueueSourceRules[level.commandQueue.indexOf("restart")];consolePrintFromRule("RESTART command executed, reverting to restart state.",d),consoleCacheDump()}return backups.push(a),messagetext="",DoRestart(!0),!0}if(level.commandQueue.indexOf("quit")>=0){if(verbose_logging){var d=level.commandQueueSourceRules[level.commandQueue.indexOf("restart")];consolePrintFromRule("QUIT command executed, exiting level.",d),consoleCacheDump()}return void 0!==state.metadata.level_select?gotoLevelSelectScreen():goToTitleScreen(),messagetext="",canvasResize(),!0}if(l&&level.commandQueue.indexOf("win")>=0)return!0;var m=!0;if(!winning&&level.commandQueue.indexOf("nosave")>=0){if(verbose_logging){var d=level.commandQueueSourceRules[level.commandQueue.indexOf("nosave")];consolePrintFromRule("NOSAVE command executed, not storing current state to undo queue.",d)}m=!1}for(var g=!1,o=0;o<level.objects.length;o++)if(level.objects[o]!==a.dat[o]){if(l)return verbose_logging&&consoleCacheDump(),backups.push(a),DoUndo(!0,!1),!0;-1!==e&&m&&backups.push(a),g=!0;break}if(l)return verbose_logging&&consoleCacheDump(),!1;for(var o=0;o<seedsToPlay_CantMove.length;o++)playSound(seedsToPlay_CantMove[o]);for(var o=0;o<seedsToPlay_CanMove.length;o++)playSound(seedsToPlay_CanMove[o]);for(var o=0;o<state.sfx_CreationMasks.length;o++){var h=state.sfx_CreationMasks[o];sfxCreateMask.anyBitsInCommon(h.objectMask)&&playSound(h.seed)}for(var o=0;o<state.sfx_DestructionMasks.length;o++){var h=state.sfx_DestructionMasks[o];sfxDestroyMask.anyBitsInCommon(h.objectMask)&&playSound(h.seed)}for(var o=0;o<level.commandQueue.length;o++){var f=level.commandQueue[o];"f"===f.charAt(1)&&tryPlaySimpleSound(f),!1===unitTesting?"message"===f&&showTempMessage():messagetext=""}if(!1===textMode&&(verbose_logging&&consolePrint("Checking win condition."),void 0===t&&(t=!1),checkWin(t)),!winning){if(level.commandQueue.indexOf("checkpoint")>=0){if(verbose_logging){var d=level.commandQueueSourceRules[level.commandQueue.indexOf("checkpoint")];consolePrintFromRule("CHECKPOINT command executed, saving current state to the restart state.",d)}restartTarget=level4Serialization(),hasUsedCheckpoint=!0;var p=JSON.stringify(restartTarget);localStorage[document.URL+"_checkpoint"]=p,localStorage[document.URL]=curlevel}if(level.commandQueue.indexOf("again")>=0&&g){var d=level.commandQueueSourceRules[level.commandQueue.indexOf("again")],S=verbose_logging,_=messagetext;verbose_logging=!1,processInput(-1,!0,!0)?(verbose_logging=S,verbose_logging&&consolePrintFromRule("AGAIN command executed, with changes detected - will execute another turn.",d),againing=!0,timer=0):(verbose_logging=S,verbose_logging&&consolePrintFromRule("AGAIN command not executed, it wouldn't make any changes.",d)),verbose_logging=S,messagetext=_}}level.commandQueue=[],level.commandQueueSourceRules=[]}return verbose_logging&&consoleCacheDump(),winning&&(againing=!1),g}function checkWin(e){if(levelEditorOpened&&(e=!0),level.commandQueue.indexOf("win")>=0)return consolePrint("Win Condition Satisfied"),void(e||DoWin());var t=!1;if(state.winconditions.length>0){for(var l=!0,a=0;a<state.winconditions.length;a++){var n=state.winconditions[a],o=n[1],i=n[2],r=!0;switch(n[0]){case-1:for(var s=0;s<level.n_tiles;s++){var c=level.getCellInto(s,_o10);if(!o.bitsClearInArray(c.data)&&!i.bitsClearInArray(c.data)){r=!1;break}}break;case 0:for(var v=!1,s=0;s<level.n_tiles;s++){var c=level.getCellInto(s,_o10);if(!o.bitsClearInArray(c.data)&&!i.bitsClearInArray(c.data)){v=!0;break}}!1===v&&(r=!1);break;case 1:for(var s=0;s<level.n_tiles;s++){var c=level.getCellInto(s,_o10);if(!o.bitsClearInArray(c.data)&&i.bitsClearInArray(c.data)){r=!1;break}}}!1===r&&(l=!1)}t=l}t&&(consolePrint("Win Condition Satisfied"),e||DoWin())}function DoWin(){if(!winning){if(againing=!1,tryPlayEndLevelSound(),unitTesting)return void nextLevel();winning=!0,timer=0}}function nextLevel(){if(againing=!1,messagetext="",state&&state.levels&&curlevel>state.levels.length&&(curlevel=state.levels.length-1),titleScreen&&titleMode<=1)isContinueOptionSelected()?loadLevelFromStateOrTarget():isNewGameOptionSelected()?(curlevel=0,curlevelTarget=null,void 0===state.metadata.level_select&&clearLocalStorage(),loadLevelFromStateOrTarget()):isLevelSelectOptionSelected()&&(titleSelection=0,gotoLevelSelectScreen());else if(hasUsedCheckpoint&&(curlevelTarget=null,hasUsedCheckpoint=!1),curlevel<state.levels.length-1){var e=!1,t=state.levels[Number(curlevel)].section,l=state.levels[Number(curlevel)+1].section;l!=t&&(setSectionSolved(state.levels[Number(curlevel)].section),solvedSections.length==state.sections.length&&void 0!=state.winSection?curlevel=state.winSection.firstLevel-1:"__WIN__"==l&&(gotoLevelSelectScreen(),e=!0)),e||(curlevel++,textMode=!1,titleScreen=!1,quittingMessageScreen=!1,messageselected=!1,loadLevelFromStateOrTarget())}else solvedSections.length==state.sections.length?(void 0===state.metadata.level_select?(clearLocalStorage(),curlevel=0,curlevelTarget=null,goToTitleScreen()):gotoLevelSelectScreen(),tryPlayEndGameSound()):(null!=state.levels[Number(curlevel)].section&&setSectionSolved(state.levels[Number(curlevel)].section),gotoLevelSelectScreen());updateLocalStorage(),resetFlickDat(),initSmoothCamera(),canvasResize(),clearInputHistory()}function loadLevelFromStateOrTarget(){null!==curlevelTarget?loadLevelFromStateTarget(state,curlevel,curlevelTarget):loadLevelFromState(state,curlevel)}function goToTitleScreen(){againing=!1,messagetext="",titleScreen=!0,textMode=!0,doSetupTitleScreenLevelContinue(),generateTitleScreen()}function resetFlickDat(){void 0!==state&&void 0!==state.metadata.flickscreen&&(oldflickscreendat=[0,0,Math.min(state.metadata.flickscreen[0],level.width),Math.min(state.metadata.flickscreen[1],level.height)])}function updateLocalStorage(){try{if(window.localStorage)if(localStorage[document.URL]=curlevel,null!==curlevelTarget){restartTarget=level4Serialization();var e=JSON.stringify(restartTarget);localStorage[document.URL+"_checkpoint"]=e
}else localStorage.removeItem(document.URL+"_checkpoint")}catch(e){}}function setSectionSolved(e){if(null!=e&&void 0!=e&&"__WIN__"!=e.name&&!(solvedSections.indexOf(e)>=0))try{window.localStorage&&(solvedSections.push(e),localStorage.setItem(document.URL+"_sections",JSON.stringify(solvedSections)))}catch(e){}}function clearLocalStorage(){curlevel=0,curlevelTarget=null,solvedSections=[];try{window.localStorage&&(localStorage.removeItem(document.URL),localStorage.removeItem(document.URL+"_checkpoint"),localStorage.removeItem(document.URL+"_sections"))}catch(e){}}var RandomGen=new RNG,intro_template=["..................................","..................................","..................................","......Puzzle Script Terminal......","..............v 1.6...............","..................................","..................................","..................................",".........insert cartridge.........","..................................","..................................","..................................",".................................."],messagecontainer_template=["..................................","..................................","..................................","..................................","..................................","..................................","..................................","..................................","..................................","..................................","..........X to continue...........","..................................",".................................."],messagecontainer_template_mouse=["..................................","..................................","..................................","..................................","..................................","..................................","..................................","..................................","..................................","..................................","........Click to continue.........","..................................",".................................."],titletemplate_firstgo=["..................................","..................................","..................................","..................................","..................................","..................................","..........#.start game.#..........","..................................","..................................","..................................","..................................","..................................",".................................."],titletemplate_firstgo_selected=["..................................","..................................","..................................","..................................","..................................","..................................","###########.start game.###########","..................................","..................................","..................................","..................................","..................................",".................................."],titletemplate_empty=["..................................","..................................","..................................","..................................","..................................","..................................","..................................","..................................","..................................","..................................","..................................","..................................",".................................."],title_options=[[".............continue.............","...........#.continue.#...........","############.continue.############"],["...........level select...........",".........#.level select.#.........","##########.level select.##########"],[".............settings.............","...........#.settings.#...........","############.settings.############"],[".............new game.............","...........#.new game.#...........","############.new game.############"]],titleImage=[],titleWidth=titletemplate_empty[0].length,titleHeight=titletemplate_empty.length,textMode=!0,titleScreen=!0,titleMode=0,titleSelection=0,titleSelectOptions=2,titleSelected=!1,levelSelectScrollPos=0,introstate={title:"EMPTY GAME",attribution:"increpare",objectCount:2,metadata:[],levels:[],bgcolor:"#000000",fgcolor:"#FFFFFF"},state=introstate,splitMessage=[],loadedLevelSeed=0,sprites=[{color:"#423563",dat:[[1,1,1,1,1],[1,0,0,0,1],[1,0,0,0,1],[1,0,0,0,1],[1,1,1,1,1]]},{color:"#252342",dat:[[0,0,1,0,0],[1,1,1,1,1],[0,0,1,0,0],[0,1,1,1,0],[0,1,0,1,0]]}];loadedCustomFont=!1,tryLoadCustomFont(),generateTitleScreen(),titleMode>0&&(titleSelection=0),canvasResize();var backups=[],restartTarget,messagetext="",zoomscreen=!1,flickscreen=!1,smoothscreen=!1,screenwidth=0,screenheight=0,dirMasksDelta={1:[0,-1],2:[0,1],4:[-1,0],8:[1,0],15:[0,0],16:[0,0],3:[0,0]},dirMaskName={1:"up",2:"down",4:"left",8:"right",15:"?",16:"action",3:"no"},seedsToPlay_CanMove=[],seedsToPlay_CantMove=[];Level.prototype.clone=function(){var e=new Level(this.lineNumber,this.width,this.height,this.layerCount,null,this.section);return e.objects=new Int32Array(this.objects),e},Level.prototype.getCell=function(e){return new BitVec(this.objects.subarray(e*STRIDE_OBJ,e*STRIDE_OBJ+STRIDE_OBJ))},Level.prototype.getCellInto=function(e,t){for(var l=0;l<STRIDE_OBJ;l++)t.data[l]=this.objects[e*STRIDE_OBJ+l];return t},Level.prototype.setCell=function(e,t){for(var l=0;l<t.data.length;++l)this.objects[e*STRIDE_OBJ+l]=t.data[l]};var _movementVecs,_movementVecIndex=0;Level.prototype.getMovements=function(e){var t=_movementVecs[_movementVecIndex];_movementVecIndex=(_movementVecIndex+1)%_movementVecs.length;for(var l=0;l<STRIDE_MOV;l++)t.data[l]=this.movements[e*STRIDE_MOV+l];return t},Level.prototype.setMovements=function(e,t){for(var l=0;l<t.data.length;++l)this.movements[e*STRIDE_MOV+l]=t.data[l]};var ellipsisPattern=["ellipsis"];BitVec.prototype.cloneInto=function(e){for(var t=0;t<this.data.length;++t)e.data[t]=this.data[t];return e},BitVec.prototype.clone=function(){return new BitVec(this.data)},BitVec.prototype.iand=function(e){for(var t=0;t<this.data.length;++t)this.data[t]&=e.data[t]},BitVec.prototype.ior=function(e){for(var t=0;t<this.data.length;++t)this.data[t]|=e.data[t]},BitVec.prototype.iclear=function(e){for(var t=0;t<this.data.length;++t)this.data[t]&=~e.data[t]},BitVec.prototype.ibitset=function(e){this.data[e>>5]|=1<<(31&e)},BitVec.prototype.ibitclear=function(e){this.data[e>>5]&=~(1<<(31&e))},BitVec.prototype.get=function(e){return 0!=(this.data[e>>5]&1<<(31&e))},BitVec.prototype.getshiftor=function(e,t){var l=31&t,a=this.data[t>>5]>>>l;return l&&(a|=this.data[1+(t>>5)]<<32-l),a&e},BitVec.prototype.ishiftor=function(e,t){var l=31&t,a=e<<l;if(this.data[t>>5]|=a,l){var n=e>>32-l;this.data[1+(t>>5)]|=n}},BitVec.prototype.ishiftclear=function(e,t){var l=31&t,a=e<<l;if(this.data[t>>5]&=~a,l){var n=e>>32-(31&t);this.data[1+(t>>5)]&=~n}},BitVec.prototype.equals=function(e){if(this.data.length!==e.data.length)return!1;for(var t=0;t<this.data.length;++t)if(this.data[t]!==e.data[t])return!1;return!0},BitVec.prototype.setZero=function(){for(var e=0;e<this.data.length;++e)this.data[e]=0},BitVec.prototype.iszero=function(){for(var e=0;e<this.data.length;++e)if(this.data[e])return!1;return!0},BitVec.prototype.bitsSetInArray=function(e){for(var t=0;t<this.data.length;++t)if((this.data[t]&e[t])!==this.data[t])return!1;return!0},BitVec.prototype.bitsClearInArray=function(e){for(var t=0;t<this.data.length;++t)if(this.data[t]&e[t])return!1;return!0},BitVec.prototype.anyBitsInCommon=function(e){return!this.bitsClearInArray(e.data)},Rule.prototype.generateCellRowMatchesFunction=function(e,t){if(0==t){for(var l=dirMasksDelta[this.direction],a=l[0],n=l[1],o=e.length,i="var d = "+n+"+"+a+"*level.height;\n",r=1===STRIDE_OBJ?"":"*"+STRIDE_OBJ,s=0;s<STRIDE_OBJ;++s)i+="var cellObjects"+s+" = level.objects[i"+r+(s?"+"+s:"")+"];\n";r=1===STRIDE_MOV?"":"*"+STRIDE_MOV;for(var s=0;s<STRIDE_MOV;++s)i+="var cellMovements"+s+" = level.movements[i"+r+(s?"+"+s:"")+"];\n";i+="return "+e[0].generateMatchString("0_");for(var c=1;c<o;c++)i+="&&cellRow["+c+"].matches((i+"+c+"*d))";return i+=";",i in matchCache?matchCache[i]:matchCache[i]=new Function("cellRow","i",i)}var l=dirMasksDelta[this.direction],a=l[0],n=l[1],o=e.length,i="var d = "+n+"+"+a+"*level.height;\n";i+="var result = [];\n",i+="if(cellRow[0].matches(i)";for(var c=1;e[c]!==ellipsisPattern;c++)i+="&&cellRow["+c+"].matches((i+"+c+"*d))";for(c++,i+=") {\n",i+="\tfor (var k=kmin;k<kmax;k++) {\n",i+="\t\tif(cellRow["+c+"].matches((i+d*(k+"+(c-1)+")))",c++;c<o;c++)i+="&&cellRow["+c+"].matches((i+d*(k+"+(c-1)+")))";return i+="){\n",i+="\t\t\tresult.push([i,k]);\n",i+="\t\t}\n",i+="\t}\n",i+="}\n",i+="return result;",i in matchCache?matchCache[i]:matchCache[i]=new Function("cellRow","i","kmax","kmin",i)},Rule.prototype.toJSON=function(){return[this.direction,this.patterns,this.hasReplacements,this.lineNumber,this.isEllipsis,this.groupNumber,this.isRigid,this.commands,this.isRandom,this.cellRowMasks]};var STRIDE_OBJ=1,STRIDE_MOV=1,matchCache={};CellPattern.prototype.generateMatchString=function(){for(var e="(true",t=0;t<Math.max(STRIDE_OBJ,STRIDE_MOV);++t){var l="cellObjects"+t,a="cellMovements"+t,n=this.objectsPresent.data[t],o=this.objectsMissing.data[t],i=this.movementsPresent.data[t],r=this.movementsMissing.data[t];n&&(e+=n&n-1?"\t\t&& (("+l+"&"+n+")==="+n+")\n":"\t\t&& ("+l+"&"+n+")\n"),o&&(e+="\t\t&& !("+l+"&"+o+")\n"),i&&(e+=i&i-1?"\t\t&& (("+a+"&"+i+")==="+i+")\n":"\t\t&& ("+a+"&"+i+")\n"),r&&(e+="\t\t&& !("+a+"&"+r+")\n")}for(var s=0;s<this.anyObjectsPresent.length;s++){e+="\t\t&& (0";for(var t=0;t<STRIDE_OBJ;++t){var c=this.anyObjectsPresent[s].data[t];c&&(e+="|(cellObjects"+t+"&"+c+")")}e+=")"}return e+="\t)"},CellPattern.prototype.generateMatchFunction=function(){for(var e,t="",l=1===STRIDE_OBJ?"":"*"+STRIDE_OBJ,e=0;e<STRIDE_OBJ;++e)t+="\tvar cellObjects"+e+" = level.objects[i"+l+(e?"+"+e:"")+"];\n";l=1===STRIDE_MOV?"":"*"+STRIDE_MOV;for(var e=0;e<STRIDE_MOV;++e)t+="\tvar cellMovements"+e+" = level.movements[i"+l+(e?"+"+e:"")+"];\n";return t+="return "+this.generateMatchString()+";",t in matchCache?matchCache[t]:matchCache[t]=new Function("i",t)},CellPattern.prototype.toJSON=function(){return[this.movementMask,this.cellMask,this.nonExistenceMask,this.moveNonExistenceMask,this.moveStationaryMask,this.randomDirOrEntityMask,this.movementsToRemove]};var _o1,_o2,_o2_5,_o3,_o4,_o5,_o6,_o7,_o8,_o9,_o10,_o11,_o12,_m1,_m2,_m3;CellPattern.prototype.replace=function(e,t){var l=this.replacement;if(null===l)return!1;var a=l.randomEntityMask,n=l.randomDirMask,o=l.objectsSet.cloneInto(_o1),i=l.objectsClear.cloneInto(_o2),r=l.movementsSet.cloneInto(_m1),s=l.movementsClear.cloneInto(_m2);if(s.ior(l.movementsLayerMask),!a.iszero()){for(var c=[],v=0;v<32*STRIDE_OBJ;v++)a.get(v)&&c.push(v);var u=c[Math.floor(RandomGen.uniform()*c.length)],d=state.idDict[u],m=state.objects[d];o.ibitset(u),i.ior(state.layerMasks[m.layer]),s.ishiftor(31,5*m.layer)}if(!n.iszero())for(var g=0;g<level.layerCount;g++)if(n.get(5*g)){var h=Math.floor(4*RandomGen.uniform());r.ibitset(h+5*g)}var f=level.getCellInto(t,_o2_5),p=level.getMovements(t),S=f.cloneInto(_o3),_=p.cloneInto(_m3);f.iclear(i),f.ior(o),p.iclear(s),p.ior(r);var y=!1,M=0,b=0;if(e.isRigid){var k=state.groupNumber_to_RigidGroupIndex[e.groupNumber];k++;for(var I=new BitVec(STRIDE_MOV),C=0;C<level.layerCount;C++)I.ishiftor(k,5*C);I.iand(l.movementsLayerMask),M=level.rigidGroupIndexMask[t]||new BitVec(STRIDE_MOV),b=level.rigidMovementAppliedMask[t]||new BitVec(STRIDE_MOV),I.bitsSetInArray(M.data)||l.movementsLayerMask.bitsSetInArray(b.data)||(M.ior(I),b.ior(l.movementsLayerMask),y=!0)}var w=!1;if(!S.equals(f)||!_.equals(p)||y){w=!0,y&&(level.rigidGroupIndexMask[t]=M,level.rigidMovementAppliedMask[t]=b);var R=f.cloneInto(_o4);R.iclear(S),sfxCreateMask.ior(R);var O=S.cloneInto(_o5);O.iclear(f),sfxDestroyMask.ior(O),level.setCell(t,f),level.setMovements(t,p);var T=t/level.height|0,P=t%level.height;level.colCellContents[T].ior(f),level.rowCellContents[P].ior(f),level.mapCellContents.ior(f)}return w};var rigidBackups=[];Rule.prototype.findMatches=function(){for(var e=[],t=this.cellRowMasks,l=0;l<this.patterns.length;l++){var a=this.patterns[l],n=this.cellRowMatches[l];if(this.isEllipsis[l])var o=matchCellRowWildCard(this.direction,n,a,t[l]);else var o=matchCellRow(this.direction,n,a,t[l]);if(0===o.length)return[];e.push(o)}return e},Rule.prototype.directional=function(){for(var e=0;e<state.rules.length;e++)for(var t=state.rules[e],l=0,a=0;a<t.length;a++)if(this.lineNumber===t[a].lineNumber&&l++,l>1)return!0;return!1},Rule.prototype.applyAt=function(e,t,l){var a=this;if(l){for(var n=!0,o=0;o<a.patterns.length;o++)if(a.isEllipsis[o]){if(!1===DoesCellRowMatchWildCard(a.direction,a.patterns[o],t[o][0],t[o][1]+1,t[o][1])){n=!1;break}}else if(!1===DoesCellRowMatch(a.direction,a.patterns[o],t[o])){n=!1;break}if(!1===n)return!1}for(var i=!1,r=e[0]*level.height,s=e[1],o=0;o<a.patterns.length;o++)for(var c=a.patterns[o],v=a.isEllipsis[o]?t[o][0]:t[o],u=0;u<c.length;u++){var d=c[u];if(d!==ellipsisPattern)i=d.replace(a,v)||i,v=v+s+r;else{var m=t[o][1];v+=(s+r)*m}}if(verbose_logging&&i){var g=dirMaskName[a.direction];a.directional()||(g="");var h='<font color="green">Rule <a onclick="jumpToLine('+a.lineNumber+');"  href="javascript:void(0);">'+a.lineNumber+"</a> "+g+" applied.</font>";consolePrint(h)}return i},Rule.prototype.tryApply=function(){var e=dirMasksDelta[this.direction],t=this.findMatches();if(0===t.length)return!1;var l=!1;if(this.hasReplacements)for(var a=generateTuples(t),n=0;n<a.length;n++){var o=a[n],i=n>0,r=this.applyAt(e,o,i);l=r||l}return t.length>0&&this.queueCommands(),l},Rule.prototype.queueCommands=function(){for(var e=this.commands,t=0;t<e.length;t++){var l=e[t];if(!(level.commandQueue.indexOf(l[0])>=0)){if(level.commandQueue.push(l[0]),level.commandQueueSourceRules.push(this),verbose_logging){var a=this.lineNumber,n=(dirMaskName[this.direction],'<font color="green">Rule <a onclick="jumpToLine('+a.toString()+');"  href="javascript:void(0);">'+a.toString()+"</a> triggers command "+l[0]+".</font>");consolePrint(n,!0)}"message"===l[0]&&(messagetext=l[1])}}};var sfxCreateMask=null,sfxDestroyMask=null;</script> <script>function logErrorCacheable(e,n,r){if(compiling||r){if(void 0===n)return logErrorNoLine(e);var t='<a onclick="jumpToLine('+n.toString()+');"  href="javascript:void(0);"><span class="errorTextLineNumber"> line '+n.toString()+'</span></a> : <span class="errorText">'+e+"</span>";errorStrings.indexOf(t)>=0&&!r||(consolePrint(t),errorStrings.push(t),errorCount++)}}function logError(e,n,r){if(compiling||r){if(void 0===n)return logErrorNoLine(e,r);var t='<a onclick="jumpToLine('+n.toString()+');"  href="javascript:void(0);"><span class="errorTextLineNumber"> line '+n.toString()+'</span></a> : <span class="errorText">'+e+"</span>";errorStrings.indexOf(t)>=0&&!r||(consolePrint(t,!0),errorStrings.push(t),errorCount++)}}function logWarning(e,n,r){if(compiling||r){if(void 0===n)return logErrorNoLine(e);var t='<a onclick="jumpToLine('+n.toString()+');"  href="javascript:void(0);"><span class="errorTextLineNumber"> line '+n.toString()+'</span></a> : <span class="warningText">'+e+"</span>";errorStrings.indexOf(t)>=0&&!r||(consolePrint(t,!0),errorStrings.push(t))}}function logErrorNoLine(e,n){if(compiling||n){var r='<span class="errorText">'+e+"</span>";errorStrings.indexOf(r)>=0&&!n||(consolePrint(r,!0),errorStrings.push(r)),errorCount++}}function logBetaMessage(e,n){if(compiling||n){var r='<span class="betaText">'+e+"</span>";errorStrings.indexOf(r)>=0&&!n||(consoleError(r),errorStrings.push(r))}}function blankLineHandle(e){"levels"===e.section?e.levels[e.levels.length-1].length>0&&e.levels.push([]):"objects"===e.section&&(e.objects_section=0)}var compiling=!1,errorStrings=[],errorCount=0;"function"!=typeof Object.assign&&function(){Object.assign=function(e){"use strict";if(void 0===e||null===e)throw new TypeError("Cannot convert undefined or null to object");for(var n=Object(e),r=1;r<arguments.length;r++){var t=arguments[r];if(void 0!==t&&null!==t)for(var o in t)t.hasOwnProperty(o)&&(n[o]=t[o])}return n}}();var codeMirrorFn=function(){"use strict";function e(e,n){if(void 0!==e.objects[n])return logError('Object "'+n+'" defined multiple times.',e.lineNumber),"ERROR";for(var r=0;r<e.legend_synonyms.length;r++){var t=e.legend_synonyms[r];t[0]==n&&logError('Name "'+n+'" already in use.',e.lineNumber)}for(var r=0;r<e.legend_aggregates.length;r++){var t=e.legend_aggregates[r];t[0]==n&&logError('Name "'+n+'" already in use.',e.lineNumber)}for(var r=0;r<e.legend_properties.length;r++){var t=e.legend_properties[r];t[0]==n&&logError('Name "'+n+'" already in use.',e.lineNumber)}}var n=["objects","legend","sounds","collisionlayers","rules","winconditions","levels"],r=["sfx0","sfx1","sfx2","sfx3","sfx4","sfx5","sfx6","sfx7","sfx8","sfx9","sfx10","cancel","checkpoint","restart","win","message","again","undo","nosave","quit"],t=/[\w]+\s*/,o=/\d+\b/,s=/(objects|collisionlayers|legend|sounds|rules|winconditions|levels)(?![\w])\s*/i,i=/[\=]+/,a=/[^\(]+/,l=/[ \,]*/,c=/(move|action|create|destroy|cantmove|undo|restart|titlescreen|startgame|cancel|endgame|startlevel|endlevel|showmessage|closemessage|sfx0|sfx1|sfx2|sfx3|sfx4|sfx5|sfx6|sfx7|sfx8|sfx9|sfx10)\s+/i,u=/^(action|up|down|left|right|\^|v|\<|\>|moving|stationary|parallel|perpendicular|horizontal|orthogonal|vertical|no|randomdir|random)$/i,g=/^(startloop|endloop)$/i,d=/^(up|down|left|right|horizontal|vertical|orthogonal|late|rigid)$/i,m=/\s*(up|down|left|right|horizontal|vertical|orthogonal)\s*/i,f=/^(all|any|no|some)$/i,h=["checkpoint","objects","collisionlayers","legend","sounds","rules","...","winconditions","levels","|","[","]","up","down","left","right","late","rigid","^","v",">","<","no","randomdir","random","horizontal","vertical","any","all","no","some","moving","stationary","parallel","perpendicular","action","nosave","message"],p=["title","author","homepage","background_color","text_color","key_repeat_interval","realtime_interval","again_interval","flickscreen","zoomscreen","smoothscreen","color_palette","youtube","sprite_size","level_select_unlocked_ahead","level_select_solve_symbol","custom_font","mouse_left","mouse_drag","mouse_right","mouse_rdrag","mouse_up","mouse_rup"],v=["run_rules_on_level_start","norepeat_action","require_player_movement","debug","verbose_logging","throttle_movement","noundo","noaction","norestart","scanline","case_sensitive","level_select","continue_is_level_select","level_select_lock","settings"];return{copyState:function(e){var n={};for(var r in e.objects)if(e.objects.hasOwnProperty(r)){var t=e.objects[r];n[r]={colors:t.colors.concat([]),lineNumber:t.lineNumber,spritematrix:t.spritematrix.concat([])}}for(var o=[],r=0;r<e.collisionLayers.length;r++)o.push(e.collisionLayers[r].concat([]));for(var s=[],i=[],a=[],l=[],c=[],u=[],r=0;r<e.legend_synonyms.length;r++)s.push(e.legend_synonyms[r].concat([]));for(var r=0;r<e.legend_aggregates.length;r++)i.push(e.legend_aggregates[r].concat([]));for(var r=0;r<e.legend_properties.length;r++)a.push(e.legend_properties[r].concat([]));for(var r=0;r<e.sounds.length;r++)l.push(e.sounds[r].concat([]));for(var r=0;r<e.levels.length;r++)c.push(e.levels[r].concat([]));for(var r=0;r<e.winconditions.length;r++)u.push(e.winconditions[r].concat([]));var g=Object.assign({},e.original_case_names);return{lineNumber:e.lineNumber,objects:n,collisionLayers:o,commentLevel:e.commentLevel,section:e.section,visitedSections:e.visitedSections.concat([]),objects_candname:e.objects_candname,objects_section:e.objects_section,objects_spritematrix:e.objects_spritematrix.concat([]),tokenIndex:e.tokenIndex,currentSection:e.currentSection,legend_synonyms:s,legend_aggregates:i,legend_properties:a,sounds:l,rules:e.rules.concat([]),names:e.names.concat([]),winconditions:u,original_case_names:g,abbrevNames:e.abbrevNames.concat([]),metadata:e.metadata.concat([]),sprite_size:e.sprite_size,case_sensitive:e.case_sensitive,levels:c,STRIDE_OBJ:e.STRIDE_OBJ,STRIDE_MOV:e.STRIDE_MOV}},blankLine:function(e){"levels"===e.section&&e.levels[e.levels.length-1].length>0&&e.levels.push([])},token:function(b,_){function x(e){function n(e){return e.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")}var r;r=_.case_sensitive?new RegExp("\\b"+n(e)+"\\b"):new RegExp("\\b"+n(e)+"\\b","i");var t=E.match(r);null!=t&&(_.original_case_names[e]=t[0])}var E=b.string,y=b.sol();y&&(_.case_sensitive||(b.string=b.string.toLowerCase()),_.tokenIndex=0),b.eatWhile(/[ \t]/);var N=b.peek();if("("===N&&-4!==_.tokenIndex)b.next(),_.commentLevel++;else if(")"===N&&(b.next(),_.commentLevel>0&&0===--_.commentLevel))return"comment";if(_.commentLevel>0){for(;;){if(b.eatWhile(/[^\(\)]+/),b.eol())break;if(N=b.peek(),"("===N?_.commentLevel++:")"===N&&_.commentLevel--,b.next(),0===_.commentLevel)break}return"comment"}if(b.eatWhile(/[ \t]/),y&&b.eol())return blankLineHandle(_);if(y&&b.match(i,!0))return"EQUALSBIT";if(b.match(s,!0)){_.section=b.string.slice(0,b.pos).trim().toLowerCase(),_.visitedSections.indexOf(_.section)>=0&&logError('cannot duplicate sections (you tried to duplicate "'+_.section+'").',_.lineNumber),_.visitedSections.push(_.section);var O=n.indexOf(_.section);if(0==O?(_.objects_section=0,_.visitedSections.length>1&&logError('section "'+_.section+'" must be the first section',_.lineNumber)):-1==_.visitedSections.indexOf(n[O-1])&&(-1===O?logError('no such section as "'+_.section+'".',_.lineNumber):logError('section "'+_.section+'" is out of order, must follow  "'+n[O-1]+'".',_.lineNumber)),"sounds"===_.section){for(var R in _.objects)_.objects.hasOwnProperty(R)&&_.names.push(R);for(var j=0;j<_.legend_synonyms.length;j++){var R=_.legend_synonyms[j][0];_.names.push(R)}for(var j=0;j<_.legend_aggregates.length;j++){var R=_.legend_aggregates[j][0];_.names.push(R)}for(var j=0;j<_.legend_properties.length;j++){var R=_.legend_properties[j][0];_.names.push(R)}}else if("levels"===_.section){for(var R in _.objects)_.objects.hasOwnProperty(R)&&1==R.length&&_.abbrevNames.push(R);for(var j=0;j<_.legend_synonyms.length;j++)1==_.legend_synonyms[j][0].length&&_.abbrevNames.push(_.legend_synonyms[j][0]);for(var j=0;j<_.legend_aggregates.length;j++)1==_.legend_aggregates[j][0].length&&_.abbrevNames.push(_.legend_aggregates[j][0])}return"HEADER"}if(void 0===_.section&&logError('must start with section "OBJECTS"',_.lineNumber),b.eol())return null;switch(_.section){case"objects":var k=function(){var e=y?b.match(t,!0):b.match(/[^\s\()]+\s*/,!0);if(null==e)return b.match(a,!0),b.pos>0&&logWarning('Unknown junk in object section (possibly: the main names for objects have to be words containing only the letters a-z0.9 - if you want to call them something like ",", do it in the legend section).',_.lineNumber),"ERROR";var n=e[0].trim();if(void 0!==_.objects[n])return logError('Object "'+n+'" defined multiple times.',_.lineNumber),"ERROR";for(var r=0;r<_.legend_synonyms.length;r++){_.legend_synonyms[r][0]==n&&logError('Name "'+n+'" already in use.',_.lineNumber)}if(h.indexOf(n)>=0&&logWarning('You named an object "'+n+"\", but this is a keyword. Don't do that!",_.lineNumber),y)_.objects_candname=n,x(n),_.objects[_.objects_candname]={lineNumber:_.lineNumber,colors:[],spritematrix:[],cloneSprite:""};else{if(">"==n[0]&&n.length>1){var o=n.substring(1);if(""!=_.objects[_.objects_candname].cloneSprite)logError("You already assigned a sprite parent for "+o+", you can't have more than one!",_.lineNumber);else{if(o!=_.objects_candname)return _.objects[_.objects_candname].cloneSprite=n.substring(1),_.objects_section=1,"COLOR COLOR-PINK";logError("You attempted to set the sprite parent for "+o+" to "+o+"! Please don't, and keep the recursion in check.",_.lineNumber)}}x(n);var s=[n,_.objects_candname];s.lineNumber=_.lineNumber,_.legend_synonyms.push(s)}if(_.case_sensitive&&("player"==n.toLowerCase()&&"player"!=n||"background"==n.toLowerCase()&&"background"!=n)){var s=[n.toLowerCase(),_.objects_candname];s.lineNumber=_.lineNumber,_.legend_synonyms.push(s)}return _.objects_section=1,"NAME"};switch(y&&2==_.objects_section&&(_.objects_section=3),y&&1==_.objects_section&&(_.objects_section=2),_.objects_section){case 0:case 1:return _.objects_spritematrix=[],k();case 2:b.string=b.string.toLowerCase(),_.tokenIndex=0;var L=b.match(reg_color,!0);if(null==L){var I=b.match(t,!0)||b.match(a,!0);return logError("Was looking for color for object "+_.objects_candname+', got "'+I+'" instead.',_.lineNumber),null}void 0===_.objects[_.objects_candname].colors?_.objects[_.objects_candname].colors=[L[0].trim()]:_.objects[_.objects_candname].colors.push(L[0].trim());var w=L[0].trim().toLowerCase();return w in colorPalettes.arnecolors?"COLOR COLOR-"+w.toUpperCase():"transparent"===w?"COLOR FADECOLOR":"MULTICOLOR"+L[0];case 3:var N=b.eat(/[.\d]/),C=_.objects_spritematrix;if(void 0===N)return 0===C.length?k():(logError("Unknown junk in spritematrix for object "+_.objects_candname+".",_.lineNumber),b.match(a,!0),null);y&&C.push("");var S=_.objects[_.objects_candname];if(C[C.length-1]+=N,C[C.length-1].length>_.sprite_size)return logError("Sprites must be "+_.sprite_size+" wide and "+_.sprite_size+" high.",_.lineNumber),b.match(a,!0),null;if(S.spritematrix=_.objects_spritematrix,C.length===_.sprite_size&&C[C.length-1].length==_.sprite_size&&(_.objects_section=0),"."!==N){var R=parseInt(N);return R>=S.colors.length?(logError("Trying to access color number "+R+" from the color palette of sprite "+_.objects_candname+", but there are only "+S.colors.length+" defined in it.",_.lineNumber),"ERROR"):isNaN(R)?(logError('Invalid character "'+N+'" in sprite for '+_.objects_candname,_.lineNumber),"ERROR"):"COLOR BOLDCOLOR COLOR-"+S.colors[R].toUpperCase()}return"COLOR FADECOLOR";default:window.console.logError("EEK shouldn't get here.")}break;case"sounds":if(y){var T=!0,A=a.exec(b.string)[0].split(/\s/).filter(function(e){return""!==e});A.push(_.lineNumber),_.sounds.push(A)}if(null!==(B=b.match(c,!0)))return"SOUNDVERB";if(null!==(B=b.match(m,!0)))return"DIRECTION";if(null!==(B=b.match(o,!0)))return _.tokenIndex++,"SOUND";if(null!==(B=b.match(/[^\[\|\]\s]*/,!0))){var D=B[0].trim();if(_.names.indexOf(D)>=0)return"NAME"}return B=b.match(a,!0),logError('unexpected sound token "'+B+'".',_.lineNumber),b.match(a,!0),"ERROR";case"collisionlayers":y&&(_.collisionLayers.push([]),_.tokenIndex=0);var M=b.match(t,!0);if(null===M){var z=b.pos;return b.match(l,!0),b.pos==z&&(logError("error detected - unexpected character "+b.peek(),_.lineNumber),b.next()),null}var B=M[0].trim(),W=function(e){if(_.case_sensitive||(e=e.toLowerCase()),e in _.objects)return[e];for(var n=0;n<_.legend_synonyms.length;n++){var r=_.legend_synonyms[n];if(r[0]===e)return W(r[1])}for(var n=0;n<_.legend_aggregates.length;n++){var r=_.legend_aggregates[n];if(r[0]===e)return logError('"'+e+'" is an aggregate (defined using "and"), and cannot be added to a single layer because its constituent objects must be able to coexist.',_.lineNumber),[]}for(var n=0;n<_.legend_properties.length;n++){var r=_.legend_properties[n];if(r[0]===e){return[].concat.apply([],r.slice(1).map(W))}}return logError('Cannot add "'+B+'" to a collision layer; it has not been declared.',_.lineNumber),[]};"background"===B.toLowerCase()?(_.collisionLayers.length>0&&_.collisionLayers[_.collisionLayers.length-1].length>0&&logError("Background must be in a layer by itself.",_.lineNumber),_.tokenIndex=1):0!==_.tokenIndex&&logError("Background must be in a layer by itself.",_.lineNumber);var P=W(B);if(0===_.collisionLayers.length)return logError("no layers found.",_.lineNumber),"ERROR";for(var G=[],j=0;j<P.length;j++)for(var B=P[j],U=0;U<=_.collisionLayers.length-1;U++){var V=_.collisionLayers[U];V.indexOf(B)>=0&&U!=_.collisionLayers.length-1&&G.push(U)}if(G.length>0){for(var Y='Object "'+B+'" included in multiple collision layers ( layers ',j=0;j<G.length;j++)Y+=G[j]+", ";Y+=_.collisionLayers.length-1,logWarning(Y+"). You should fix this!",_.lineNumber)}return _.collisionLayers[_.collisionLayers.length-1]=_.collisionLayers[_.collisionLayers.length-1].concat(P),P.length>0?"NAME":"ERROR";case"legend":if(y){var $=b.string.replace("="," = ");$=a.exec($)[0];var A=$.split(/\s/).filter(function(e){return""!==e}),T=!0;if(A.length>0){var B=A[0];_.case_sensitive||(B=B.toLowerCase()),h.indexOf(B)>=0&&logWarning('You named an object "'+B+"\", but this is a keyword. Don't do that!",_.lineNumber),A.indexOf(B,2)>=2&&(logError("You can't define object "+B+" in terms of itself!",_.lineNumber),T=!1),e(_,B)}if(T)if(A.length<3)T=!1;else if("="!==A[1])T=!1;else if(3===A.length){var K=[A[0],A[2]];_.case_sensitive||(K[1]=K[1].toLowerCase()),K.lineNumber=_.lineNumber,x(A[0]),_.legend_synonyms.push(K)}else if(A.length%2==0)T=!1;else{var F=A[3].toLowerCase();if("and"===F){for(var W=(function(e){if(_.case_sensitive||(e=e.toLowerCase()),e in _.objects)return[e];for(var n=0;n<_.legend_synonyms.length;n++){var r=_.legend_synonyms[n];if(r[0]===e)return W(r[1])}for(var n=0;n<_.legend_aggregates.length;n++){var r=_.legend_aggregates[n];if(r[0]===e)return[].concat.apply([],r.slice(1).map(W))}for(var n=0;n<_.legend_properties.length;n++){var r=_.legend_properties[n];if(r[0]===e)return logError("Cannot define an aggregate (using 'and') in terms of properties (something that uses 'or').",_.lineNumber),T=!1,[e]}return[e]}),j=5;j<A.length;j+=2)if("and"!==A[j].toLowerCase()){T=!1;break}if(T){for(var q=[A[0]].concat(W(A[2])).concat(W(A[4])),j=6;j<A.length;j+=2)q=q.concat(W(A[j]));q.lineNumber=_.lineNumber,x(q[0]),_.legend_aggregates.push(q)}}else if("or"===F){for(var W=(function(e){if(_.case_sensitive||(e=e.toLowerCase()),e in _.objects)return[e];for(var n=0;n<_.legend_synonyms.length;n++){var r=_.legend_synonyms[n];if(r[0]===e)return W(r[1])}for(var n=0;n<_.legend_aggregates.length;n++){var r=_.legend_aggregates[n];r[0]===e&&(logError("Cannot define a property (using 'or') in terms of aggregates (something that uses 'and').",_.lineNumber),T=!1)}for(var n=0;n<_.legend_properties.length;n++){var r=_.legend_properties[n];if(r[0]===e)return[].concat.apply([],r.slice(1).map(W))}return[e]}),j=5;j<A.length;j+=2)if("or"!==A[j].toLowerCase()){T=!1;break}if(T){for(var q=[A[0]].concat(W(A[2])).concat(W(A[4])),j=6;j<A.length;j+=2)_.case_sensitive?q.push(A[j]):q.push(A[j].toLowerCase());q.lineNumber=_.lineNumber,x(q[0]),_.legend_properties.push(q)}}else T=!1}else;if(!1===T)return logError("incorrect format of legend - should be one of A = B, A = B or C ( or D ...), A = B and C (and D ...)",_.lineNumber),b.match(a,!0),"ERROR";_.tokenIndex=0}if(0===_.tokenIndex)return b.match(/[^=]*/,!0),_.tokenIndex++,"NAME";if(1===_.tokenIndex)return b.next(),b.match(/\s*/,!0),_.tokenIndex++,"ASSSIGNMENT";var M=b.match(t,!0);if(null===M)return logError("Something bad's happening in the LEGEND",_.lineNumber),b.match(a,!0),"ERROR";var B=M[0].trim();if(_.tokenIndex%2==0){return!1===function(e){if(_.case_sensitive||(e=e.toLowerCase()),e in _.objects)return!0;for(var n=0;n<_.legend_aggregates.length;n++){var r=_.legend_aggregates[n];if(r[0]===e)return!0}for(var n=0;n<_.legend_properties.length;n++){var r=_.legend_properties[n];if(r[0]===e)return!0}for(var n=0;n<_.legend_synonyms.length;n++){var r=_.legend_synonyms[n];if(r[0]===e)return!0}return!1}(B)?(logError('Cannot reference "'+B+'" in the LEGEND section; it has not been defined yet.',_.lineNumber),_.tokenIndex++,"ERROR"):(_.tokenIndex++,"NAME")}return _.tokenIndex++,"LOGICWORD";case"rules":if(y){var H=a.exec(b.string)[0];_.rules.push([H,_.lineNumber,E]),_.tokenIndex=0}if(-4===_.tokenIndex)return b.skipToEnd(),"MESSAGE";if(b.match(/\s*\-\>\s*/,!0))return"ARROW";if("["===N||"|"===N||"]"===N||"+"===N)return"+"!==N&&(_.tokenIndex=1),b.next(),b.match(/\s*/,!0),"BRACKET";var D=b.match(/[^\[\|\]\s]*/,!0)[0].trim();return 0===_.tokenIndex&&g.exec(D)?"BRACKET":0===_.tokenIndex&&d.exec(D)?(b.match(/\s*/,!0),"DIRECTION"):1===_.tokenIndex&&u.exec(D)?(b.match(/\s*/,!0),"DIRECTION"):_.names.indexOf(D)>=0?y?(logError("Identifiers cannot appear outside of square brackets in rules, only directions can.",_.lineNumber),"ERROR"):(b.match(/\s*/,!0),"NAME"):(D=D.toLowerCase(),"..."===D?"DIRECTION":"rigid"===D?"DIRECTION":"random"===D?"DIRECTION":r.indexOf(D)>=0?("message"===D&&(_.tokenIndex=-4),"COMMAND"):(logError('Name "'+D+'", referred to in a rule, does not exist.',_.lineNumber),"ERROR"));case"winconditions":if(y){var J=a.exec(b.string),Q=J[0].split(/\s/),X=Q.filter(function(e){return""!==e});X.push(_.lineNumber),_.winconditions.push(X),_.tokenIndex=-1}_.tokenIndex++;var Z=b.match(/\s*\w+\s*/);if(null===Z)return logError("incorrect format of win condition.",_.lineNumber),b.match(a,!0),"ERROR";var ee=Z[0].trim();if(0===_.tokenIndex)return f.exec(ee)?"LOGICWORD":"ERROR";if(2===_.tokenIndex)return"on"!=ee.toLowerCase()?"ERROR":"LOGICWORD";if(1===_.tokenIndex||3===_.tokenIndex)return-1===_.names.indexOf(ee)?(logError('Error in win condition: "'+ee+'" is not a valid object name.',_.lineNumber),"ERROR"):"NAME";break;case"levels":if(y){if(b.match(/\s*message\s*/i,!0)){_.tokenIndex=1;var ne=["\n",E.slice(b.pos).trim(),_.lineNumber,_.currentSection];return 0==_.levels[_.levels.length-1].length?_.levels.splice(_.levels.length-1,0,ne):_.levels.push(ne),"MESSAGE_VERB"}if(b.match(/\s*section\s*/i,!0))return _.tokenIndex=3,_.currentSection=E.slice(b.pos).trim(),"SECTION_VERB";var re=b.match(a,!1)[0].trim();_.tokenIndex=2;var te=_.levels[_.levels.length-1];"\n"==te[0]?_.levels.push([_.lineNumber,_.currentSection,re]):(0==te.length&&(te.push(_.lineNumber),te.push(_.currentSection)),te.push(re),te.length>2&&re.length!=te[2].length&&logWarning("Maps must be rectangular, yo (In a level, the length of each row must be the same).",_.lineNumber))}else{if(1==_.tokenIndex)return b.skipToEnd(),"MESSAGE";if(3==_.tokenIndex)return b.skipToEnd(),-1==_.metadata.indexOf("level_select")?(logError("Can't use sections without level_select parameter in preamble",_.lineNumber),"ERROR"):"SECTION"}if(2===_.tokenIndex&&!b.eol()){var N=b.peek();return b.next(),_.abbrevNames.indexOf(N)>=0?"LEVEL":(logError('Key "'+N+'" not found. Do you need to add it to the legend, or define a new object?',_.lineNumber),"ERROR")}break;default:if(y&&(_.tokenIndex=0),0!=_.tokenIndex)return b.match(a,!0),"METADATATEXT";var Z=b.match(/\s*\w+\s*/);if(null!==Z){var oe=Z[0].trim();if(y){if(p.indexOf(oe)>=0){"youtube"!==oe&&"author"!==oe&&"title"!==oe&&"custom_font"!==oe||(b.string=E);var se=b.match(a,!1);return null!=se?"sprite_size"==oe?_.sprite_size=parseInt(se[0].trim(),10):(_.metadata.push(oe),_.metadata.push(se[0].trim())):logError('MetaData "'+oe+'" needs a value.',_.lineNumber),_.tokenIndex=1,"METADATA"}return v.indexOf(oe)>=0?("case_sensitive"==oe&&(_.case_sensitive=!0),_.metadata.push(oe),_.metadata.push("true"),_.tokenIndex=-1,"METADATA"):(logError("Unrecognised stuff in the prelude.",_.lineNumber),"ERROR")}return-1==_.tokenIndex?(logError('MetaData "'+oe+'" has no parameters.',_.lineNumber),"ERROR"):"METADATA"}}return b.eol()?null:b.eol()?void 0:(b.next(),null)},startState:function(){return{objects:{},lineNumber:0,commentLevel:0,section:"",visitedSections:[],objects_candname:"",objects_section:0,objects_spritematrix:[],collisionLayers:[],tokenIndex:0,currentSection:null,legend_synonyms:[],legend_aggregates:[],legend_properties:[],sounds:[],rules:[],names:[],winconditions:[],metadata:[],sprite_size:5,case_sensitive:!1,original_case_names:{},abbrevNames:[],levels:[[]],subsection:""}}}};window.CodeMirror.defineMode("puzzle",codeMirrorFn);</script> <script>"use strict";function isColor(e){return(e=e.trim())in colorPalettes.arnecolors||(!!/^#([0-9A-F]{2}){3,4}$/i.test(e)||(!!/^#([0-9A-F]{3})$/i.test(e)||"transparent"===e))}function colorToHex(e,r){return r=r.trim(),r in e?e[r]:r}function generateSpriteMatrix(e){for(var r=[],t=0;t<e.length;t++){for(var o=[],n=0;n<e.length;n++){var a=e[t].charAt(n);"."==a?o.push(-1):o.push(a)}r.push(o)}return r}function generateExtraMembers(e){0===e.collisionLayers.length&&logError("No collision layers defined.  All objects need to be in collision layers."),e.idDict={};for(var r=0,t=0;t<e.collisionLayers.length;t++)for(var o=0;o<e.collisionLayers[t].length;o++){var n=e.collisionLayers[t][o];if(n in e.objects){var a=e.objects[n];a.layer=t,a.id=r,e.idDict[r]=n,r++}}e.objectCount=r;for(var i=e.collisionLayers.length,s=[],l=0;l<i;l++)s.push(-1);STRIDE_OBJ=0|Math.ceil(e.objectCount/32),STRIDE_MOV=0|Math.ceil(i/5),e.STRIDE_OBJ=STRIDE_OBJ,e.STRIDE_MOV=STRIDE_MOV,debugMode=!1,verbose_logging=!1,throttle_movement=!1,colorPalette=colorPalettes.arnecolors;for(var l=0;l<e.metadata.length;l+=2){var c=e.metadata[l],g=e.metadata[l+1];"color_palette"===c?(g in colorPalettesAliases&&(g=colorPalettesAliases[g]),void 0===colorPalettes[g]?logError('Palette "'+g+'" not found, defaulting to arnecolors.',0):colorPalette=colorPalettes[g]):"debug"===c?(debugMode=!0,cache_console_messages=!0):"verbose_logging"===c?(verbose_logging=!0,cache_console_messages=!0):"throttle_movement"===c&&(throttle_movement=!0)}for(var n in e.objects)if(e.objects.hasOwnProperty(n)){var a=e.objects[n];a.colors.length>10&&logError("a sprite cannot have more than 10 colors.  Why you would want more than 10 is beyond me.",a.lineNumber+1);for(var l=0;l<a.colors.length;l++){var h=a.colors[l];isColor(h)?(h=colorToHex(colorPalette,h),a.colors[l]=h):(logError('Invalid color specified for object "'+n+'", namely "'+a.colors[l]+'".',a.lineNumber+1),a.colors[l]="#ff00ff")}}for(var n in e.objects)if(e.objects.hasOwnProperty(n)){var a=e.objects[n];if(0==a.colors.length&&(logError('color not specified for object "'+n+'".',a.lineNumber),a.colors=["#ff00ff"]),""!==a.cloneSprite)e.objects.hasOwnProperty(a.cloneSprite)?""===e.objects[a.cloneSprite].cloneSprite?a.spritematrix=deepClone(e.objects[a.cloneSprite].spritematrix):logError("The sprite that "+n+" attempted to clone ("+a.cloneSprite+") clones a sprite itself ("+e.objects[a.cloneSprite].cloneSprite+"), so it can't clone the sprite! You'll need to set up the cloning differently.",a.lineNumber):logError(n+" attempted to clone the sprite matrix of "+a.cloneSprite+", but that object doesn't exist?!",a.lineNumber);else if(0===a.spritematrix.length){a.spritematrix=new Array(e.sprite_size);for(var u=new Array(e.sprite_size),l=0;l<e.sprite_size;l++)u[l]=0;for(var l=0;l<e.sprite_size;l++)a.spritematrix[l]=u}else{if(a.spritematrix.length!==e.sprite_size)logWarning("Sprite graphics must be "+e.sprite_size+" wide and "+e.sprite_size+" high exactly.",a.lineNumber);else for(var l=0;l<e.sprite_size;l++)if(a.spritematrix[l].length!==e.sprite_size){logWarning("Sprite graphics must be "+e.sprite_size+" wide and "+e.sprite_size+" high exactly.",a.lineNumber);break}a.spritematrix=generateSpriteMatrix(a.spritematrix)}}var p={};for(var n in e.objects)if(e.objects.hasOwnProperty(n)){var a=e.objects[n],f=s.concat([]);f[a.layer]=a.id,p[n]=f}for(var d=!0;d;){d=!1;for(var l=0;l<e.legend_synonyms.length;l++){var v=e.legend_synonyms[l],c=v[0],g=v[1];c in p&&void 0!==p[c]||void 0===p[g]||(d=!0,p[c]=p[g])}for(var l=0;l<e.legend_aggregates.length;l++){for(var v=e.legend_aggregates[l],c=v[0],m=v.slice(1),b=!0,o=0;o<m.length;o++){if(void 0===p[m[o]]){b=!1;break}}if((!(c in p)||void 0===p[c])&&b){for(var f=s.concat([]),o=1;o<v.length;o++){var n=v[o],a=e.objects[n];if(void 0==a&&logError("Object not found with name "+n,e.lineNumber),-1==f[a.layer])f[a.layer]=a.id;else if(void 0===a.layer)logError('Object "'+n.toUpperCase()+'" has been defined, but not assigned to a layer.',v.lineNumber);else{var y=n.toUpperCase(),w=e.idDict[f[a.layer]].toUpperCase();y!==w&&logError('Trying to create an aggregate object (defined in the legend) with both "'+y+'" and "'+w+"\", which are on the same layer and therefore can't coexist.",v.lineNumber)}}d=!0,p[v[0]]=f}}}e.glyphDict=p;for(var E={},l=0;l<e.legend_aggregates.length;l++){var R=e.legend_aggregates[l];E[R[0]]=R.slice(1)}e.aggregatesDict=E;for(var k={},l=0;l<e.legend_properties.length;l++){var R=e.legend_properties[l];k[R[0]]=R.slice(1)}e.propertiesDict=k;for(var _={},l=0;l<e.legend_synonyms.length;l++){var R=e.legend_synonyms[l],c=R[0],I=R[1];I in E?E[c]=E[I]:I in k?k[c]=k[I]:c!==I&&(_[c]=I)}e.synonymsDict=_;for(var D=!0;D;){D=!1;for(var n in _)if(_.hasOwnProperty(n)){var I=_[n];I in k?(delete _[n],k[n]=k[I],D=!0):I in E?(delete E[n],E[n]=E[I],D=!0):I in _&&(_[n]=_[I])}for(var n in k)if(k.hasOwnProperty(n))for(var x=k[n],l=0;l<x.length;l++){var I=x[l];if(I in _)x[l]=_[I],D=!0;else if(I in k){x.splice(l,1);for(var M=k[I],o=0;o<M.length;o++){var j=M[o];-1===x.indexOf(j)&&x.push(j)}D=!0}I in E&&logError('Trying to define property "'+n.toUpperCase()+'" in terms of aggregate "'+I.toUpperCase()+'".')}for(var n in E)if(E.hasOwnProperty(n))for(var x=E[n],l=0;l<x.length;l++){var I=x[l];if(I in _)x[l]=_[I],D=!0;else if(I in E){x.splice(l,1);for(var M=E[I],o=0;o<M.length;o++){var j=M[o];-1===x.indexOf(j)&&x.push(j)}D=!0}I in k&&logError('Trying to define aggregate "'+n.toUpperCase()+'" in terms of property "'+I.toUpperCase()+'".')}}e.propertiesSingleLayer={};for(var c in k)if(k.hasOwnProperty(c)){for(var x=k[c],S=!0,l=1;l<x.length;l++)if(e.objects[x[l-1]].layer!==e.objects[x[l]].layer){S=!1;break}S&&(e.propertiesSingleLayer[c]=e.objects[x[0]].layer)}void 0===e.idDict[0]&&e.collisionLayers.length>0&&logError("You need to have some objects defined");var N,C;if(void 0===e.objects.background)if("background"in e.synonymsDict){var n=e.synonymsDict.background,a=e.objects[n];N=a.id,C=a.layer}else if("background"in e.propertiesDict){var n=e.propertiesDict.background[0],a=e.objects[n];N=a.id,C=a.layer}else if("background"in e.aggregatesDict){var a=e.objects[e.idDict[0]];N=a.id,C=a.layer,logError("background cannot be an aggregate (declared with 'and'), it has to be a simple type, or property (declared in terms of others using 'or').")}else{var a=e.objects[e.idDict[0]];N=a.id,C=a.layer,logError("you have to define something to be the background")}else N=e.objects.background.id,C=e.objects.background.layer;e.backgroundid=N,e.backgroundlayer=C}function generateExtraMembersPart2(e){function r(r,t){if(r in e.metadata){var o=e.metadata[r]||t,n=null;if(e.objects[o])n=e.objects[o].id;else if(o in e.synonymsDict){var a=e.synonymsDict[o],i=e.objects[a];n=i.id}else{var i=e.objects[e.idDict[1]];n=i.id,logError(o+" object/alias has to be defined")}return n}}if(e.lmbID=r("mouse_left","lmb"),e.rmbID=r("mouse_right","rmb"),e.dragID=r("mouse_drag","drag"),e.rdragID=r("mouse_rdrag","rdrag"),e.lmbupID=r("mouse_up","lmbup"),e.rmbupID=r("mouse_rup","rmbup"),"mouse_obstacle"in e.metadata){var t=e.metadata.mouse_obstacle;t&&(e.obstacleMask=e.objectMasks[t],e.obstacleMask||(logError(t+" object/alias has to be defined."),e.obstacleMask=e.objectMasks.background))}}function levelFromString(e,r){var t=e.backgroundlayer,o=(e.backgroundid,e.layerMasks[t]),n=new Level(r[0],r[2].length,r.length-2,e.collisionLayers.length,null,r[1]);n.objects=new Int32Array(n.width*n.height*STRIDE_OBJ);for(var a=0;a<n.width;a++)for(var i=0;i<n.height;i++){var s=r[i+2].charAt(a);0==s.length&&(s=r[i+2].charAt(r[i+2].length-1));var l=e.glyphDict[s];void 0==l&&(void 0===e.propertiesDict[s]?logError('Error, symbol "'+s+'", used in map, not found.',r[0]+i):logError('Error, symbol "'+s+"\" is defined using 'or', and therefore ambiguous - it cannot be used in a map. Did you mean to define it in terms of 'and'?",r[0]+i));var c=new BitVec(STRIDE_OBJ);l=l.concat([]);for(var g=0;g<n.layerCount;g++)l[g]>=0&&c.ibitset(l[g]);for(var h=0;h<STRIDE_OBJ;++h)n.objects[STRIDE_OBJ*(a*n.height+i)+h]=c.data[h]}for(var u=n.calcBackgroundMask(e),a=0;a<n.n_tiles;a++){var p=n.getCell(a);o.anyBitsInCommon(p)||(p.ior(u),n.setCell(a,p))}return n}function levelsToArray(e){for(var r=e.levels,t=[],o=0;o<r.length;o++){var n=r[o];if(0!=n.length)if("\n"==n[0]){var a={message:n[1],section:n[3]};splitMessage=wordwrap(a.message,intro_template[0].length),splitMessage.length>12&&logWarning("Message too long to fit on screen.",n[2]),t.push(a)}else{var a=levelFromString(e,n);t.push(a)}}e.levels=t}function extractSections(e){for(var r=[],t=null,o=0;o<e.levels.length;o++){var n=e.levels[o];if(n.section!=t){var a={name:n.section,firstLevel:o};"__WIN__"==a.name?e.winSection=a:r.push(a),t=n.section}}e.sections=r}function directionalRule(e){for(var r=0;r<e.lhs.length;r++){var t=e.lhs[r];if(t.length>1)return!0;for(var o=0;o<t.length;o++)for(var n=t[o],a=0;a<n.length;a+=2)if(relativeDirections.indexOf(n[a])>=0)return!0}for(var r=0;r<e.rhs.length;r++){var t=e.rhs[r];if(t.length>1)return!0;for(var o=0;o<t.length;o++)for(var n=t[o],a=0;a<n.length;a+=2)if(relativeDirections.indexOf(n[a])>=0)return!0}return!1}function findIndexAfterToken(e,r,t){e=e.toLowerCase();for(var o=0,n=0;n<=t;n++){var a=r[n].toLowerCase();o=e.indexOf(a,o)+a.length}return o}function processRuleString(e,r,t){var o=e[0],n=e[1],a=e[2];o=o.replace(/\[/g," [ ").replace(/\]/g," ] ").replace(/\|/g," | ").replace(/\-\>/g," -> "),o=o.trim(),"+"===o[0]&&(o=o.substring(0,1)+" "+o.substring(1,o.length));var i=o.split(/\s/).filter(function(e){return""!==e});0==i.length&&logError("Spooky error!  Empty line passed to rule function.",n);var s=0,l=[],c=null,g=[],h=!1,u=!1,p=[],f=[],d=!1,v=!1,m=n,b=[],y=!1;if(1===i.length){if("startloop"===i[0])return _={bracket:1};if("endloop"===i[0])return _={bracket:-1}}-1==i.indexOf("->")&&logError("A rule has to have an arrow in it.  There's no arrow here! Consider reading up about rules - you're clearly doing something weird",n);for(var c=[],w=0;w<i.length;w++){var E=i[w];switch(s){case 0:"+"===E?m===n?(0==t.length&&logError('The "+" symbol, for joining a rule with the group of the previous rule, needs a previous rule to be applied to.'),0!==w&&logError('The "+" symbol, for joining a rule with the group of the previous rule, must be the first symbol on the line '),m=t[t.length-1].groupNumber):logError('Two "+"s ("append to previous rule group" symbol) applied to the same rule.',n):E in directionaggregates?l=l.concat(directionaggregates[E]):"late"===E?d=!0:"rigid"===E?v=!0:"random"===E?y=!0:simpleAbsoluteDirections.indexOf(E)>=0?l.push(E):simpleRelativeDirections.indexOf(E)>=0?logError('You cannot use relative directions ("^v<>") to indicate in which direction(s) a rule applies.  Use absolute directions indicators (Up, Down, Left, Right, Horizontal, or Vertical, for instance), or, if you want the rule to apply in all four directions, do not specify directions',n):"["==E?(0==l.length&&(l=l.concat(directionaggregates.orthogonal)),s=1,w--):logError("The start of a rule must consist of some number of directions (possibly 0), before the first bracket, specifying in what directions to look (with no direction specified, it applies in all four directions).  It seems you've just entered \""+E.toUpperCase()+'".',n);break;case 1:if("["==E)c.length>0&&logError('Error, malformed cell rule - encountered a "["" before previous bracket was closed',n),h=!0,c=[];else if(reg_directions_only.exec(E))c.length%2==1?logError("Error, an item can only have one direction/action at a time, but you're looking for several at once!",n):h?c.push(E):logWarning("Invalid syntax. Directions should be placed at the start of a rule.",n);else if("|"==E)c.length%2==1?logError("In a rule, if you specify a force, it has to act on an object.",n):(g.push(c),c=[]);else if("]"===E)c.length%2==1?"..."===c[0]?logError("Cannot end a rule with ellipses.",n):logError("In a rule, if you specify a force, it has to act on an object.",n):(g.push(c),c=[]),u?f.push(g):p.push(g),g=[],h=!1;else if("->"===E)u&&logError('Error, you can only use "->" once in a rule; it\'s used to separate before and after states.',n),g.length>0?logError('Encountered an unexpected "->" inside square brackets.  It\'s used to separate states, it has no place inside them >:| .',n):u=!0;else if(r.names.indexOf(E)>=0)h?c.length%2==0?(c.push(""),c.push(E)):c.length%2==1&&c.push(E):logWarning("Invalid token "+E.toUpperCase()+". Object names should only be used within cells (square brackets).",n);else if("..."===E)h?(c.push(E),c.push(E)):logWarning("Invalid syntax, ellipses should only be used within cells (square brackets).",n);else if(commandwords.indexOf(E.toLowerCase())>=0)if(!1===u&&logError("Commands cannot appear on the left-hand side of the arrow.",n),"message"===E.toLowerCase()){var R=findIndexAfterToken(a,i,w),k=a.substring(R).trim();""===k&&(k=" "),b.push([E.toLowerCase(),k]),w=i.length}else b.push([E.toLowerCase()]);else logError('Error, malformed cell rule - was looking for cell contents, but found "'+E+'".  What am I supposed to do with this, eh, please tell me that.',n)}}if(p.length!=f.length)b.length>0&&0==f.length||logError("Error, when specifying a rule, the number of matches (square bracketed bits) on the left hand side of the arrow must equal the number on the right",n);else for(var w=0;w<p.length;w++)p[w].length!=f[w].length&&logError("In a rule, each pattern to match on the left must have a corresponding pattern on the right of equal length (number of cells).",n),0==p[w].length&&logError("You have an totally empty pattern on the left-hand side.  This will match *everything*.  You certainly don't want this.");0==p.length&&logError("This rule refers to nothing.  What the heck? :O",n);var _={directions:l,lhs:p,rhs:f,lineNumber:n,late:d,rigid:v,groupNumber:m,commands:b,randomRule:y};!1===directionalRule(_)&&(_.directions=["up"]);for(var w=0;w<b.length;w++){var I=b[w][0];"restart"===I?(b.length>1||f.length>0)&&logError("The RESTART command can only appear by itself on the right hand side of the arrow.",n):"cancel"===I&&(b.length>1||f.length>0)&&logError("The CANCEL command can only appear by itself on the right hand side of the arrow.",n)}return _}function deepCloneHS(e){return e.map(function(e){return e.map(function(e){return e.slice()})})}function deepCloneRule(e){return{direction:e.direction,lhs:deepCloneHS(e.lhs),rhs:deepCloneHS(e.rhs),lineNumber:e.lineNumber,late:e.late,rigid:e.rigid,groupNumber:e.groupNumber,commands:e.commands,randomRule:e.randomRule}}function rulesToArray(e){for(var r=e.rules,t=[],o=[],n=0;n<r.length;n++){var a=r[n][1],i=processRuleString(r[n],e,t);void 0===i.bracket?t.push(i):o.push([a,i.bracket])}e.loops=o;for(var s=[],n=0;n<t.length;n++)for(var l=t[n],c=l.directions,g=0;g<c.length;g++){var h=c[g];if(h in directionaggregates&&directionalRule(l))for(var u=directionaggregates[h],p=0;p<u.length;p++){var f=deepCloneRule(l);f.direction=u[p],s.push(f)}else{var f=deepCloneRule(l);f.direction=h,s.push(f)}}for(var n=0;n<s.length;n++){var l=s[n];convertRelativeDirsToAbsolute(l),rewriteUpLeftRules(l),atomizeAggregates(e,l),rephraseSynonyms(e,l)}for(var d=[],n=0;n<s.length;n++){var l=s[n];d=d.concat(concretizeMovingRule(e,l,l.lineNumber))}for(var v=[],n=0;n<d.length;n++){var l=d[n];v=v.concat(concretizePropertyRule(e,l,l.lineNumber))}e.rules=v}function containsEllipsis(e){for(var r=0;r<e.lhs.length;r++)for(var t=0;t<e.lhs[r].length;t++)if("..."===e.lhs[r][t][1])return!0;return!1}function rewriteUpLeftRules(e){if(!containsEllipsis(e)){if("up"==e.direction)e.direction="down";else{if("left"!=e.direction)return;e.direction="right"}for(var r=0;r<e.lhs.length;r++)e.lhs[r].reverse(),e.rhs.length>0&&e.rhs[r].reverse()}}function getPropertiesFromCell(e,r){for(var t=[],o=0;o<r.length;o+=2){var n=r[o],a=r[o+1];"random"!=n&&(a in e.propertiesDict&&t.push(a))}return t}function getMovings(e,r){for(var t=[],o=0;o<r.length;o+=2){var n=r[o],a=r[o+1];n in directionaggregates&&t.push([a,n])}return t}function concretizePropertyInCell(e,r,t){for(var o=0;o<e.length;o+=2)e[o+1]===r&&"random"!==e[o]&&(e[o+1]=t)}function concretizeMovingInCell(e,r,t,o){for(var n=0;n<e.length;n+=2)e[n]===r&&e[n+1]===t&&(e[n]=o)}function concretizeMovingInCellByAmbiguousMovementName(e,r,t){for(var o=0;o<e.length;o+=2)e[o]===r&&(e[o]=t)}function expandNoPrefixedProperties(e,r){for(var t=[],o=0;o<r.length;o+=2){var n=r[o],a=r[o+1];if("no"===n&&a in e.propertiesDict)for(var i=e.propertiesDict[a],s=0;s<i.length;s++){var l=i[s];t.push(n),t.push(l)}else t.push(n),t.push(a)}return t}function concretizePropertyRule(e,r,t){for(var o=0;o<r.lhs.length;o++)for(var n=r.lhs[o],a=0;a<n.length;a++)n[a]=expandNoPrefixedProperties(e,n[a]),r.rhs.length>0&&(r.rhs[o][a]=expandNoPrefixedProperties(e,r.rhs[o][a]));for(var i={},a=0;a<r.rhs.length;a++)for(var s=r.lhs[a],l=r.rhs[a],c=0;c<l.length;c++)for(var g=getPropertiesFromCell(e,s[c]),h=getPropertiesFromCell(e,l[c]),u=0;u<h.length;u++){var p=h[u];-1==g.indexOf(p)&&(i[p]=!0)}for(var f,d=[r],v=!0;v;){v=!1;for(var o=0;o<d.length;o++){var m=d[o];f=!1;for(var a=0;a<m.lhs.length&&!f;a++)for(var b=m.lhs[a],c=0;c<b.length&&!f;c++)for(var y=b[c],w=getPropertiesFromCell(e,y),u=0;u<w.length;++u){var p=w[u];if(!e.propertiesSingleLayer.hasOwnProperty(p)||!0===i[p]){var E=e.propertiesDict[p];f=!0,v=!0;for(var R=0;R<E.length;R++){var k=E[R],_=deepCloneRule(m);_.propertyReplacement={};for(var I in m.propertyReplacement)if(m.propertyReplacement.hasOwnProperty(I)){var D=m.propertyReplacement[I];_.propertyReplacement[I]=[D[0],D[1]]}concretizePropertyInCell(_.lhs[a][c],p,k),_.rhs.length>0&&concretizePropertyInCell(_.rhs[a][c],p,k),void 0===_.propertyReplacement[p]?_.propertyReplacement[p]=[k,1]:_.propertyReplacement[p][1]=_.propertyReplacement[p][1]+1,d.push(_)}break}}f&&(d.splice(o,1),o--)}}for(var o=0;o<d.length;o++){var m=d[o];if(void 0!==m.propertyReplacement)for(var p in m.propertyReplacement)if(m.propertyReplacement.hasOwnProperty(p)){var x=m.propertyReplacement[p],k=x[0],M=x[1];if(1===M)for(var a=0;a<m.rhs.length;a++)for(var j=m.rhs[a],c=0;c<j.length;c++){var S=j[c];concretizePropertyInCell(S,p,k)}}}for(var N="",o=0;o<d.length;o++){var m=d[o];delete d.propertyReplacement;for(var a=0;a<m.rhs.length;a++)for(var b=m.rhs[a],c=0;c<b.length;c++)for(var y=b[c],w=getPropertiesFromCell(e,y),u=0;u<w.length;u++)i.hasOwnProperty(w[u])&&(N=w[u])}return N.length>0&&logError('This rule has a property on the right-hand side, "'+N.toUpperCase()+"\", that can't be inferred from the left-hand side.  (either for every property on the right there has to be a corresponding one on the left in the same cell, OR, if there's a single occurrence of a particular property name on the left, all properties of the same name on the right are assumed to be the same).",t),d}function concretizeMovingRule(e,r,t){for(var o,n=[r],a=!0;a;){a=!1;for(var i=0;i<n.length;i++){var s=n[i];o=!1;for(var l=0;l<s.lhs.length;l++)for(var c=s.lhs[l],g=0;g<c.length;g++){var h=c[g],u=getMovings(e,h);if(u.length>0){o=!0,a=!0;for(var p=u[0][0],f=u[0][1],d=directionaggregates[f],v=0;v<d.length;v++){var m=d[v],b=deepCloneRule(s);b.movingReplacement={};for(var y in s.movingReplacement)if(s.movingReplacement.hasOwnProperty(y)){var w=s.movingReplacement[y];b.movingReplacement[y]=[w[0],w[1],w[2]]}concretizeMovingInCell(b.lhs[l][g],f,p,m),b.rhs.length>0&&concretizeMovingInCell(b.rhs[l][g],f,p,m),void 0===b.movingReplacement[p]?b.movingReplacement[p]=[m,1,f]:b.movingReplacement[p][1]=b.movingReplacement[p][1]+1,n.push(b)}}}o&&(n.splice(i,1),i--)}}for(var i=0;i<n.length;i++){var s=n[i];if(void 0!==s.movingReplacement){var E={};for(var p in s.movingReplacement)if(s.movingReplacement.hasOwnProperty(p)){var R=s.movingReplacement[p],k=R[0],_=R[1],I=R[2];if(E[I]=I in E||1!==_?"INVALID":k,1===_)for(var l=0;l<s.rhs.length;l++)for(var D=s.rhs[l],g=0;g<D.length;g++){var x=D[g];concretizeMovingInCell(x,I,p,k)}}for(var I in E)if(E.hasOwnProperty(I)&&"INVALID"!==I){if("INVALID"===(k=E[I]))continue;for(var l=0;l<s.rhs.length;l++)for(var D=s.rhs[l],g=0;g<D.length;g++){var x=D[g];concretizeMovingInCellByAmbiguousMovementName(x,I,k)}}}}for(var M="",i=0;i<n.length;i++){var s=n[i];delete n.movingReplacement;for(var l=0;l<s.rhs.length;l++)for(var c=s.rhs[l],g=0;g<c.length;g++){var h=c[g],u=getMovings(e,h);u.length>0&&(M=u[0][1])}}return M.length>0&&logError('This rule has an ambiguous movement on the right-hand side, "'+M+"\", that can't be inferred from the left-hand side.  (either for every ambiguous movement associated to an entity on the right there has to be a corresponding one on the left attached to the same entity, OR, if there's a single occurrence of a particular ambiguous movement on the left, all properties of the same movement attached to the same object on the right are assumed to be the same (or something like that)).",t),n}function rephraseSynonyms(e,r){for(var t=0;t<r.lhs.length;t++)for(var o=r.lhs[t],n=r.rhs[t],a=0;a<o.length;a++){for(var i=o[a],s=1;s<i.length;s+=2){var l=i[s];l in e.synonymsDict&&(i[s]=e.synonymsDict[i[s]])}if(r.rhs.length>0)for(var c=n[a],s=1;s<c.length;s+=2){var l=c[s];l in e.synonymsDict&&(c[s]=e.synonymsDict[c[s]])}}}function atomizeAggregates(e,r){for(var t=0;t<r.lhs.length;t++)for(var o=r.lhs[t],n=0;n<o.length;n++){var a=o[n];atomizeCellAggregates(e,a,r.lineNumber)}for(var t=0;t<r.rhs.length;t++)for(var o=r.rhs[t],n=0;n<o.length;n++){var a=o[n];atomizeCellAggregates(e,a,r.lineNumber)}}function atomizeCellAggregates(e,r,t){for(var o=0;o<r.length;o+=2){var n=r[o],a=r[o+1];if(a in e.aggregatesDict){"no"===n&&logError("You cannot use 'no' to exclude the aggregate object "+a.toUpperCase()+" (defined using 'AND'), only regular objects, or properties (objects defined using 'OR').  If you want to do this, you'll have to write it out yourself the long way.",t);var i=e.aggregatesDict[a];r[o+1]=i[0];for(var s=1;s<i.length;s++)r.push(r[o]),r.push(i[s])}}}function convertRelativeDirsToAbsolute(e){for(var r=e.direction,t=0;t<e.lhs.length;t++)for(var o=e.lhs[t],n=0;n<o.length;n++){var a=o[n];absolutifyRuleCell(r,a)}for(var t=0;t<e.rhs.length;t++)for(var o=e.rhs[t],n=0;n<o.length;n++){var a=o[n];absolutifyRuleCell(r,a)}}function absolutifyRuleCell(e,r){for(var t=0;t<r.length;t+=2){var o=r[t],n=relativeDirs.indexOf(o);n>=0&&(r[t]=relativeDict[e][n])}}function rulesToMask(e){for(var r=e.collisionLayers.length,t=[],o=0;o<r;o++)t.push(null);for(var o=0;o<e.rules.length;o++)for(var n=e.rules[o],a=0;a<n.lhs.length;a++)for(var i=n.lhs[a],s=n.rhs[a],l=0;l<i.length;l++){for(var c=i[l],g=t.concat([]),h=new BitVec(STRIDE_OBJ),u=new BitVec(STRIDE_OBJ),p=[],f=new BitVec(STRIDE_MOV),d=new BitVec(STRIDE_MOV),v=new BitVec(STRIDE_MOV),m=0;m<c.length;m+=2){var b=c[m];if("..."===b){if(h=ellipsisPattern,2!==c.length)logError("You can't have anything in with an ellipsis. Sorry.",n.lineNumber);else if(0===l||l===i.length-1)logError("There's no point in putting an ellipsis at the very start or the end of a rule",n.lineNumber);else if(n.rhs.length>0){var y=s[l];2===y.length&&"..."===y[0]||logError("An ellipsis on the left must be matched by one in the corresponding place on the right.",n.lineNumber)}break}if("random"!==b){var w=c[m+1],E=e.objects[w],R=e.objectMasks[w];if(E)var k=0|E.layer;else var k=e.propertiesSingleLayer[w];if(void 0===k&&logError("Oops!  "+w.toUpperCase()+" not assigned to a layer.",n.lineNumber),"no"===b)u.ior(R);else{var _=g[k];null!==_&&logError("Rule matches object types that can't overlap: \""+w.toUpperCase()+'" and "'+_.toUpperCase()+'".',n.lineNumber),g[k]=w,E?(h.ior(R),v.ishiftor(31,5*k)):p.push(R),"stationary"===b?d.ishiftor(31,5*k):f.ishiftor(dirMasks[b],5*k)}}else logError("'random' cannot be matched on the left-hand side, it can only appear on the right",n.lineNumber)}if(n.rhs.length>0){var y=s[l],I=i[l];"..."===y[0]&&"..."!==I[0]&&logError("An ellipsis on the right must be matched by one in the corresponding place on the left.",n.lineNumber);for(var m=0;m<y.length;m+=2){var D=y[m];"..."===D&&2!==y.length&&logError("You can't have anything in with an ellipsis. Sorry.",n.lineNumber)}}if(h!==ellipsisPattern){if(i[l]=new CellPattern([h,u,p,f,d,null]),0!==n.rhs.length){for(var x=s[l],M=t.concat([]),j=t.concat([]),S=new BitVec(STRIDE_OBJ),N=new BitVec(STRIDE_OBJ),C=new BitVec(STRIDE_MOV),O=new BitVec(STRIDE_MOV),P=new BitVec(STRIDE_MOV),T=new BitVec(STRIDE_OBJ),L=new BitVec(STRIDE_MOV),z=new BitVec(STRIDE_MOV),m=0;m<x.length;m+=2){var b=x[m],w=x[m+1];if("..."===b)break;if("random"!==b){var E=e.objects[w],R=e.objectMasks[w];if(E)var k=0|E.layer;else var k=e.propertiesSingleLayer[w];if("no"==b)S.ior(R);else{var _=M[k];null===_&&(_=j[k]),null!==_&&logError("Rule matches object types that can't overlap: \""+w.toUpperCase()+'" and "'+_.toUpperCase()+'".',n.lineNumber),M[k]=w,b.length>0&&L.ishiftor(31,5*k);var A=e.layerMasks[k];E&&(N.ibitset(E.id),S.ior(A),P.ishiftor(31,5*k)),"stationary"===b&&C.ishiftor(31,5*k),"randomdir"===b?z.ishiftor(dirMasks[b],5*k):O.ishiftor(dirMasks[b],5*k)}}else if(w in e.objectMasks){var B=e.objectMasks[w];T.ior(B);var V;V=e.propertiesDict.hasOwnProperty(w)?e.propertiesDict[w]:[w];for(var U=0;U<V.length;U++){var F=V[U],k=0|e.objects[F].layer,_=M[k];if(null!==_){var J=F.toUpperCase(),W=_.toUpperCase();J!==W&&logWarning("This rule may try to spawn a "+J+" with random, but also requires a "+W+" be here, which is on the same layer - they shouldn't be able to coexist!",n.lineNumber)}j[k]=F}}else logError('You want to spawn a random "'+w.toUpperCase()+"\", but I don't know how to do that",n.lineNumber)}h.bitsSetInArray(N.data)||S.ior(h),f.bitsSetInArray(O.data)||C.ior(f);for(var m=0;m<r;m++)null!==g[m]&&null===M[m]&&(S.ior(e.layerMasks[m]),L.ishiftor(31,5*m));v.iclear(P),L.ior(v),(S||N||C||O||L)&&(i[l].replacement=new CellReplacement([S,N,C,O,L,T,z]))}}else i[l]=ellipsisPattern}}function cellRowMasks(e){for(var r=[],t=e[1],o=0;o<t.length;o++){for(var n=t[o],a=new BitVec(STRIDE_OBJ),i=0;i<n.length;i++)n[i]!==ellipsisPattern&&a.ior(n[i].objectsPresent);r.push(a)}return r}function collapseRules(e){for(var r=0;r<e.length;r++)for(var t=e[r],o=0;o<t.length;o++){for(var n=t[o],a=[0,[],n.rhs.length>0,n.lineNumber],i=[],s=0;s<n.lhs.length;s++)i.push(!1);a[0]=dirMasks[n.direction];for(var s=0;s<n.lhs.length;s++){for(var l=n.lhs[s],c=0;c<l.length;c++)l[c]===ellipsisPattern&&(i[s]&&logError("You can't use two ellipses in a single cell match pattern.  If you really want to, please implement it yourself and send me a patch :) ",n.lineNumber),i[s]=!0);a[1][s]=l}a.push(i),a.push(n.groupNumber),a.push(n.rigid),a.push(n.commands),a.push(n.randomRule),a.push(cellRowMasks(a)),t[o]=new Rule(a)}matchCache={}}function ruleGroupRandomnessTest(e){if(0!==e.length)for(var r=e[0].lineNumber,t=1;t<e.length;t++){var o=e[t];o.lineNumber!==r&&(o.randomRule&&logError("A rule-group can only be marked random by the first rule",o.lineNumber))}}function arrangeRulesByGroupNumber(e){for(var r={},t={},o=0;o<e.rules.length;o++){var n=e.rules[o],a=r;n.late&&(a=t),void 0==a[n.groupNumber]&&(a[n.groupNumber]=[]),a[n.groupNumber].push(n)}var i=[];for(var s in r)if(r.hasOwnProperty(s)){var l=r[s];ruleGroupRandomnessTest(l),i.push(l)}var c=[];for(var s in t)if(t.hasOwnProperty(s)){var l=t[s];ruleGroupRandomnessTest(l),c.push(l)}e.rules=i,e.lateRules=c}function checkNoLateRulesHaveMoves(e){for(var r=0;r<e.lateRules.length;r++)for(var t=e.lateRules[r],o=0;o<t.length;o++)for(var n=t[o],a=0;a<n.patterns.length;a++)for(var i=n.patterns[a],s=0;s<i.length;s++){var l=i[s];if(l!==ellipsisPattern){var c=l.movementsMissing,g=l.movementsPresent;if(!c.iszero()||!g.iszero())return void logError("Movements cannot appear in late rules.",n.lineNumber);if(null!=l.replacement){var h=l.replacement.movementsClear,u=l.replacement.movementsSet;if(!h.iszero()||!u.iszero())return void logError("Movements cannot appear in late rules.",n.lineNumber)}}}}function generateRigidGroupList(e){for(var r=[],t=[],o=[],n=[],a=[],i=0;i<e.rules.length;i++){for(var s=e.rules[i],l=!1,c=0;c<s.length;c++){s[c].isRigid&&(l=!0)}if(a[i]=l,l){var g=s[0].groupNumber;o[g]=i;var h=r.length;t[i]=h,n[g]=h,r.push(i)}}r.length>60&&logError("There can't be more than 60 rigid groups (rule groups containing rigid members).",rules[0][0][3]),e.rigidGroups=a,e.rigidGroupIndex_to_GroupIndex=r,e.groupNumber_to_RigidGroupIndex=n,e.groupIndex_to_RigidGroupIndex=t}function getMaskFromName(e,r){var t=new BitVec(STRIDE_OBJ);if(r in e.objects){var o=e.objects[r];t.ibitset(o.id)}if(r in e.aggregatesDict)for(var n=e.aggregatesDict[r],a=0;a<n.length;a++){var i=n[a],o=e.objects[i];t.ibitset(o.id)}if(r in e.propertiesDict)for(var n=e.propertiesDict[r],a=0;a<n.length;a++){var i=n[a],o=e.objects[i];t.ibitset(o.id)}if(r in e.synonymsDict){var i=e.synonymsDict[r],o=e.objects[i];t.ibitset(o.id)}return!e.metadata.includes("nokeyboard")&&t.iszero()&&logErrorNoLine("error, didn't find any object called player, either in the objects section, or the legends section. there must be a player!"),t}function generateMasks(e){e.playerMask=getMaskFromName(e,"player");for(var r=[],t=e.collisionLayers.length,o=0;o<t;o++){for(var n=new BitVec(STRIDE_OBJ),a=0;a<e.objectCount;a++){var i=e.idDict[a],s=e.objects[i];s.layer==o&&n.ibitset(s.id)}r.push(n)}e.layerMasks=r;var l={};for(var i in e.objects)if(e.objects.hasOwnProperty(i)){var s=e.objects[i];l[i]=new BitVec(STRIDE_OBJ),l[i].ibitset(s.id)}var c=e.legend_synonyms.concat(e.legend_properties);c.sort(function(e,r){return e.lineNumber-r.lineNumber});for(var g=0;g<c.length;g++){var h=c[g];if(2==h.length)l[h[0]]=l[h[1]];else{for(var u=new BitVec(STRIDE_OBJ),a=1;a<h.length;a++){var i=h[a];u.ior(l[i])}l[h[0]]=u}}e.objectMasks=l}function checkObjectsAreLayered(e){for(var r in e.objects)if(e.objects.hasOwnProperty(r)){for(var t=!1,o=0;o<e.collisionLayers.length;o++){for(var n=e.collisionLayers[o],a=0;a<n.length;a++)if(n[a]===r){t=!0;break}if(t)break}if(!1===t){var i=e.objects[r];logError('Object "'+r.toUpperCase()+'" has been defined, but not assigned to a layer.',i.lineNumber)}}}function twiddleMetaData(e){for(var r={},t=0;t<e.metadata.length;t+=2){var o=e.metadata[t],n=e.metadata[t+1];r[o]=n}if(void 0!==r.flickscreen){var n=r.flickscreen,a=n.split("x"),i=[parseInt(a[0]),parseInt(a[1])];r.flickscreen=i}if(void 0!==r.zoomscreen){var n=r.zoomscreen,a=n.split("x"),i=[parseInt(a[0]),parseInt(a[1])];r.zoomscreen=i}if(void 0!==r.smoothscreen){var n=r.smoothscreen,s=n.split(/\s+/),l=!0;s.length<1?(logErrorNoLine("smoothscreen given no arguments but expects at least 1: smoothscreen [flick] WxH [IxJ] [S]"),l=!1):s.length>4&&(logErrorNoLine("smoothscreen given "+s.length+" arguments but expects at most 4: smoothscreen [flick] WxH [IxJ] [S]"),l=!1);const c={screenSize:{width:0,height:0},boundarySize:{width:1,height:1},cameraSpeed:.125,flick:!1};"flick"===s[0]&&(c.flick=!0,s.shift());const g=s[0].match(/^(?<width>\d+)x(?<height>\d+)$/);if(g?(c.screenSize.width=parseInt(g.groups.width),c.screenSize.height=parseInt(g.groups.height),c.flick&&(c.boundarySize.width=c.screenSize.width,c.boundarySize.height=c.screenSize.height)):(logErrorNoLine("smoothscreen given first argument "+s[0]+" but must be formatted WxH where W and H are integers"),l=!1),s.length>1){const h=s[1].match(/^(?<width>\d+)x(?<height>\d+)$/);h?(c.boundarySize.width=parseInt(h.groups.width),c.boundarySize.height=parseInt(h.groups.height)):(logErrorNoLine("smoothscreen given second argument "+s[1]+" but must be formatted IxJ where I and J are integers"),l=!1)}if(s.length>2){const u=s[2].match(/^(?<speed>\d+(\.\d+)?)$/);u?c.cameraSpeed=parseFloat(u.groups.speed):(logErrorNoLine("smoothscreen given third argument "+s[2]+" but must be a number"),l=!1)}l?r.smoothscreen=c:delete r.smoothscreen}e.metadata=r}function processWinConditions(e){for(var r=[],t=0;t<e.winconditions.length;t++){var o=e.winconditions[t];if(0==o.length)return;var n=0;switch(o[0].toLowerCase()){case"no":n=-1;break;case"all":n=1}var a,i=o[o.length-1],s=o[1];a=5==o.length?o[3]:"background";var l=0,c=0
;s in e.objectMasks?l=e.objectMasks[s]:logError('unwelcome term "'+s+'" found in win condition. Win conditions objects have to be objects or properties (defined using "or", in terms of other properties)',i),a in e.objectMasks?c=e.objectMasks[a]:logError('unwelcome term "'+a+'" found in win condition. Win conditions objects have to be objects or properties (defined using "or", in terms of other properties)',i);var g=[n,l,c,i];r.push(g)}e.winconditions=r}function printCellRow(e){for(var r="[ ",t=0;t<e.length;t++){t>0&&(r+="| ");for(var o=e[t],n=0;n<o.length;n+=2){var a=o[n],i=o[n+1];r+="..."===a?a+" ":a+" "+i+" "}}return r+="] "}function printRule(e){var r="(<a onclick=\"jumpToLine('"+e.lineNumber.toString()+'\');"  href="javascript:void(0);">'+e.lineNumber+"</a>) "+e.direction.toString().toUpperCase()+" ";e.rigid&&(r="RIGID "+r+" "),e.randomRule&&(r="RANDOM "+r+" "),e.late&&(r="LATE "+r+" ");for(var t=0;t<e.lhs.length;t++){var o=e.lhs[t];r+=printCellRow(o)}r+="-> ";for(var t=0;t<e.rhs.length;t++){var o=e.rhs[t];r+=printCellRow(o)}for(var t=0;t<e.commands.length;t++){var n=e.commands[t];1===n.length?r+=n[0].toString():r=r+"("+n[0].toString()+", "+n[1].toString()+") "}return r}function printRules(e){for(var r="<br>Rule Assembly : ("+e.rules.length+" rules )<br>===========<br>",t=0,o=-1,n=0;n<e.rules.length;n++){var a=e.rules[n];t<e.loops.length&&e.loops[t][0]<a.lineNumber&&(r+="STARTLOOP<br>",++t<e.loops.length&&(o=e.loops[t][0],t++)),-1!==o&&o<a.lineNumber&&(r+="ENDLOOP<br>",o=-1),r+=printRule(a)+"<br>"}-1!==o&&(r+="ENDLOOP<br>"),r+="===========<br>",consolePrint(r)}function removeDuplicateRules(e){for(var r={},t=-1,o=e.rules.length-1;o>=0;o--){var n=e.rules[o],a=n.groupNumber;a!==t&&(r={});var i=printRule(n);r.hasOwnProperty(i)?e.rules.splice(o,1):r[i]=!0,t=a}}function generateLoopPoints(e){var r={},t=!0,o=0,n=0;e.loops.length%2==1&&logErrorNoLine("have to have matching number of  'startLoop' and 'endLoop' loop points.");for(var a=0;a<e.loops.length;a++)for(var i=e.loops[a],s=0;s<e.rules.length;s++){var l=e.rules[s],c=l[0],g=l[l.length-1],h=c.lineNumber;g.lineNumber;if(t){if(h>=i[0]){n=s,t=!1,-1===i[1]&&logErrorNoLine("Need have to have matching number of  'startLoop' and 'endLoop' loop points.");break}}else if(h>=i[0]){o=s-1,r[o]=n,t=!0,1===i[1]&&logErrorNoLine("Need have to have matching number of  'startLoop' and 'endLoop' loop points.");break}}if(!1===t){var o=e.rules.length;r[o]=n}e.loopPoint=r,r={},t=!0;for(var a=0;a<e.loops.length;a++)for(var i=e.loops[a],s=0;s<e.lateRules.length;s++){var l=e.lateRules[s],c=l[0],g=l[l.length-1],h=c.lineNumber;g.lineNumber;if(t){if(h>=i[0]){n=s,t=!1,-1===i[1]&&logErrorNoLine("Need have to have matching number of  'startLoop' and 'endLoop' loop points.");break}}else if(h>=i[0]){o=s-1,r[o]=n,t=!0,1===i[1]&&logErrorNoLine("Need have to have matching number of  'startLoop' and 'endLoop' loop points.");break}}if(!1===t){var o=e.lateRules.length;r[o]=n}e.lateLoopPoint=r}function validSeed(e){return null!==/^\s*\d+\s*$/.exec(e)}function generateSoundData(e){for(var r={},t=[],o=[],n=[],a=[],i=0;i<e.sounds.length;i++){var s=e.sounds[i];if(!(s.length<=1)){var l=s[s.length-1];if(2!==s.length)if(soundEvents.indexOf(s[0])>=0){s.length>4&&logError("too much stuff to define a sound event.",l);var c=s[1];validSeed(c)?(void 0!==r[s[0]]&&logWarning(s[0].toUpperCase()+" already declared.",l),r[s[0]]=s[1]):logError('Expecting sfx data, instead found "'+s[1]+'".',l)}else{var g=s[0].trim(),h=s[1].trim(),u=s.slice(2,s.length-2);u.length>0&&"move"!==h&&"cantmove"!==h&&logError("incorrect sound declaration.",l),"action"===h&&(h="move",u=["___action____"]),0==u.length&&(u=["orthogonal"]);var c=s[s.length-2];g in e.aggregatesDict?logError('cannot assign sound events to aggregate objects (declared with "and"), only to regular objects, or properties, things defined in terms of "or" ("'+g+'").',l):g in e.objectMasks||logError('Object "'+g+'" not found.',l);for(var p=e.objectMasks[g],f=0,d=0;d<u.length;d++){u[d]=u[d].trim();var v=u[d];if(-1===soundDirectionIndicators.indexOf(v))logError('Was expecting a direction, instead found "'+v+'".',l);else{var m=soundDirectionIndicatorMasks[v];f|=m}}for(var b=[g],y=!0;y;){y=!1;for(var w=0;w<b.length;w++){var E=b[w];if(E in e.synonymsDict)b[w]=e.synonymsDict[E],y=!0;else if(E in e.propertiesDict){y=!0;var R=e.propertiesDict[E];b.splice(w,1),w--;for(var k=0;k<R.length;k++)b.push(R[k])}}}if("move"===h||"cantmove"===h)for(var d=0;d<b.length;d++){var _=b[d],I=e.objects[_],D=I.layer,x=new BitVec(STRIDE_MOV);x.ishiftor(f,5*D);var M={objectMask:p,directionMask:x,seed:c};"move"===h?n.push(M):a.push(M)}validSeed(c)||logError('Expecting sfx data, instead found "'+c+'".',l);switch(h){case"create":var M={objectMask:p,seed:c};t.push(M);break;case"destroy":var M={objectMask:p,seed:c};o.push(M)}}else logError("incorrect sound declaration.",l)}}e.sfx_Events=r,e.sfx_CreationMasks=t,e.sfx_DestructionMasks=o,e.sfx_MovementMasks=n,e.sfx_MovementFailureMasks=a}function formatHomePage(e){if("background_color"in e.metadata?e.bgcolor=colorToHex(colorPalette,e.metadata.background_color):e.bgcolor="#000000","text_color"in e.metadata?e.fgcolor=colorToHex(colorPalette,e.metadata.text_color):e.fgcolor="#FFFFFF",!1===isColor(e.fgcolor)&&logError("text_color in incorrect format - found "+e.fgcolor+", but I expect a color name (like 'pink') or hex-formatted color (like '#1412FA')."),!1===isColor(e.bgcolor)&&logError("background_color in incorrect format - found "+e.bgcolor+", but I expect a color name (like 'pink') or hex-formatted color (like '#1412FA')."),canSetHTMLColors&&("background_color"in e.metadata&&(document.body.style.backgroundColor=e.bgcolor),"text_color"in e.metadata)){var r=document.getElementById("separator");null!=r&&(r.style.color=e.fgcolor);for(var t=document.getElementsByTagName("a"),o=0;o<t.length;o++)t[o].style.color=e.fgcolor;for(var t=document.getElementsByTagName("h1"),o=0;o<t.length;o++)t[o].style.color=e.fgcolor}if("homepage"in e.metadata){var n=e.metadata.homepage;n=n.replace("http://",""),n=n.replace("https://",""),e.metadata.homepage=n}}function loadFile(e){for(var r=new codeMirrorFn,t=r.startState(),o=e.split("\n"),n=0;n<o.length;n++){var a=o[n];t.lineNumber=n+1;var i=new CodeMirror.StringStream(a,4);do{if(r.token(i,t),errorCount>MAX_ERRORS)return void consolePrint("too many errors, aborting compilation")}while(!1===i.eol())}return delete t.lineNumber,generateExtraMembers(t),generateMasks(t),levelsToArray(t),extractSections(t),rulesToArray(t),removeDuplicateRules(t),debugMode&&printRules(t),rulesToMask(t),arrangeRulesByGroupNumber(t),collapseRules(t.rules),collapseRules(t.lateRules),checkNoLateRulesHaveMoves(t),generateRigidGroupList(t),processWinConditions(t),checkObjectsAreLayered(t),twiddleMetaData(t),generateExtraMembersPart2(t),generateLoopPoints(t),generateSoundData(t),formatHomePage(t),delete t.commentLevel,delete t.names,delete t.abbrevNames,delete t.objects_candname,delete t.objects_section,delete t.objects_spritematrix,delete t.section,delete t.subsection,delete t.tokenIndex,delete t.visitedSections,delete t.loops,t}function compile(e,r,t){if(matchCache={},forceRegenImages=!0,void 0===e&&(e=["restart"]),void 0===t&&(t=null),lastDownTarget=canvas,void 0===r){r=window.form1.code.editorreference.getValue()+"\n"}!0===canDump&&(compiledText=r),errorCount=0,compiling=!0,errorStrings=[],consolePrint("=================================");try{var o=loadFile(r)}finally{compiling=!1}if(o&&o.levels&&0===o.levels.length&&logError("No levels found.  Add some levels!",void 0,!0),!(errorCount>MAX_ERRORS)){if(errorCount>0)consoleError('<span class="systemMessage">Errors detected during compilation, the game may not work correctly.</span>');else{for(var n=0,a=0;a<o.rules.length;a++)n+=o.rules[a].length;for(var a=0;a<o.lateRules.length;a++)n+=o.lateRules[a].length;"restart"==e[0]?consolePrint('<span class="systemMessage">Successful Compilation, generated '+n+" instructions.</span>"):consolePrint('<span class="systemMessage">Successful live recompilation, generated '+n+" instructions.</span>")}setGameState(o,e,t),clearInputHistory(),consoleCacheDump()}}function qualifyURL(e){var r=document.createElement("a");return r.href=e,r.href}var debugMode,colorPalette;Level.prototype.calcBackgroundMask=function(e){void 0===e.backgroundlayer&&logError("you have to have a background layer");for(var r=e.layerMasks[e.backgroundlayer],t=0;t<this.n_tiles;t++){var o=this.getCell(t);if(o.iand(r),!o.iszero())return o}return o=new BitVec(STRIDE_OBJ),o.ibitset(e.backgroundid),o};var directionaggregates={horizontal:["left","right"],vertical:["up","down"],moving:["up","down","left","right","action"],orthogonal:["up","down","left","right"],perpendicular:["^","v"],parallel:["<",">"]},relativeDirections=["^","v","<",">","horizontal","vertical"],simpleAbsoluteDirections=["up","down","left","right"],simpleRelativeDirections=["^","v","<",">"],reg_directions_only=/^(\>|\<|\^|v|up|down|left|right|moving|stationary|no|randomdir|random|horizontal|vertical|orthogonal|perpendicular|parallel|action)$/i,commandwords=["sfx0","sfx1","sfx2","sfx3","sfx4","sfx5","sfx6","sfx7","sfx8","sfx9","sfx10","cancel","checkpoint","restart","win","message","again","undo","nosave","quit"],relativeDirs=["^","v","<",">","parallel","perpendicular"],relativeDict={right:["up","down","left","right","horizontal","vertical"],up:["left","right","down","up","vertical","horizontal"],down:["right","left","up","down","vertical","horizontal"],left:["down","up","right","left","horizontal","vertical"]},dirMasks={up:parseInt("00001",2),down:parseInt("00010",2),left:parseInt("00100",2),right:parseInt("01000",2),moving:parseInt("01111",2),no:parseInt("00011",2),randomdir:parseInt("00101",2),random:parseInt("10010",2),action:parseInt("10000",2),"":parseInt("00000",2)},soundEvents=["titlescreen","startgame","cancel","endgame","startlevel","undo","restart","endlevel","showmessage","closemessage","sfx0","sfx1","sfx2","sfx3","sfx4","sfx5","sfx6","sfx7","sfx8","sfx9","sfx10"],soundMaskedEvents=["create","destroy","move","cantmove","action"],soundVerbs=soundEvents.concat(soundMaskedEvents),soundDirectionIndicatorMasks={up:parseInt("00001",2),down:parseInt("00010",2),left:parseInt("00100",2),right:parseInt("01000",2),horizontal:parseInt("01100",2),vertical:parseInt("00011",2),orthogonal:parseInt("01111",2),___action____:parseInt("10000",2)},soundDirectionIndicators=["up","down","left","right","horizontal","vertical","orthogonal","___action____"],MAX_ERRORS=5,ifrm;</script> <script>function selectText(e,t){t=t||window.event;var l=document.getElementById(e);if(t&&(t.ctrlKey||t.metaKey)){if(solving)return;var o=["console"].concat(l.innerHTML.split("<br>")),n=levelFromString(state,o);loadLevelFromLevelDat(state,n,null),canvasResize()}else if(document.selection){var i=document.body.createTextRange();i.moveToElementText(l),i.select()}else if(window.getSelection){var i=document.createRange();i.selectNode(l),window.getSelection().addRange(i)}}function recalcLevelBounds(){}function arrCopy(e,t,l,o,n){for(;n--;)l[o++]=e[t]++}function adjustLevel(e,t,l){backups.push(backupLevel());var o=e.clone();e.width+=t,e.height+=l,e.n_tiles=e.width*e.height,e.objects=new Int32Array(e.n_tiles*STRIDE_OBJ);var n=new BitVec(STRIDE_OBJ);n.ibitset(state.backgroundid);for(var i=0;i<e.n_tiles;++i)e.setCell(i,n);return e.movements=new Int32Array(e.objects.length),columnAdded=!0,RebuildLevelArrays(),o}function addLeftColumn(){for(var e=adjustLevel(level,1,0),t=1;t<level.width;++t)for(var l=0;l<level.height;++l){var o=t*level.height+l;level.setCell(o,e.getCell(o-level.height))}}function addRightColumn(){for(var e=adjustLevel(level,1,0),t=0;t<level.width-1;++t)for(var l=0;l<level.height;++l){var o=t*level.height+l;level.setCell(o,e.getCell(o))}}function addTopRow(){for(var e=adjustLevel(level,0,1),t=0;t<level.width;++t)for(var l=1;l<level.height;++l){var o=t*level.height+l;level.setCell(o,e.getCell(o-t-1))}}function addBottomRow(){for(var e=adjustLevel(level,0,1),t=0;t<level.width;++t)for(var l=0;l<level.height-1;++l){var o=t*level.height+l;level.setCell(o,e.getCell(o-t))}}function removeLeftColumn(){if(!(level.width<=1))for(var e=adjustLevel(level,-1,0),t=0;t<level.width;++t)for(var l=0;l<level.height;++l){var o=t*level.height+l;level.setCell(o,e.getCell(o+level.height))}}function removeRightColumn(){if(!(level.width<=1))for(var e=adjustLevel(level,-1,0),t=0;t<level.width;++t)for(var l=0;l<level.height;++l){var o=t*level.height+l;level.setCell(o,e.getCell(o))}}function removeTopRow(){if(!(level.height<=1))for(var e=adjustLevel(level,0,-1),t=0;t<level.width;++t)for(var l=0;l<level.height;++l){var o=t*level.height+l;level.setCell(o,e.getCell(o+t+1))}}function removeBottomRow(){if(!(level.height<=1))for(var e=adjustLevel(level,0,-1),t=0;t<level.width;++t)for(var l=0;l<level.height;++l){var o=t*level.height+l;level.setCell(o,e.getCell(o+t))}}function matchGlyph(e,t){for(var l,o=-1,n=0;n<t.length;++n){var i=t[n][0],r=t[n][1],a=t[n][2];if(r.bitsSetInArray(e.data)){for(var s=0,c=0;c<32*STRIDE_OBJ;++c)a.get(c)&&e.get(c)&&s++,r.get(c)&&e.get(c)&&s++;s>o&&(o=s,l=i)}}return o>0?l:(logErrorNoLine("Wasn't able to approximate a glyph value for some tiles, using '.' as a placeholder.",!0),".")}function printLevel(){var e=[];for(var t in state.glyphDict)if(state.glyphDict.hasOwnProperty(t)&&1===t.length){for(var l=state.glyphDict[t],o=new BitVec(STRIDE_OBJ),n=0;n<l.length;n++){var i=l[n];i>=0&&o.ibitset(i)}var r=o.clone(),a=state.layerMasks[state.backgroundlayer];o.iclear(a),e.push([t,o,r])}selectableint++;var s="selectable"+selectableint,c='Printing level contents:<br><br><span id="'+s+'" onclick="selectText(\''+s+"',event)\"><br>";cache_console_messages=!1;for(var d=0;d<level.height;d++){for(var n=0;n<level.width;n++){var u=d+n*level.height,v=level.getCell(u),l=matchGlyph(v,e);l in htmlEntityMap&&(l=htmlEntityMap[l]),c+=l}d<level.height-1&&(c+="<br>")}c+="</span><br><br>",consolePrint(c,!0)}function levelEditorClick(e,t){if(mouseCoordY<=-2){var l=editorRowCount-(-mouseCoordY-2)-1,o=mouseCoordX+(screenwidth-1)*l;-1===mouseCoordX?printLevel():mouseCoordX>=0&&o<glyphImages.length&&(glyphSelectedIndex=o,redraw())}else if(mouseCoordX>-1&&mouseCoordY>-1&&mouseCoordX<screenwidth-2&&mouseCoordY<screenheight-2-editorRowCount){for(var n=glyphImagesCorrespondance[glyphSelectedIndex],i=state.glyphDict[n],r=new BitVec(STRIDE_OBJ),a=0;a<i.length;a++){var s=i[a];s>=0&&r.ibitset(s)}var c=state.layerMasks[state.backgroundlayer];r.bitsClearInArray(c.data)&&r.ibitset(state.backgroundid);var d=mouseCoordY+mouseCoordX*level.height,u=level.getCell(d);if(u.equals(r))return;!1===anyEditsSinceMouseDown&&(anyEditsSinceMouseDown=!0,backups.push(backupLevel())),level.setCell(d,r),redraw()}else t&&(-1===mouseCoordX?(addLeftColumn(),canvasResize()):mouseCoordX===screenwidth-2&&(addRightColumn(),canvasResize()),-1===mouseCoordY?(addTopRow(),canvasResize()):mouseCoordY===screenheight-2-editorRowCount&&(addBottomRow(),canvasResize()))}function levelEditorRightClick(e,t){if(-2===mouseCoordY)mouseCoordX<=glyphImages.length&&(glyphSelectedIndex=mouseCoordX,redraw());else if(mouseCoordX>-1&&mouseCoordY>-1&&mouseCoordX<screenwidth-2&&mouseCoordY<screenheight-2-editorRowCount){var l=mouseCoordY+mouseCoordX*level.height,o=new BitVec(STRIDE_OBJ);o.ibitset(state.backgroundid),level.setCell(l,o),redraw()}else t&&(-1===mouseCoordX?(removeLeftColumn(),canvasResize()):mouseCoordX===screenwidth-2&&(removeRightColumn(),canvasResize()),-1===mouseCoordY?(removeTopRow(),canvasResize()):mouseCoordY===screenheight-2-editorRowCount&&(removeBottomRow(),canvasResize()))}function getTilesTraversingPoints(e,t,l,o){if(cellwidth!==cellheight)throw"Error: Cell is not square.";for(var n=l-e,i=o-t,r=t*n,a=e*i-r,s=cellwidth*(Math.abs(n)+Math.abs(i)),c=2*a-s,d=2*a+s,u=Math.floor(e/cellwidth),v=Math.floor(t/cellheight),g=Math.floor(l/cellwidth),m=Math.floor(o/cellheight),h=cellwidth-1,f=g-u>=0?1:-1,p=m-v>=0?1:-1,y=v,C=[],S=[],w=u;w!=g+f;w+=f)for(var k=!1,b=y;b!=m+p;b+=p){if(b>=level.height||b<0||w>=level.width||w<0)throw error="Mouse input loop failed; it:"+w+" "+b+" cell1:"+u+" "+v+" cell2:"+g+" "+m,console.log(error),error;if(function(e,t){return fOfPointTimesTwo=i*e-n*t,c<fOfPointTimesTwo==fOfPointTimesTwo<=d}(2*w*cellwidth+h,2*b*cellwidth+h))C.push(w),S.push(b),k=!0,y=b;else if(k)break}for(var M=("mouse_obstacle"in state.metadata),x=[u],T=[v];u!==g||v!==m;){if(v>=level.height||v<0||u>=level.width||u<0)throw error="Mouse input loop failed; cell1:"+u+" "+v+" cell2:"+g+" "+m,console.log(error),error;if(hitObstacle=function(){var e=screenOffsetY+v+(screenOffsetX+u)*level.height,t=level.getCell(e);return!!state.obstacleMask.anyBitsInCommon(t)},cellCornerXTimesTwo=2*u*cellwidth+h+f*cellwidth,cellCornerYTimesTwo=2*v*cellwidth+h+p*cellwidth,fOfPointTimesTwo=i*cellCornerXTimesTwo-n*cellCornerYTimesTwo,fOfPointTimesTwo>2*a==p>0!=f>0?(u+=f,M&&hitObstacle()&&(u-=f,v+=p)):(v+=p,M&&hitObstacle()&&(v-=p,u+=f)),M&&hitObstacle())break;x.push(u),T.push(v)}if(M)C=x,S=T;else for(var w=0;w<C.length;w++)if(C[w]!==x[w]||S[w]!==T[w]){try{displayError("line tile placement algorithm discrepancies detected")}catch(e){}throw consolePrint("line tile placement algorithm discrepancies detected",!0),"line tile placement algorithm discrepancies detected"}return{tileListX:C,tileListY:S}}function mouseAction(e,t,l){if(textMode){if(!t)return;if(titleScreen&&!quittingTitleScreen){if(0===titleMode)titleButtonSelected();else if(1===titleMode)5===mouseCoordY&&titleSelectOptions>=1?(titleSelection=0,titleButtonSelected()):6===mouseCoordY&&titleSelectOptions>=3?(titleSelection=1,titleButtonSelected()):7===mouseCoordY&&titleSelectOptions>=2?(2===titleSelectOptions?titleSelection=1:titleSelection=2,titleButtonSelected()):8===mouseCoordY&&titleSelectOptions>=4&&(titleSelection=3,titleButtonSelected());else if(2===titleMode)if(0===mouseCoordY)titleSelection=0,goToTitleScreen(),tryPlayTitleSound(),canvasResize();else if(2===mouseCoordY){var o=-3;0!=levelSelectScrollPos&&(levelSelectScrollPos=clamp(levelSelectScrollPos+o,0,state.sections.length-amountOfLevelsOnScreen),titleSelection=clamp(titleSelection+o,0,state.sections.length-1),generateLevelSelectScreen(),redraw())}else if(12===mouseCoordY){var o=3;titleSelectOptions-amountOfLevelsOnScreen>levelSelectScrollPos&&(levelSelectScrollPos=clamp(levelSelectScrollPos+o,0,state.sections.length-amountOfLevelsOnScreen),titleSelection=clamp(titleSelection+o,0,state.sections.length-1),generateLevelSelectScreen(),redraw())}else{var n=-1;switch(mouseCoordY){case 3:n=0;break;case 4:n=1;break;case 5:n=2;break;case 6:n=3;break;case 7:n=4;break;case 8:n=5;break;case 9:n=6;break;case 10:n=7;break;case 11:n=8}-1!=n&&(n+=levelSelectScrollPos)<titleSelectOptions&&(titleSelection=n,titleSelected=!0,messageselected=!1,timer=0,quittingTitleScreen=!0,generateLevelSelectScreen(),redraw())}}else!1===messageselected&&(messageselected=!0,timer=0,quittingMessageScreen=!0,tryPlayCloseMessageSound(),titleScreen=!1,drawMessageScreen())}else if(x1=x2,y1=y2,x2=mousePixelX,y2=mousePixelY,x2=Math.max(0,Math.min(cellwidth*screenwidth-1,mousePixelX)),y2=Math.max(0,Math.min(cellheight*screenheight-1,mousePixelY)),t){if(mouseCoordX>=0&&mouseCoordY>=0&&mouseCoordX<screenwidth&&mouseCoordY<screenheight){var i=screenOffsetY+mouseCoordY+(screenOffsetX+mouseCoordX)*level.height;if(lastCoord=i,againing);else try{var r=backupLevel(),a=level.getCell(i);a.ibitset(l),level.setCell(i,a);var s=5;pushInput(s),processInput(s,!1,!1,r)&&redraw()}catch(e){console.log(e),consolePrint(e,!0)}}}else for(var c=getTilesTraversingPoints(x1,y1,x2,y2),d=c.tileListX,u=c.tileListY,v=0;v<d.length;v++){var i=screenOffsetY+u[v]+(screenOffsetX+d[v])*level.height;if(lastCoord!==i)if(lastCoord=i,againing);else try{var r=backupLevel(),a=level.getCell(i);a.ibitset(l),level.setCell(i,a);var s=5;pushInput(s),processInput(s,!1,!1,r)&&redraw()}catch(e){console.log(e),consolePrint(e,!0)}}}function onMouseDown(e){if(0!==e.button||e.ctrlKey||e.metaKey)if(2===e.button||0===e.button&&(e.ctrlKey||e.metaKey))if("gameCanvas"===e.target.id){if(setMouseCoord(e),dragging=!1,rightdragging=!0,levelEditorOpened)return levelEditorRightClick(e,!0);if("mouse_right"in state.metadata)return mouseAction(e,!0,state.rmbID)}else dragging=!1,rightdragging=!1;else 1===e.button&&!1===textMode&&levelEditorOpened&&(pushInput("undo"),DoUndo(!1,!0),canvasResize());else{if(lastDownTarget=e.target,keybuffer=[],e.target===canvas){if(setMouseCoord(e),dragging=!0,rightdragging=!1,anyEditsSinceMouseDown=!1,levelEditorOpened)return levelEditorClick(e,!0);if("mouse_left"in state.metadata)return mouseAction(e,!0,state.lmbID)}dragging=!1,rightdragging=!1}}function rightClickCanvas(e){return"mouse_right"in state.metadata?prevent(e):levelEditorOpened?prevent(e):void 0}function onMouseUp(e){if(dragging=!1,rightdragging=!1,0===e.button){if(e.target===canvas&&(setMouseCoord(e),"mouse_up"in state.metadata))return mouseAction(e,!0,state.lmbupID)}else if(2===e.button&&"gameCanvas"===e.target.id&&(setMouseCoord(e),"mouse_rup"in state.metadata))return mouseAction(e,!0,state.rmbupID)}function onKeyDown(e){e=e||window.event,!IDE&&[32,37,38,39,40].indexOf(e.keyCode)>-1&&prevent(e),IDE||77!==e.keyCode||toggleMute(),keybuffer.indexOf(e.keyCode)>=0||((lastDownTarget===canvas||window.Mobile&&lastDownTarget===window.Mobile.focusIndicator)&&-1===keybuffer.indexOf(e.keyCode)&&(keybuffer.splice(keyRepeatIndex,0,e.keyCode),keyRepeatTimer=0,checkKey(e,!0)),!0===canDump&&(74===e.keyCode&&(e.ctrlKey||e.metaKey)?(dumpTestCase(),prevent(e)):75===e.keyCode&&(e.ctrlKey||e.metaKey)?(makeGIF(),prevent(e)):83===e.keyCode&&(e.ctrlKey||e.metaKey)?(saveClick(),prevent(e)):66===e.keyCode&&(e.ctrlKey||e.metaKey)?(rebuildClick(),prevent(e),e.target.blur(),canvas.focus()):82===e.keyCode&&(e.ctrlKey||e.metaKey)?(runClick(),prevent(e),e.target.blur(),canvas.focus()):120===e.keyCode?(prevent(e),solve()):119===e.keyCode&&(prevent(e),stopSolving())))}function relMouseCoords(e){var t=0,l=0,o=0,n=0,i=this;do{t+=i.offsetLeft-i.scrollLeft,l+=i.offsetTop-i.scrollTop}while(i=i.offsetParent);return o=e.pageX-t,n=e.pageY-l,{x:o,y:n}}function onKeyUp(e){e=e||window.event;var t=keybuffer.indexOf(e.keyCode);t>=0&&(keybuffer.splice(t,1),keyRepeatIndex>=t&&keyRepeatIndex--)}function onMyFocus(e){keybuffer=[],keyRepeatIndex=0,keyRepeatTimer=0}function onMyBlur(e){keybuffer=[],keyRepeatIndex=0,keyRepeatTimer=0}function setMouseCoord(e){var t=canvas.relMouseCoords(e);mousePixelX=t.x-xoffset,mousePixelY=t.y-yoffset,mouseCoordX=Math.floor(mousePixelX/cellwidth),mouseCoordY=Math.floor(mousePixelY/cellheight)}function onMouseMove(e){levelEditorOpened?(setMouseCoord(e),dragging?levelEditorClick(e,!1):rightdragging&&levelEditorRightClick(e,!1),redraw()):dragging&&"mouse_drag"in state.metadata?(setMouseCoord(e),mouseAction(e,!1,state.dragID),redraw()):rightdragging&&"mouse_rdrag"in state.metadata&&(setMouseCoord(e),mouseAction(e,!1,state.rdragID),redraw())}function onMouseIn(){mouseInCanvas=!0}function onMouseOut(){mouseInCanvas=!1}function onMouseWheel(e){mouseInCanvas&&!e.ctrlKey&&(normalizedDelta=Math.sign(e.deltaY),titleScreen&&2==titleMode&&(state.metadata.mouse_left||state.metadata.mouse_drag)&&(levelSelectScrollPos=clamp(levelSelectScrollPos+normalizedDelta,0,state.sections.length-amountOfLevelsOnScreen),titleSelection=clamp(titleSelection+normalizedDelta,0,state.sections.length-1),generateLevelSelectScreen(),redraw(),prevent(e)),levelEditorOpened&&(glyphSelectedIndex=clamp(glyphSelectedIndex+normalizedDelta,0,glyphCount()-1),redraw(),prevent(e)))}function clamp(e,t,l){return Math.min(Math.max(e,t),l)}function prevent(e){return e.preventDefault&&e.preventDefault(),e.stopImmediatePropagation&&e.stopImmediatePropagation(),e.stopPropagation&&e.stopPropagation(),e.returnValue=!1,!1}function titleButtonSelected(){!1===titleSelected&&(tryPlayStartGameSound(),titleSelected=!0,messageselected=!1,timer=0,quittingTitleScreen=!0,generateTitleScreen(),canvasResize())}function pollGamepads(){function e(e,t){return!(e.length<t)&&("object"==typeof e[t]?e[t].pressed:1==e[t])}function t(e,t,l){return!(e.length<t)&&e[t]*l>.5}function l(e){-1===keybuffer.indexOf(e)&&(keybuffer.splice(keyRepeatIndex,0,e),keyRepeatTimer=0,checkKey({keyCode:e},!0)),n.splice(0,0,e)}function o(){for(var e=0;e<gamepadKeys.length;e++)if(!(n.indexOf(gamepadKeys[e])>=0)){var t=keybuffer.indexOf(gamepadKeys[e]);t>=0&&(keybuffer.splice(t,1),keyRepeatIndex>=t&&keyRepeatIndex--)}gamepadKeys=n}var n=[],i=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads():[];if(null==i||0==i.length)return void o();for(var r=0;r<i.length;r++){var a=i[r];null!=a&&a.connected&&((e(a.buttons,3)||e(a.buttons,4))&&l(82),(e(a.buttons,1)||t(a.axes,2,1))&&l(90),(e(a.buttons,2)||e(a.buttons,0)||e(a.buttons,5)||t(a.axes,1,1))&&l(88),e(a.buttons,7)&&l(27),e(a.buttons,6)&&l(69),(t(a.axes,0,1)||t(a.axes,6,1))&&l(39),(t(a.axes,0,-1)||t(a.axes,6,-1))&&l(37),(t(a.axes,1,-1)||t(a.axes,7,-1))&&l(38),(t(a.axes,1,1)||t(a.axes,7,1))&&l(40))}o()}function checkKey(e,t){if(!winning){var l=-1;switch(e.keyCode){case 65:case 37:l=1;break;case 38:case 87:l=0;break;case 68:case 39:l=3;break;case 83:case 40:l=2;break;case 80:printLevel();break;case 13:case 32:case 67:case 88:if(!1!==norepeat_action&&!t)return;l=4;break;case 85:case 90:if(!1===textMode)return pushInput("undo"),DoUndo(!1,!0),canvasResize(),prevent(e);break;case 82:if(!1===textMode&&t)return pushInput("restart"),DoRestart(),canvasResize(),prevent(e);break;case 27:if(solving){stopSolving();break}if(!1===titleScreen||titleMode>1)return(timer/1e3>.5||titleMode>1)&&(titleSelection=0,timer=0,!1===titleScreen&&void 0!==state.metadata.level_select?gotoLevelSelectScreen():goToTitleScreen(),tryPlayTitleSound(),canvasResize()),prevent(e);break;case 69:if(!solving&&canOpenEditor)return t&&(titleScreen&&("EMPTY GAME"===state.title?compile(["loadFirstNonMessageLevel"]):nextLevel()),levelEditorOpened=!levelEditorOpened,!1===levelEditorOpened&&printLevel(),restartTarget=backupLevel(),canvasResize()),prevent(e);break;case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:if(levelEditorOpened&&t){var o=9;return e.keyCode>=49&&(o=e.keyCode-49),o<glyphImages.length?glyphSelectedIndex=o:consolePrint("Trying to select tile outside of range in level editor.",!0),canvasResize(),prevent(e)}}if(throttle_movement&&l>=0&&l<=3){if(lastinput==l&&input_throttle_timer<repeatinterval)return;lastinput=l,input_throttle_timer=0}if(textMode){if(!throttle_movement){if(lastinput==l&&input_throttle_timer<repeatinterval)return;lastinput=l,input_throttle_timer=0}if(0===state.levels.length);else if(titleScreen)0===titleMode?4===l&&t&&titleButtonSelected():4==l&&t?!1===titleSelected&&(tryPlayStartGameSound(),titleSelected=!0,messageselected=!1,timer=0,quittingTitleScreen=!0,1==titleMode?generateTitleScreen():2==titleMode&&generateLevelSelectScreen(),redraw()):0!==l&&2!==l||(0===l?titleSelection--:titleSelection++,titleSelection>=titleSelectOptions?titleSelection-=titleSelectOptions:titleSelection<0&&(titleSelection+=titleSelectOptions),1==titleMode?generateTitleScreen():2==titleMode&&generateLevelSelectScreen(),redraw());else if(4==l&&t){if(unitTesting)return void nextLevel();!1===messageselected&&(messageselected=!0,timer=0,quittingMessageScreen=!0,tryPlayCloseMessageSound(),titleScreen=!1,drawMessageScreen())}}else if(!againing&&l>=0)return 4===l&&"noaction"in state.metadata||(pushInput(l),processInput(l)&&redraw()),prevent(e)}}function update(){var e=!1;if(timer+=deltatime,input_throttle_timer+=deltatime,quittingTitleScreen&&timer/1e3>.3&&(quittingTitleScreen=!1,titleMode<=1?nextLevel():2==titleMode&&gotoSelectedLevel()),againing&&timer>againinterval&&0==messagetext.length&&processInput(-1)&&(e=!0,keyRepeatTimer=0,autotick=0),quittingMessageScreen&&timer/1e3>.15&&(quittingMessageScreen=!1,""===messagetext?nextLevel():(messagetext="",textMode=!1,titleScreen=!1,titleMode=curlevel>0||null!==curlevelTarget?1:0,titleSelected=!1,titleSelection=0,canvasResize(),checkWin())),winning&&timer/1e3>.5&&(winning=!1,nextLevel()),pollGamepads(),keybuffer.length>0){keyRepeatTimer+=deltatime;var t=throttle_movement?repeatinterval:repeatinterval/Math.sqrt(keybuffer.length);if(keyRepeatTimer>t){keyRepeatTimer=0,keyRepeatIndex=(keyRepeatIndex+1)%keybuffer.length;checkKey({keyCode:keybuffer[keyRepeatIndex]},!1)}}!(autotickinterval>0)||textMode||levelEditorOpened||againing||winning||(autotick+=deltatime,autotick>autotickinterval&&(autotick=0,pushInput("tick"),processInput(-1)&&(e=!0))),(e||void 0!==state&&void 0!==state.metadata.smoothscreen)&&redraw()}var keyRepeatTimer=0,keyRepeatIndex=0,input_throttle_timer=0,lastinput=-100,dragging=!1,rightdragging=!1,columnAdded=!1,htmlEntityMap={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"},selectableint=0,lastCoord,x1=5,y1=5,x2=5,y2=5,anyEditsSinceMouseDown=!1;HTMLCanvasElement.prototype.relMouseCoords=relMouseCoords;var mouseCoordX=0,mouseCoordY=0,mousePixelX=0,mousePixelY=0;mouseInCanvas=!1,document.addEventListener("mousedown",onMouseDown,!1),document.addEventListener("mouseup",onMouseUp,!1),document.addEventListener("mousemove",onMouseMove,!1),document.addEventListener("contextmenu",rightClickCanvas,!1),document.addEventListener("keydown",onKeyDown,!1),document.addEventListener("keyup",onKeyUp,!1),document.addEventListener("wheel",onMouseWheel,!1),window.addEventListener("focus",onMyFocus,!1),window.addEventListener("blur",onMyBlur,!1),canvas.addEventListener("mouseenter",onMouseIn,!1),canvas.addEventListener("mouseleave",onMouseOut,!1);var gamepadKeys=[];setInterval(function(){update()},deltatime);</script> <script>function Animatable(t,i,e){function n(){var t;return o+=i,o>=1&&(t=!0,o=1),e(o),t}function s(){var t;return o-=i,o<=0&&(t=!0,o=0),e(o),t}var o,a;return a={animateUp:function(){Animator.getInstance().animate(t,n)},animateDown:function(){Animator.getInstance().animate(t,s)}},o=0,a}window.Mobile={},Mobile.hasTouch=function(){var t;return("ontouchstart"in window||window.DocumentTouch&&document instanceof DocumentTouch)&&(t=!0),t},Mobile.enable=function(t){return(t||Mobile.hasTouch()&&!Mobile._instance)&&(Mobile._instance=new Mobile.GestureHandler,Mobile._instance.bindEvents(),Mobile._instance.bootstrap()),Mobile._instance},window.Mobile.GestureHandler=function(){this.initialize.apply(this,arguments)},Mobile.log=function(t){var i;i=document.getElementsByTagName("h1")[0],i.innerHTML=Math.random().toString().substring(4,1)+"-"+t},Mobile.debugDot=function(t){var i,e,n;n="border-radius: 50px;width: 5px;height: 5px;background: red;position: absolute;left: "+t.touches[0].clientX+"px;top: "+t.touches[0].clientY+"px;",i=document.createElement("div"),i.setAttribute("style",n),e=document.getElementsByTagName("body")[0],e.appendChild(i)},function(t){"use strict";var i={action:88,left:37,right:39,up:38,down:40,undo:85,restart:82,quit:27},e=['<div class="tab">','  <div class="tab-affordance"></div>','  <div class="tab-icon">','    <div class="slice"></div>','    <div class="slice"></div>',"  </div>","</div>"].join("\n");t.initialize=function(){this.firstPos={x:0,y:0},this.setTabAnimationRatio=this.setTabAnimationRatio.bind(this),this.setMenuAnimationRatio=this.setMenuAnimationRatio.bind(this),this.repeatTick=this.repeatTick.bind(this),this.isFocused=!0},t.setFocusElement=function(t){this.focusElement=t,this.isFocused=!1,this.buildFocusIndicator()},t.bindEvents=function(){window.addEventListener("touchstart",this.onTouchStart.bind(this)),window.addEventListener("touchend",this.onTouchEnd.bind(this)),window.addEventListener("touchmove",this.onTouchMove.bind(this))},t.bootstrap=function(){this.showTab(),this.disableScrolling(),this.isAudioSupported()||this.disableAudio(),this.disableSelection()},t.onTouchStart=function(t){this.isTouching||(this.handleFocusChange(t),this.isFocused&&"A"!==t.target.tagName.toUpperCase()&&(this.isTouching=!0,this.mayBeSwiping=!0,this.gestured=!1,this.swipeDirection=void 0,this.swipeDistance=0,this.startTime=(new Date).getTime(),this.firstPos.x=t.touches[0].clientX,this.firstPos.y=t.touches[0].clientY))},t.onTouchEnd=function(t){this.isFocused&&this.isTouching&&(this.gestured||0===t.touches.length&&this.handleTap(),0===t.touches.length&&(this.isTouching=!1,this.endRepeatWatcher()))},t.onTouchMove=function(t){if(this.isFocused)return this.isSuccessfulSwipe()?(this.handleSwipe(this.swipeDirection,this.touchCount),this.gestured=!0,this.mayBeSwiping=!1,this.beginRepeatWatcher(t)):this.mayBeSwiping?this.swipeStep(t):this.isRepeating&&this.repeatStep(t),prevent(t),!1},t.handleFocusChange=function(t){this.focusElement&&(this.isFocused=this.isTouchInsideFocusElement(t),this.setFocusIndicatorVisibility(this.isFocused))},t.isTouchInsideFocusElement=function(t){var i;return!(!t.touches||!t.touches[0])&&(i=this.absoluteElementPosition(this.focusElement),!(t.touches[0].clientX<i.left||t.touches[0].clientY<i.top)&&!(t.touches[0].clientX>i.left+this.focusElement.clientWidth||t.touches[0].clientY>i.top+this.focusElement.clientHeight))},t.setFocusIndicatorVisibility=function(t){var i;i="visible",t||(i="hidden"),this.focusIndicator.setAttribute("style","visibility: "+i+";")},t.absoluteElementPosition=function(t){var i,e;for(i={top:t.offsetTop||0,left:t.offsetLeft||0},e=document.getElementsByTagName("body")[0],i.top-=e.scrollTop||0;;){if(!(t=t.offsetParent))break;i.top+=t.offsetTop||0,i.left+=t.offsetLeft||0}return i},t.beginRepeatWatcher=function(t){var i;this.repeatInterval||(this.isRepeating=!0,i=1e3*state.metadata.key_repeat_interval,!isNaN(i)&&i||(i=150),this.repeatInterval=setInterval(this.repeatTick,i),this.recenter(t))},t.endRepeatWatcher=function(){this.repeatInterval&&(clearInterval(this.repeatInterval),delete this.repeatInterval,this.isRepeating=!1)},t.repeatTick=function(){this.isTouching&&this.handleSwipe(this.direction,this.touchCount)},t.recenter=function(t){this.firstPos.x=t.touches[0].clientX,this.firstPos.y=t.touches[0].clientY},t.isSuccessfulSwipe=function(){var t;return this.mayBeSwiping&&void 0!==this.swipeDirection&&this.swipeDistance>=50&&(t=!0),t},t.swipeStep=function(t){var i,e,n;this.mayBeSwiping&&(i={x:t.touches[0].clientX,y:t.touches[0].clientY},e=(new Date).getTime(),n=t.touches.length,this.swipeDistance=this.cardinalDistance(this.firstPos,i),this.swipeDirection?e-this.startTime>1e3&&(this.mayBeSwiping=!1):this.swipeDistance>10&&(this.swipeDirection=this.dominantDirection(this.firstPos,i),this.touchCount=n))},t.repeatStep=function(t){var i,e;i={x:t.touches[0].clientX,y:t.touches[0].clientY},(e=this.cardinalDistance(this.firstPos,i))>=50&&(this.swipeDirection=this.dominantDirection(this.firstPos,i),this.recenter(t))},t.cardinalDistance=function(t,i){var e,n;return e=Math.abs(t.x-i.x),n=Math.abs(t.y-i.y),Math.max(e,n)},t.dominantDirection=function(t,i){var e,n,s;return e=i.x-t.x,n=i.y-t.y,s="x",Math.abs(n)>Math.abs(e)&&(s="y"),"x"===s?e>0?"right":"left":n>0?"down":"up"},t.handleSwipe=function(t,i){1===i?this.emitKeydown(this.swipeDirection):i>1&&this.toggleMenu()},t.handleTap=function(){this.emitKeydown("action")},t.emitKeydown=function(t){if(this.isMenuVisible||"undo"!=t&&"restart"!=t&&"quit"!=t){var e;e={keyCode:i[t]},this.fakeCanvasFocus(),onKeyDown(e),onKeyUp(e)}},t.fakeCanvasFocus=function(){var t;t=document.getElementById("gameCanvas"),onMouseDown({button:0,target:t})},t.toggleMenu=function(){this.isMenuVisible?this.hideMenu():this.showMenu()},t.showMenu=function(){this.menuElem||this.buildMenu(),this.getAnimatables().menu.animateUp(),this.isMenuVisible=!0,this.hideTab()},t.hideMenu=function(){this.menuElem&&this.getAnimatables().menu.animateDown(),this.isMenuVisible=!1,this.showTab()},t.getAnimatables=function(){var t=this;return this._animatables||(this._animatables={tab:Animatable("tab",.1,t.setTabAnimationRatio),menu:Animatable("menu",.1,t.setMenuAnimationRatio)}),this._animatables},t.showTab=function(){this.tabElem||this.buildTab(),this.getAnimatables().tab.animateDown()},t.hideTab=function(){this.tabElem&&this.tabElem.setAttribute("style","display: none;"),this.getAnimatables().tab.animateUp()},t.buildTab=function(){var t,i,n,s,o=this;t=document.createElement("div"),t.innerHTML=e,s=t.children[0],n=function(t){t.stopPropagation(),o.showMenu()},this.tabAffordance=s.getElementsByClassName("tab-affordance")[0],this.tabElem=s.getElementsByClassName("tab-icon")[0],this.tabAffordance.addEventListener("touchstart",n),this.tabElem.addEventListener("touchstart",n),i=document.getElementsByTagName("body")[0],i.appendChild(s)},t.buildMenu=function(){var t,i,e,n,s,o,a,c=this;t=document.createElement("div"),t.innerHTML=this.buildMenuString(state),this.menuElem=t.children[0],this.closeElem=this.menuElem.getElementsByClassName("close")[0],a=function(t){t.stopPropagation(),c.hideMenu()},this.closeAffordance=this.menuElem.getElementsByClassName("close-affordance")[0],o=this.menuElem.getElementsByClassName("close")[0],this.closeAffordance.addEventListener("touchstart",a),o.addEventListener("touchstart",a),e=this.menuElem.getElementsByClassName("undo")[0],e&&e.addEventListener("touchstart",function(t){t.stopPropagation(),c.emitKeydown("undo")}),n=this.menuElem.getElementsByClassName("restart")[0],n&&n.addEventListener("touchstart",function(t){t.stopPropagation(),c.emitKeydown("restart")}),s=this.menuElem.getElementsByClassName("quit")[0],s.addEventListener("touchstart",function(t){t.stopPropagation(),c.emitKeydown("quit")}),i=document.getElementsByTagName("body")[0],i.appendChild(this.menuElem)},t.buildMenuString=function(t){var i,e,n,s;return n=t.metadata.noundo,s=t.metadata.norestart,i=3,n&&(i-=1),s&&(i-=1),e=['<div class="mobile-menu item-count-'+i+'">','  <div class="close-affordance"></div>','  <div class="close">','    <div class="slice"></div>','    <div class="slice"></div>',"  </div>"],n||e.push('  <div class="undo button">Undo</div>'),s||e.push('  <div class="restart button">Restart</div>'),e=e.concat(['  <div class="quit button">Quit to Menu</div>','  <div class="clear"></div>',"</div>"]),e.join("\n")},t.buildFocusIndicator=function(){var t;this.focusIndicator=document.createElement("DIV"),this.focusIndicator.setAttribute("class","tapFocusIndicator"),this.focusIndicator.setAttribute("style","visibility: hidden;"),t=this.focusElement.parentNode,t.appendChild(this.focusIndicator)},t.setTabAnimationRatio=function(t){var i,e,n;t=Math.round(1e3*t)/1e3,t>=.999?this.tabAffordance.setAttribute("style","display: none;"):this.tabAffordance.setAttribute("style","display: block;"),i=66*t+18*(1-t),e="opacity: "+(1-t)+";",n=e+" width: "+i+"px;",this.tabElem.setAttribute("style",n)},t.setMenuAnimationRatio=function(t){var i,e,n;t=Math.round(1e3*t)/1e3,i=-18*t+-66*(1-t),e="opacity: "+t+";",n="left: "+(i-4)+"px; "+e+" width: "+-i+"px;",t=Math.round(1e3*t)/1e3,t<=.001?(this.closeAffordance.setAttribute("style","display: none;"),e="display:none;"):this.closeAffordance.setAttribute("style","display: block;"),this.closeElem.setAttribute("style",n),this.menuElem.setAttribute("style",e)},t.disableScrolling=function(){var t={height:"100%",overflow:"hidden",position:"fixed",width:"100%"},i="";for(var e in t)i+=e+": "+t[e]+"; ";document.body.setAttribute("style",i)},t.disableAudio=function(){window.playSeed=function(){}},t.isAudioSupported=function(){var t=!0;return"undefined"!=typeof webkitAudioContext&&(t=!1),t},t.disableSelection=function(){var t;t=document.getElementsByTagName("body")[0],t.setAttribute("class",t.getAttribute("class")+" disable-select")}}(window.Mobile.GestureHandler.prototype),window.Animator=function(){this.initialize.apply(this,arguments)},function(t){t.initialize=function(){this._animations={},this.tick=this.tick.bind(this)},t.animate=function(t,i){this._animations[t]=i,this.wakeup()},t.wakeup=function(){this._isAnimating||(this._isAnimating=!0,this.tick())},t.tick=function(){var t,i,e,n,s;n=[],e=!0;for(t in this._animations){if(!this._animations.hasOwnProperty(t))return;i=this._animations[t](),i?n.push(t):e=!1}if(e){for(s=0;s<n.length;n++)delete this._isAnimating[n[s]];this._isAnimating=!1}else requestAnimationFrame(this.tick)}}(window.Animator.prototype),window.Animator.getInstance=function(){return window.Animator._instance||(window.Animator._instance=new window.Animator),window.Animator._instance},function(){"use strict";var t,i,e=["ms","moz","webkit","o"];for(t=0;t<e.length&&!window.requestAnimationFrame;t++)window.requestAnimationFrame=window[e[t]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[e[t]+"CancelAnimationFrame"],window.cancelAnimationFrame||(window.cancelAnimationFrame=window[e[t]+"CancelRequestAnimationFrame"]);window.requestAnimationFrame||(i=0,window.requestAnimationFrame=function(t,e){var n,s,o;return n=(new Date).getTime(),s=Math.max(0,16-(n-i)),o=window.setTimeout(function(){t(n+s)},s),i=n+s,o}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(t){clearTimeout(t)}),Mobile.enable()}();</script> <script>var sourceCode=__GAMEDAT__;compile(["restart"],sourceCode);</script> </body> </html> 
